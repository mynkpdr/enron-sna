<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Enron SNA Dashboard</title>

<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;600;800&display=swap" rel="stylesheet"/>

<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.9.0/d3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>

<style>
*, *::before, *::after { box-sizing:border-box; margin:0; padding:0; }

:root {
  --bg:       #05070d;
  --bg2:      #0b0f1a;
  --bg3:      #111827;
  --border:   #1e2a3a;
  --accent:   #00e5ff;
  --accent2:  #ff4d6d;
  --accent3:  #a855f7;
  --amber:    #fbbf24;
  --green:    #22c55e;
  --text:     #e2e8f0;
  --muted:    #64748b;
  --grid:     rgba(0,229,255,0.04);
  --font-ui:  'Syne', sans-serif;
  --font-mono:'Space Mono', monospace;
}

html, body {
  background: var(--bg); color: var(--text);
  font-family: var(--font-ui); height: 100%;
  overflow: hidden; user-select: none;
}

/* â”€â”€ LAYOUT â”€â”€ */
#app {
  display: grid;
  grid-template-rows: 54px 1fr;
  grid-template-columns: 276px 1fr 296px;
  height: 100vh; overflow: hidden;
}

/* â”€â”€ HEADER â”€â”€ */
header {
  grid-column: 1 / -1;
  background: var(--bg2); border-bottom: 1px solid var(--border);
  display: flex; align-items: center; padding: 0 22px; gap: 18px;
  position: relative; z-index: 20;
}
header::after {
  content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 1px;
  background: linear-gradient(90deg, transparent, var(--accent) 40%, var(--accent3) 60%, transparent);
  opacity: 0.5;
}
.logo { font-family: var(--font-mono); font-size: 12px; color: var(--accent); letter-spacing: 0.13em; text-transform: uppercase; white-space: nowrap; }
.logo span { color: var(--accent2); }
.header-stats { display: flex; gap: 20px; margin-left: auto; }
.hstat { display: flex; flex-direction: column; align-items: flex-end; }
.hstat-val { font-family: var(--font-mono); font-size: 14px; color: var(--accent); font-weight: 700; line-height: 1.1; }
.hstat-lbl { font-size: 9px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.09em; }

/* â”€â”€ SIDEBARS â”€â”€ */
#sidebar-left  { background: var(--bg2); border-right: 1px solid var(--border); overflow-y: auto; overflow-x: hidden; display: flex; flex-direction: column; }
#sidebar-right { background: var(--bg2); border-left:  1px solid var(--border); overflow-y: auto; display: flex; flex-direction: column; }
::-webkit-scrollbar { width: 3px; } ::-webkit-scrollbar-track { background: transparent; } ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

.panel-section { border-bottom: 1px solid var(--border); padding: 13px 14px; }
.panel-title {
  font-size: 9px; color: var(--accent); text-transform: uppercase; letter-spacing: 0.16em;
  margin-bottom: 10px; display: flex; align-items: center; gap: 7px;
}
.panel-title::before { content: ''; width: 5px; height: 5px; background: currentColor; border-radius: 50%; box-shadow: 0 0 6px currentColor; flex-shrink: 0; }
.panel-title.purple { color: var(--accent3); }
.panel-title.amber  { color: var(--amber); }

/* Controls */
label { font-size: 10px; color: var(--muted); display: block; margin-bottom: 3px; }
input[type=range] {
  -webkit-appearance: none; width: 100%; height: 3px;
  background: var(--border); border-radius: 2px; outline: none; margin: 5px 0 10px; cursor: pointer;
}
input[type=range]::-webkit-slider-thumb {
  -webkit-appearance: none; width: 13px; height: 13px;
  background: var(--accent); border-radius: 50%; box-shadow: 0 0 7px rgba(0,229,255,.6);
}
.slider-val { font-family: var(--font-mono); font-size: 11px; color: var(--text); float: right; }

select {
  width: 100%; background: var(--bg3); border: 1px solid var(--border); color: var(--text);
  padding: 6px 9px; font-family: var(--font-ui); font-size: 11px;
  border-radius: 4px; margin-bottom: 9px; cursor: pointer; outline: none;
}
select:focus { border-color: var(--accent); }

.btn-row { display: flex; gap: 6px; margin-bottom: 7px; flex-wrap: wrap; }
.btn {
  flex: 1; min-width: 46px; padding: 6px 4px; font-family: var(--font-mono); font-size: 9px;
  text-transform: uppercase; letter-spacing: 0.07em; border: 1px solid var(--border);
  background: var(--bg3); color: var(--muted); border-radius: 4px; cursor: pointer;
  transition: all 0.18s; white-space: nowrap;
}
.btn:hover, .btn.active { border-color: var(--accent); color: var(--accent); background: rgba(0,229,255,.05); box-shadow: 0 0 10px rgba(0,229,255,.1); }
.btn.red:hover, .btn.red.active { border-color: var(--accent2); color: var(--accent2); background: rgba(255,77,109,.05); }

/* Toggle switch */
.toggle-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 9px; }
.toggle-label { font-size: 10px; color: var(--muted); }
.toggle-switch { position: relative; width: 32px; height: 18px; cursor: pointer; flex-shrink: 0; }
.toggle-switch input { opacity: 0; width: 0; height: 0; position: absolute; }
.toggle-track { position: absolute; inset: 0; background: var(--border); border-radius: 9px; transition: background .2s; }
.toggle-switch input:checked + .toggle-track { background: var(--accent); }
.toggle-thumb { position: absolute; top: 3px; left: 3px; width: 12px; height: 12px; background: #fff; border-radius: 50%; transition: transform .2s; box-shadow: 0 1px 3px rgba(0,0,0,.4); pointer-events: none; }
.toggle-switch input:checked ~ .toggle-thumb { transform: translateX(14px); }

/* Search */
.search-wrap { position: relative; margin-bottom: 9px; }
.search-wrap input { width: 100%; background: var(--bg3); border: 1px solid var(--border); color: var(--text); padding: 6px 27px 6px 9px; font-family: var(--font-mono); font-size: 10px; border-radius: 4px; outline: none; }
.search-wrap input:focus { border-color: var(--accent); }
.search-wrap input::placeholder { color: var(--muted); }
.search-icon { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); color: var(--muted); pointer-events: none; font-size: 11px; }
#search-results { background: var(--bg3); border: 1px solid var(--border); border-radius: 4px; max-height: 150px; overflow-y: auto; display: none; margin-top: 2px; position: absolute; width: 100%; z-index: 50; }
.search-item { padding: 6px 9px; font-size: 10px; cursor: pointer; color: var(--text); border-bottom: 1px solid var(--border); transition: background .1s; }
.search-item:last-child { border-bottom: none; }
.search-item:hover { background: rgba(0,229,255,.06); color: var(--accent); }

/* Legend */
.legend-item { display: flex; align-items: center; gap: 7px; font-size: 10px; color: var(--muted); margin-bottom: 5px; cursor: pointer; border-radius: 3px; padding: 2px 3px; transition: background .1s; }
.legend-item:hover { background: rgba(255,255,255,.04); }
.legend-dot { width: 9px; height: 9px; border-radius: 50%; flex-shrink: 0; }
.legend-count { font-family: var(--font-mono); font-size: 8px; color: var(--muted); margin-left: auto; }

/* Top node list */
.node-list-item { display: flex; align-items: center; gap: 8px; padding: 6px 0; border-bottom: 1px solid rgba(30,42,58,.55); cursor: pointer; border-radius: 4px; transition: all .12s; }
.node-list-item:hover { background: rgba(0,229,255,.04); padding-left: 5px; }
.node-list-item.active { background: rgba(0,229,255,.07); padding-left: 5px; }
.node-rank { font-family: var(--font-mono); font-size: 9px; color: var(--muted); width: 16px; flex-shrink: 0; }
.node-name { font-size: 10px; color: var(--text); flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.node-badge { font-family: var(--font-mono); font-size: 8px; padding: 1px 5px; border-radius: 8px; background: rgba(0,229,255,.1); color: var(--accent); white-space: nowrap; flex-shrink: 0; }

/* â”€â”€ MAIN â”€â”€ */
#main { position: relative; overflow: hidden; background: var(--bg); }
#main::before {
  content: ''; position: absolute; inset: 0; pointer-events: none;
  background-image: radial-gradient(circle at 50% 35%, rgba(0,229,255,.03) 0%, transparent 65%),
    linear-gradient(var(--grid) 1px, transparent 1px), linear-gradient(90deg, var(--grid) 1px, transparent 1px);
  background-size: auto, 42px 42px, 42px 42px;
}

#network-svg { width: 100%; height: 100%; display: block; cursor: grab; }
#network-svg:active { cursor: grabbing; }

/* Tabs */
#tabs { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); display: flex; background: rgba(10,14,24,.92); border: 1px solid var(--border); border-radius: 5px; padding: 3px; gap: 2px; z-index: 15; backdrop-filter: blur(14px); }
.tab { padding: 4px 12px; font-size: 9px; font-family: var(--font-mono); text-transform: uppercase; letter-spacing: .09em; color: var(--muted); cursor: pointer; border-radius: 3px; transition: all .18s; white-space: nowrap; }
.tab:hover { color: var(--text); }
.tab.active { background: var(--accent); color: #000; font-weight: 700; }

/* Toolbar */
#toolbar { position: absolute; top: 45px; left: 50%; transform: translateX(-50%); display: flex; gap: 4px; z-index: 15; }
.tbtn { padding: 4px 10px; font-size: 9px; font-family: var(--font-mono); text-transform: uppercase; letter-spacing: .07em; background: rgba(10,14,24,.88); border: 1px solid var(--border); color: var(--muted); border-radius: 4px; cursor: pointer; backdrop-filter: blur(10px); transition: all .18s; white-space: nowrap; }
.tbtn:hover { border-color: var(--accent); color: var(--accent); }
.tbtn.active { border-color: var(--accent); color: var(--accent); background: rgba(0,229,255,.07); }
.tbtn.lasso-active { border-color: var(--amber) !important; color: var(--amber) !important; background: rgba(251,191,36,.07) !important; }

#sel-badge { position: absolute; top: 45px; right: 10px; z-index: 15; background: rgba(10,14,24,.9); border: 1px solid var(--accent3); border-radius: 4px; padding: 3px 9px; font-family: var(--font-mono); font-size: 9px; color: var(--accent3); display: none; backdrop-filter: blur(8px); }

/* Tooltip */
#tooltip { position: absolute; background: rgba(10,14,22,.96); border: 1px solid var(--accent); border-radius: 7px; padding: 10px 13px; pointer-events: none; max-width: 230px; z-index: 100; display: none; box-shadow: 0 0 22px rgba(0,229,255,.15), 0 4px 20px rgba(0,0,0,.5); backdrop-filter: blur(16px); }
.tt-name { font-family: var(--font-mono); font-size: 12px; color: var(--accent); margin-bottom: 6px; border-bottom: 1px solid var(--border); padding-bottom: 5px; word-break: break-all; }
.tt-role { display: inline-block; font-size: 8px; padding: 2px 6px; border-radius: 8px; background: rgba(168,85,247,.14); color: var(--accent3); border: 1px solid rgba(168,85,247,.3); margin-bottom: 5px; }
.tt-row { display: flex; justify-content: space-between; font-size: 9px; margin-bottom: 3px; gap: 8px; }
.tt-key { color: var(--muted); } .tt-val { color: var(--text); font-family: var(--font-mono); }
.tt-hint { font-size: 8px; color: var(--muted); margin-top: 5px; }

/* Loading */
#loading { position: absolute; inset: 0; background: var(--bg); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 16px; z-index: 200; }
.loader-ring { width: 56px; height: 56px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin .85s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
.loader-bar { width: 180px; height: 2px; background: var(--border); border-radius: 2px; overflow: hidden; }
.loader-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--accent3)); border-radius: 2px; transition: width .25s; }
.loader-text { font-family: var(--font-mono); font-size: 10px; color: var(--muted); letter-spacing: .1em; text-transform: uppercase; }

/* Sim bar */
#sim-bar { position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%); width: 100px; height: 2px; background: var(--border); border-radius: 2px; overflow: hidden; opacity: 0; transition: opacity .3s; }
#sim-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--accent3)); border-radius: 2px; }

.secondary-chart-area { position: absolute; inset: 0; display: none; padding: 48px 18px 18px; }
.secondary-chart-area.visible { display: block; }

/* SVG */
.e-base { stroke: #2e4a66; stroke-opacity: .32; }
.e-base.dim { stroke-opacity: .04; }
.e-base.hi  { stroke: var(--accent) !important; stroke-opacity: 1 !important; }
.n-group { cursor: pointer; }
.n-group.selected circle { stroke: #ffffff !important; stroke-width: 2.5 !important; }
.n-group.pinned   circle { stroke: var(--amber)   !important; stroke-width: 2   !important; }
.n-label { font-family: var(--font-mono); font-size: 8.5px; fill: rgba(226,232,240,.72); pointer-events: none; text-anchor: middle; }
.n-label.hidden { display: none; }
#lasso-box { fill: rgba(251,191,36,.05); stroke: var(--amber); stroke-width: 1; stroke-dasharray: 4 3; pointer-events: none; }

/* Right sidebar */
.chart-wrap { padding: 13px; border-bottom: 1px solid var(--border); }
.chart-title { font-size: 9px; color: var(--accent3); text-transform: uppercase; letter-spacing: .12em; margin-bottom: 8px; display: flex; align-items: center; gap: 6px; }
.chart-title::before { content: ''; width: 5px; height: 5px; background: var(--accent3); border-radius: 50%; box-shadow: 0 0 5px var(--accent3); flex-shrink: 0; }
#node-detail { padding: 13px; display: none; border-bottom: 1px solid var(--border); }
.detail-name { font-family: var(--font-mono); font-size: 13px; color: var(--accent); margin-bottom: 5px; word-break: break-all; }
.detail-role { display: inline-block; font-size: 9px; padding: 2px 8px; border-radius: 10px; background: rgba(168,85,247,.14); color: var(--accent3); border: 1px solid rgba(168,85,247,.28); margin-bottom: 11px; }
.metric-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 10px; }
.metric-card { background: var(--bg3); border: 1px solid var(--border); border-radius: 5px; padding: 8px; }
.metric-val { font-family: var(--font-mono); font-size: 13px; color: var(--text); font-weight: 700; line-height: 1.1; }
.metric-lbl { font-size: 8px; color: var(--muted); text-transform: uppercase; letter-spacing: .07em; margin-top: 2px; }
.nbr-title { font-size: 9px; color: var(--accent); text-transform: uppercase; letter-spacing: .12em; margin-bottom: 5px; }
.nbr-list { display: flex; flex-direction: column; gap: 2px; max-height: 110px; overflow-y: auto; }
.nbr-item { display: flex; justify-content: space-between; font-size: 9px; font-family: var(--font-mono); color: var(--muted); padding: 2px 0; cursor: pointer; transition: color .1s; }
.nbr-item:hover { color: var(--accent); }
.nbr-weight { color: var(--muted); }
#multi-detail { padding: 13px; display: none; border-bottom: 1px solid var(--border); }
.multi-title { font-size: 10px; color: var(--amber); margin-bottom: 8px; font-family: var(--font-mono); }
#keyword-cloud { padding: 13px; }
.cloud-words { display: flex; flex-wrap: wrap; gap: 5px; align-items: center; }
.cloud-word { font-family: var(--font-mono); cursor: default; color: var(--text); transition: all .2s; padding: 1px 3px; border-radius: 3px; }
.cloud-word:hover { color: var(--accent); text-shadow: 0 0 9px var(--accent); }
</style>
</head>
<body>
<div id="app">

<!-- HEADER -->
<header>
  <div class="logo">ENRON <span>SNA</span> // Network Intelligence Dashboard</div>
  <div class="header-stats">
    <div class="hstat"><span class="hstat-val" id="stat-emails">â€”</span><span class="hstat-lbl">Emails</span></div>
    <div class="hstat"><span class="hstat-val" id="stat-nodes">â€”</span><span class="hstat-lbl">Nodes</span></div>
    <div class="hstat"><span class="hstat-val" id="stat-edges">â€”</span><span class="hstat-lbl">Edges</span></div>
    <div class="hstat"><span class="hstat-val" id="stat-comms">â€”</span><span class="hstat-lbl">Communities</span></div>
    <div class="hstat"><span class="hstat-val" id="stat-density">â€”</span><span class="hstat-lbl">Density</span></div>
    <div class="hstat"><span class="hstat-val" id="stat-dates">â€”</span><span class="hstat-lbl">Date Range</span></div>
  </div>
</header>

<!-- LEFT SIDEBAR -->
<div id="sidebar-left">

  <div class="panel-section">
    <div class="panel-title">Search Nodes</div>
    <div class="search-wrap">
      <input type="text" id="node-search" placeholder="name or emailâ€¦"/>
      <span class="search-icon">âŒ•</span>
      <div id="search-results"></div>
    </div>
  </div>

  <div class="panel-section">
    <div class="panel-title">Network Filter</div>
    <label>Min. Edge Weight (1/N sum) <span class="slider-val" id="weight-val">1.0</span></label>
    <input type="range" id="slider-weight" min="0" max="100" value="0"/>
    <label>Max. Nodes <span class="slider-val" id="nodes-val">200</span></label>
    <input type="range" id="slider-nodes" min="20" max="1000" value="200" step="10"/>
    <label>Link Distance <span class="slider-val" id="dist-val">60</span></label>
    <input type="range" id="slider-dist" min="15" max="1000" value="60" step="5"/>
    <label>Repulsion Force <span class="slider-val" id="rep-val">120</span></label>
    <input type="range" id="slider-rep" min="10" max="1000" value="120" step="10"/>
  </div>

  <div class="panel-section">
    <div class="panel-title">Visual Encoding</div>
    <label>Node Size by</label>
    <select id="sel-size">
      <option value="pagerank">PageRank</option>
      <option value="betweenness">Betweenness Centrality</option>
      <option value="weighted_degree">Weighted Degree</option>
      <option value="unique_contacts">Unique Contacts</option>
      <option value="sent">Emails Sent</option>
      <option value="received">Emails Received</option>
    </select>
    <label>Color by</label>
    <select id="sel-color">
      <option value="community">Community (Louvain)</option>
      <option value="inferred_role">Inferred Role</option>
      <option value="betweenness">Betweenness</option>
      <option value="pagerank">PageRank</option>
    </select>
  </div>

  <div class="panel-section">
    <div class="panel-title">Display Options</div>
    <div class="toggle-row">
      <span class="toggle-label">Show Labels</span>
      <label class="toggle-switch"><input type="checkbox" id="tog-labels" checked/><div class="toggle-track"></div><div class="toggle-thumb"></div></label>
    </div>
    <div class="toggle-row">
      <span class="toggle-label">Top nodes only</span>
      <label class="toggle-switch"><input type="checkbox" id="tog-toplabels" checked/><div class="toggle-track"></div><div class="toggle-thumb"></div></label>
    </div>
    <div class="toggle-row">
      <span class="toggle-label">Show isolated nodes</span>
      <label class="toggle-switch"><input type="checkbox" id="tog-isolated"/><div class="toggle-track"></div><div class="toggle-thumb"></div></label>
    </div>
    <div class="toggle-row">
      <span class="toggle-label">Edge width by weight</span>
      <label class="toggle-switch"><input type="checkbox" id="tog-edgewidth" checked/><div class="toggle-track"></div><div class="toggle-thumb"></div></label>
    </div>
  </div>

  <div class="panel-section">
    <div class="panel-title">Simulation</div>
    <div class="btn-row">
      <button class="btn active" id="btn-play">â–¶ Run</button>
      <button class="btn" id="btn-pause">â¸ Pause</button>
      <button class="btn" id="btn-heat">ğŸ”¥ Heat</button>
    </div>
    <div class="btn-row">
      <button class="btn" id="btn-reset">â†º Rebuild</button>
      <button class="btn" id="btn-fit">âŠ¡ Fit</button>
      <button class="btn red" id="btn-unpin">Unpin All</button>
    </div>
  </div>

  <div class="panel-section">
    <div class="panel-title purple">Community Legend</div>
    <div id="legend-container"></div>
  </div>

  <div class="panel-section">
    <div class="panel-title">Role Legend</div>
    <div class="legend-item"><div class="legend-dot" style="background:#ff4d6d"></div>Executive / Broker</div>
    <div class="legend-item"><div class="legend-dot" style="background:#fbbf24"></div>Information Broker</div>
    <div class="legend-item"><div class="legend-dot" style="background:#a855f7"></div>Broadcaster</div>
    <div class="legend-item"><div class="legend-dot" style="background:#22c55e"></div>Information Sink</div>
    <div class="legend-item"><div class="legend-dot" style="background:#00e5ff"></div>Connector</div>
    <div class="legend-item"><div class="legend-dot" style="background:#475569"></div>Regular Employee</div>
  </div>

  <div class="panel-section">
    <div class="panel-title amber">Top 20 by PageRank</div>
    <div id="top-nodes-list"></div>
  </div>

</div>

<!-- MAIN CANVAS -->
<div id="main">
  <div id="loading">
    <div class="loader-ring"></div>
    <div class="loader-bar"><div class="loader-fill" id="loader-fill"></div></div>
    <div class="loader-text" id="loading-msg">Initialisingâ€¦</div>
  </div>

  <div id="tabs">
    <div class="tab active" data-tab="network">Network</div>
    <div class="tab" data-tab="timeline">Timeline</div>
    <div class="tab" data-tab="degree">Degree Dist.</div>
    <div class="tab" data-tab="centrality">Centrality</div>
  </div>

  <div id="toolbar">
    <button class="tbtn active" id="tb-select">â˜° Select</button>
    <button class="tbtn" id="tb-lasso">â¬¡ Lasso</button>
    <button class="tbtn" id="tb-pan">âœ¥ Pan</button>
    <button class="tbtn active" id="tb-labels">â’¶ Labels</button>
    <button class="tbtn" id="tb-png">â¬‡ PNG</button>
  </div>

  <div id="sel-badge"></div>

  <svg id="network-svg">
    <defs>
      <filter id="glow-f" x="-50%" y="-50%" width="200%" height="200%">
        <feGaussianBlur stdDeviation="3.5" result="b"/>
        <feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge>
      </filter>
    </defs>
    <rect id="lasso-box" display="none" x="0" y="0" width="0" height="0"/>
  </svg>

  <div id="sim-bar"><div id="sim-fill"></div></div>

  <div class="secondary-chart-area" id="tab-timeline"><canvas id="chart-timeline"></canvas></div>
  <div class="secondary-chart-area" id="tab-degree"><canvas id="chart-degree"></canvas></div>
  <div class="secondary-chart-area" id="tab-centrality"><canvas id="chart-centrality"></canvas></div>

  <div id="tooltip"></div>
</div>

<!-- RIGHT SIDEBAR -->
<div id="sidebar-right">

  <div class="chart-wrap">
    <div class="chart-title">Community Sizes</div>
    <canvas id="chart-community" height="150"></canvas>
  </div>

  <div class="chart-wrap">
    <div class="chart-title">Top Communicators</div>
    <canvas id="chart-top" height="153"></canvas>
  </div>

  <div id="node-detail">
    <div class="detail-name" id="dd-name">â€”</div>
    <div class="detail-role" id="dd-role">â€”</div>
    <div class="metric-grid" id="dd-metrics"></div>
    <div class="nbr-title">Neighbours</div>
    <div class="nbr-list" id="dd-neighbours"></div>
  </div>

  <div id="multi-detail">
    <div class="multi-title" id="multi-title">0 nodes selected</div>
    <div class="metric-grid" id="multi-metrics"></div>
    <div class="btn-row">
      <button class="btn" id="btn-focus-sub">Focus Subgraph</button>
      <button class="btn red" id="btn-clear-sel">Clear</button>
    </div>
  </div>

  <div id="keyword-cloud">
    <div class="chart-title">Subject Keywords</div>
    <div class="cloud-words" id="cloud-words"></div>
  </div>

</div>
</div>

<script>
'use strict';

// â”€â”€ PALETTE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const COMM_PAL = ['#00e5ff','#ff4d6d','#a855f7','#fbbf24','#22c55e','#f97316','#3b82f6','#ec4899','#84cc16','#06b6d4','#8b5cf6','#ef4444','#10b981','#f59e0b','#6366f1','#e879f9','#34d399','#60a5fa'];
const ROLE_COL = {'Executive / Broker':'#ff4d6d','Information Broker':'#fbbf24','Broadcaster':'#a855f7','Information Sink':'#22c55e','Connector':'#00e5ff','Regular Employee':'#475569'};
const commColor = id => COMM_PAL[((id%COMM_PAL.length)+COMM_PAL.length)%COMM_PAL.length];
const roleColor = r => ROLE_COL[r] || '#475569';
const fmt = n => n>=1e6?(n/1e6).toFixed(1)+'M':n>=1e3?(n/1e3).toFixed(0)+'K':''+n;

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ST = {
  showLabels:true, topOnly:true, showIsolated:false, edgeByW:true,
  mode:'select',
  sel:new Set(), pinned:new Set(),
  opts:{maxN:200,minW:1.0,sz:'pagerank',col:'community',dist:60,rep:120}
};
let RAW={}, sim=null, ZM=null, gMain, gEdges, gNodes, Ns, Es, Ls;
let ND=[], ED=[], q85=0, isRunning=true;
let secCharts={}, RC={};
let DT={};
let _szSc, _stSc, _getColorFn; // shared scale refs for refreshVisuals

// â”€â”€ LOAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const FILES=['graph_data','timeline','keywords','degree_dist','top_nodes','communities','stats'];
async function loadAll(){
  for(let i=0;i<FILES.length;i++){
    setLoad(`Loading ${FILES[i]}.jsonâ€¦`,(i/FILES.length)*80);
    try{ const r=await fetch(`sna_output/${FILES[i]}.json`); if(!r.ok)throw 0; RAW[FILES[i]]=await r.json(); }
    catch{ RAW[FILES[i]]=FILES[i]==='graph_data'?{nodes:[],edges:[]}:FILES[i]==='stats'?{}:[]; }
    await pause(18);
  }
}
const pause=ms=>new Promise(r=>setTimeout(r,ms));
function setLoad(m,p){ document.getElementById('loading-msg').textContent=m; if(p!=null)document.getElementById('loader-fill').style.width=p+'%'; }
function hideLd(){ const e=document.getElementById('loading'); e.style.transition='opacity .4s'; e.style.opacity=0; setTimeout(()=>e.style.display='none',420); }

// â”€â”€ STATS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderStats(s){
  document.getElementById('stat-emails').textContent=fmt(s.total_emails||0);
  document.getElementById('stat-nodes').textContent=fmt(s.total_nodes||0);
  document.getElementById('stat-edges').textContent=fmt(s.total_edges||0);
  document.getElementById('stat-comms').textContent=s.n_communities||'â€”';
  document.getElementById('stat-density').textContent=(s.density||0).toFixed(4);
  const a=(s.date_range_start||'').slice(0,7),b=(s.date_range_end||'').slice(0,7);
  document.getElementById('stat-dates').textContent=a&&b?`${a} â†’ ${b}`:'â€”';
}

// â”€â”€ COMMUNITY LEGEND â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCommLegend(comms){
  const el=document.getElementById('legend-container'); el.innerHTML='';
  (comms||[]).slice(0,12).forEach(c=>{
    const d=document.createElement('div'); d.className='legend-item';
    d.innerHTML=`<div class="legend-dot" style="background:${commColor(c.community_id)}"></div>Comm. ${c.community_id}<span class="legend-count">${c.size}</span>`;
    d.addEventListener('click',()=>selectCommunity(c.community_id));
    el.appendChild(d);
  });
}
function selectCommunity(cid){ ST.sel.clear(); ND.forEach(n=>{if(n.community===cid)ST.sel.add(n.id);}); applySelVis(); badge(); if(ST.sel.size===1){ const sole=ND.find(n=>ST.sel.has(n.id)); if(sole)focusNode(sole); } else { showMultiPanel(); } }

// â”€â”€ TOP LIST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTopList(tn){
  const el=document.getElementById('top-nodes-list'); el.innerHTML='';
  (tn||[]).slice(0,20).forEach((n,i)=>{
    const d=document.createElement('div'); d.className='node-list-item'; d.id='nli-'+n.id;
    d.innerHTML=`<span class="node-rank">${i+1}</span><span class="node-name">${n.id.split('@')[0]}</span><span class="node-badge">${((n.inferred_role||n.role)||'').split(' ')[0]||'â€”'}</span>`;
    d.addEventListener('click',()=>focusById(n.id));
    el.appendChild(d);
  });
}

// â”€â”€ CLOUD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCloud(kw){
  const el=document.getElementById('cloud-words'); el.innerHTML='';
  if(!kw?.length)return;
  const mx=kw[0].count,mn=kw[kw.length-1].count;
  kw.slice(0,60).forEach(({word,count})=>{
    const t=(count-mn)/Math.max(mx-mn,1),s=document.createElement('span');
    s.className='cloud-word'; s.textContent=word; s.style.fontSize=(9+t*14)+'px'; s.style.opacity=0.35+t*0.65;
    el.appendChild(s);
  });
}

// â”€â”€ CHARTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TT={backgroundColor:'#0a0e16',borderColor:'#1e2a3a',borderWidth:1,titleColor:'#00e5ff',bodyColor:'#e2e8f0'};
function renderCommChart(c){ c=(c||[]).slice(0,10); const ctx=document.getElementById('chart-community').getContext('2d'); if(RC.comm)RC.comm.destroy(); RC.comm=new Chart(ctx,{type:'doughnut',data:{labels:c.map(x=>`C${x.community_id}`),datasets:[{data:c.map(x=>x.size),backgroundColor:c.map(x=>commColor(x.community_id)+'bb'),borderColor:c.map(x=>commColor(x.community_id)),borderWidth:1.5}]},options:{responsive:true,plugins:{legend:{display:false},tooltip:TT}}}); }
function renderTopChart(tn){ const t=(tn||[]).slice(0,10); const ctx=document.getElementById('chart-top').getContext('2d'); if(RC.top)RC.top.destroy(); RC.top=new Chart(ctx,{type:'bar',data:{labels:t.map(n=>n.id.split('@')[0]),datasets:[{label:'Sent',data:t.map(n=>n.sent),backgroundColor:'rgba(0,229,255,.6)'},{label:'Received',data:t.map(n=>n.received),backgroundColor:'rgba(255,77,109,.6)'}]},options:{responsive:true,indexAxis:'y',plugins:{legend:{labels:{color:'#94a3b8',font:{size:9}}},tooltip:TT},scales:{x:{ticks:{color:'#64748b'},grid:{color:'rgba(30,42,58,.5)'}},y:{ticks:{color:'#94a3b8',font:{size:9}},grid:{display:false}}}}}); }
function renderTimelineChart(tl){ const ctx=document.getElementById('chart-timeline').getContext('2d'); if(secCharts.timeline)secCharts.timeline.destroy(); secCharts.timeline=new Chart(ctx,{type:'line',data:{labels:(tl||[]).map(d=>d.period),datasets:[{label:'Emails/month',data:(tl||[]).map(d=>d.email_count),fill:true,borderColor:'#00e5ff',backgroundColor:'rgba(0,229,255,.07)',tension:.3,pointRadius:2}]},options:{responsive:true,plugins:{legend:{display:false},tooltip:TT},scales:{x:{ticks:{color:'#64748b',maxTicksLimit:13,font:{size:9}},grid:{color:'rgba(30,42,58,.5)'}},y:{ticks:{color:'#64748b'},grid:{color:'rgba(30,42,58,.5)'}}}}});}
function renderDegreeChart(dd){ const pts=(dd||[]).filter(d=>d.degree>0&&d.count>0); const ctx=document.getElementById('chart-degree').getContext('2d'); if(secCharts.degree)secCharts.degree.destroy(); secCharts.degree=new Chart(ctx,{type:'scatter',data:{datasets:[{label:'Degree Dist.',data:pts.map(d=>({x:Math.log10(d.degree),y:Math.log10(d.count)})),backgroundColor:'rgba(168,85,247,.65)',pointRadius:4}]},options:{responsive:true,plugins:{legend:{display:false},tooltip:{...TT,callbacks:{label:c=>`Degree ${Math.round(10**c.parsed.x)}, Count ${Math.round(10**c.parsed.y)}`}}},scales:{x:{title:{display:true,text:'logâ‚â‚€(Degree)',color:'#64748b'},ticks:{color:'#64748b'},grid:{color:'rgba(30,42,58,.5)'}},y:{title:{display:true,text:'logâ‚â‚€(Count)',color:'#64748b'},ticks:{color:'#64748b'},grid:{color:'rgba(30,42,58,.5)'}}}}});}
function renderCentralityChart(tn){ const top20=(tn||[]).slice(0,20),t=top20.slice(0,5),mx=k=>Math.max(...top20.map(n=>n[k]||0))||1; const ctx=document.getElementById('chart-centrality').getContext('2d'); if(secCharts.centrality)secCharts.centrality.destroy(); secCharts.centrality=new Chart(ctx,{type:'radar',data:{labels:['PageRank','Betweenness','Contacts','Sent','Received'],datasets:t.map((n,i)=>({label:n.id.split('@')[0],data:[n.pagerank/mx('pagerank'),n.betweenness/mx('betweenness'),n.unique_contacts/mx('unique_contacts'),n.sent/mx('sent'),n.received/mx('received')],borderColor:COMM_PAL[i],backgroundColor:COMM_PAL[i]+'20',pointBackgroundColor:COMM_PAL[i],borderWidth:1.5}))},options:{responsive:true,plugins:{legend:{labels:{color:'#94a3b8',font:{size:9}}},tooltip:TT},scales:{r:{angleLines:{color:'rgba(30,42,58,.8)'},grid:{color:'rgba(30,42,58,.8)'},pointLabels:{color:'#94a3b8',font:{size:9}},ticks:{display:false}}}}});}

// â”€â”€ FORCE NETWORK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildNetwork(gd,opts){
  const{maxN,minW,sz,col,dist,rep}=opts;
  const svg=d3.select('#network-svg');
  const W=svg.node().clientWidth,H=svg.node().clientHeight;

  // Preserve current zoom/pan so rebuild does not teleport the graph
  const prevT = ZM ? d3.zoomTransform(svg.node()) : null;

  svg.selectAll('g').remove();

  ZM=d3.zoom().scaleExtent([0.05,8]).on('zoom',e=>gMain.attr('transform',e.transform));
  svg.call(ZM);
  if(prevT) svg.call(ZM.transform, prevT);

  svg.select('#bg-hit').remove();
  svg.insert('rect','#lasso-box').attr('id','bg-hit').attr('width',W).attr('height',H).attr('fill','transparent').on('click',()=>{if(ST.mode==='select')clearSel();});

  gMain=svg.append('g'); gEdges=gMain.append('g'); gNodes=gMain.append('g');

  // filter â€” always normalise source/target to string IDs so D3 object-mutation
  // of RAW edges on the first run does not break subsequent rebuilds
  let nodes=[...(gd.nodes||[])].sort((a,b)=>b[sz]-a[sz]).slice(0,maxN);
  const nids=new Set(nodes.map(n=>n.id));
  const rawEdges=(gd.edges||[]).map(e=>({
    source: e.source?.id ?? e.source,
    target: e.target?.id ?? e.target,
    weight: e.weight||1
  }));
  let edges=rawEdges.filter(e=>e.weight>=minW&&nids.has(e.source)&&nids.has(e.target));
  if(!ST.showIsolated){ const con=new Set(); edges.forEach(e=>{con.add(e.source);con.add(e.target);}); nodes=nodes.filter(n=>con.has(n.id)); }
  // guard: nothing to render
  if(!nodes.length){
    gEdges.selectAll('*').remove(); gNodes.selectAll('*').remove();
    ND=[]; ED=[]; Ns=null; Es=null; Ls=null;
    return;
  }
  ND=nodes; ED=edges;

  // Place any newly added nodes near the canvas centre so they don't pile at (0,0)
  nodes.forEach(n=>{ if(n.x==null||n.y==null){n.x=W/2+(Math.random()-.5)*120;n.y=H/2+(Math.random()-.5)*120;n.vx=0;n.vy=0;} });

  // scales (stored at module scope for refreshVisuals)
  const sv=nodes.map(n=>n[sz]||0);
  _szSc=d3.scaleSqrt().domain([0,d3.max(sv)||1]).range([3,22]);
  q85=d3.quantile(sv.slice().sort(d3.ascending),0.85)||0;
  const wv=edges.map(e=>e.weight||1),wMin=Math.max(d3.min(wv)||0.01,0.01),wMax=d3.max(wv)||1;
  _stSc=d3.scaleLog().domain([wMin,wMax]).range([0.4,4]).clamp(true);
  _getColorFn=n=>{ if(col==='community')return commColor(n.community); if(col==='inferred_role')return roleColor(n.inferred_role); const mx=d3.max(nodes.map(x=>x[col]||0))||1; return d3.interpolatePlasma((n[col]||0)/mx); };
  // local aliases
  const szSc=_szSc, stSc=_stSc, getColor=_getColorFn;

  // edges
  Es=gEdges.selectAll('line.e-base').data(edges,d=>d.source+'>'+d.target).join('line').attr('class','e-base').attr('stroke-width',d=>ST.edgeByW?stSc(d.weight||1):0.8);

  // nodes
  const ng=gNodes.selectAll('g.n-group').data(nodes,d=>d.id).join('g')
    .attr('class',d=>'n-group'+(ST.sel.has(d.id)?' selected':'')+(ST.pinned.has(d.id)?' pinned':''))
    .call(d3.drag().filter(()=>ST.mode==='select').on('start',drgS).on('drag',drgM).on('end',drgE))
    .on('click',(ev,d)=>{ ev.stopPropagation(); if(ST.mode!=='select')return; if(ev.shiftKey||ev.ctrlKey||ev.metaKey){ ST.sel.has(d.id)?ST.sel.delete(d.id):ST.sel.add(d.id); applySelVis();badge(); if(ST.sel.size===1){ const sole=ND.find(n=>ST.sel.has(n.id)); if(sole)focusNode(sole); } else if(ST.sel.size===0){ document.getElementById('node-detail').style.display='none'; document.getElementById('multi-detail').style.display='none'; } else { showMultiPanel(); } }else{ST.sel.clear();ST.sel.add(d.id);applySelVis();badge();focusNode(d);} })
    .on('dblclick',(ev,d)=>{ ev.stopPropagation(); if(ST.mode!=='select')return; if(ST.pinned.has(d.id)){ST.pinned.delete(d.id);d.fx=null;d.fy=null;}else{ST.pinned.add(d.id);d.fx=d.x;d.fy=d.y;} applyPinVis(); })
    .on('mouseover',(ev,d)=>{ if(ST.mode!=='lasso')showTooltip(ev,d); })
    .on('mousemove',ev=>moveTT(ev)).on('mouseout',()=>hideTT());

  Ns=ng;
  ng.append('circle').attr('r',d=>szSc(d[sz]||0)).attr('fill',d=>getColor(d)).attr('stroke','rgba(255,255,255,.1)').attr('stroke-width',0.8).attr('filter',d=>(d[sz]||0)>q85?'url(#glow-f)':null);
  Ls=ng.append('text').attr('class',d=>lblClass(d)).attr('dy',d=>szSc(d[sz]||0)+9).text(d=>d.label||d.id.split('@')[0]);

  // simulation â€” proper force layout matching the reference image
  if(sim)sim.stop();
  sim=d3.forceSimulation(nodes)
    .force('link',d3.forceLink(edges).id(d=>d.id).distance(d=>dist/Math.sqrt(Math.max(d.weight,0.01))).strength(0.55))
    .force('charge',d3.forceManyBody().strength(-rep).distanceMax(450))
    .force('center',d3.forceCenter(W/2,H/2).strength(0.04))
    .force('coll',d3.forceCollide(d=>szSc(d[sz]||0)+2.5).strength(0.65))
    .alphaDecay(0.04)
    .on('tick',onTick)
    .on('end',()=>{ document.getElementById('sim-fill').style.width='100%'; setTimeout(()=>document.getElementById('sim-bar').style.opacity=0,900); });

  const bar=document.getElementById('sim-bar'); bar.style.opacity=1; document.getElementById('sim-fill').style.width='0';
  let tc=0; const tot=Math.ceil(-Math.log(0.001)/0.04);
  sim.on('tick.p',()=>{ tc++; document.getElementById('sim-fill').style.width=Math.min(tc/tot*100,99)+'%'; });

  if(!isRunning){ sim.stop(); bar.style.opacity=0; }
  applyMode();
}

// â”€â”€ REFRESH VISUALS (size/colour only â€“ no sim restart, no zoom reset) â”€â”€â”€â”€â”€â”€
function refreshVisuals(){
  if(!Ns||!ND.length){ rebuild(); return; }
  const sz=ST.opts.sz,col=ST.opts.col;
  const sv=ND.map(n=>n[sz]||0);
  _szSc=d3.scaleSqrt().domain([0,d3.max(sv)||1]).range([3,22]);
  q85=d3.quantile(sv.slice().sort(d3.ascending),0.85)||0;
  _getColorFn=n=>{ if(col==='community')return commColor(n.community); if(col==='inferred_role')return roleColor(n.inferred_role); const mx=d3.max(ND.map(x=>x[col]||0))||1; return d3.interpolatePlasma((n[col]||0)/mx); };
  Ns.select('circle')
    .attr('r',d=>_szSc(d[sz]||0))
    .attr('fill',d=>_getColorFn(d))
    .attr('filter',d=>(d[sz]||0)>q85?'url(#glow-f)':null);
  if(Ls) Ls.attr('dy',d=>_szSc(d[sz]||0)+9).attr('class',d=>lblClass(d));
  if(sim){ sim.force('coll',d3.forceCollide(d=>_szSc(d[sz]||0)+2.5).strength(0.65)); sim.alpha(0.12).restart(); }
}

function onTick(){ Es.attr('x1',d=>d.source.x).attr('y1',d=>d.source.y).attr('x2',d=>d.target.x).attr('y2',d=>d.target.y); Ns.attr('transform',d=>`translate(${d.x||0},${d.y||0})`); }
function drgS(ev,d){ if(!ev.active)sim.alphaTarget(0.25).restart(); d.fx=d.x;d.fy=d.y; }
function drgM(ev,d){ d.fx=ev.x;d.fy=ev.y; }
function drgE(ev,d){ if(!ev.active)sim.alphaTarget(0); if(!ST.pinned.has(d.id)){d.fx=null;d.fy=null;} }

// â”€â”€ MODE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyMode(){
  const svg=d3.select('#network-svg');
  svg.call(ZM);
  svg.style('cursor',ST.mode==='pan'?'grab':ST.mode==='lasso'?'crosshair':'default');
  document.getElementById('tb-select').classList.toggle('active',ST.mode==='select');
  document.getElementById('tb-lasso').classList.toggle('active',ST.mode==='lasso');
  document.getElementById('tb-lasso').classList.toggle('lasso-active',ST.mode==='lasso');
  document.getElementById('tb-pan').classList.toggle('active',ST.mode==='pan');
  if(ST.mode==='lasso')setupLasso(svg);
  else{ svg.on('mousedown.lasso',null).on('mousemove.lasso',null).on('mouseup.lasso',null); d3.select('#lasso-box').attr('display','none'); }
  if(Ns)Ns.call(d3.drag().filter(()=>ST.mode==='select').on('start',drgS).on('drag',drgM).on('end',drgE));
}

// â”€â”€ LASSO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setupLasso(svg){
  // Disable zoom panning so it doesn't compete with lasso drawing
  svg.on('mousedown.zoom',null);
  const lb=d3.select('#lasso-box'); let x0,y0,active=false;
  svg.on('mousedown.lasso',function(ev){
    const tgt=ev.target;
    if(tgt!==this&&tgt.id!=='bg-hit'&&tgt.closest&&!tgt.closest('svg'))return;
    if(tgt.closest&&tgt.closest('.node'))return; // don't start drag on nodes
    [x0,y0]=d3.pointer(ev,this);
    lb.attr('x',x0).attr('y',y0).attr('width',0).attr('height',0).attr('display',null);
    active=true; ev.preventDefault(); ev.stopImmediatePropagation();
  });
  svg.on('mousemove.lasso',function(ev){
    if(!active)return;
    const[mx,my]=d3.pointer(ev,this);
    lb.attr('x',Math.min(mx,x0)).attr('y',Math.min(my,y0)).attr('width',Math.abs(mx-x0)).attr('height',Math.abs(my-y0));
  });
  svg.on('mouseup.lasso',function(ev){
    if(!active)return; active=false; lb.attr('display','none');
    const[mx,my]=d3.pointer(ev,this);
    const rx=Math.min(mx,x0),ry=Math.min(my,y0),rw=Math.abs(mx-x0),rh=Math.abs(my-y0);
    if(rw<5&&rh<5){ svg.on('mousedown.zoom',null); return; }
    const t=d3.zoomTransform(svg.node());
    if(!ev.shiftKey)ST.sel.clear();
    ND.forEach(d=>{const sx=t.applyX(d.x||0),sy=t.applyY(d.y||0);if(sx>=rx&&sx<=rx+rw&&sy>=ry&&sy<=ry+rh)ST.sel.add(d.id);});
    applySelVis(); badge();
    if(ST.sel.size===1){ const sole=ND.find(n=>ST.sel.has(n.id)); if(sole)focusNode(sole); }
    else showMultiPanel();
    // Keep zoom-pan disabled until user leaves lasso mode
    svg.call(ZM); svg.on('mousedown.zoom',null);
  });
}

// â”€â”€ SELECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applySelVis(){
  if(!Ns)return;
  const has=ST.sel.size>0;
  Ns.classed('selected',d=>ST.sel.has(d.id));
  if(has){
    const selEdge=e=>{ const s=e.source.id!=null?e.source.id:e.source, t=e.target.id!=null?e.target.id:e.target; return ST.sel.has(s)||ST.sel.has(t); };
    Es.classed('hi',selEdge).classed('dim',e=>!selEdge(e));
    Ns.select('circle').style('opacity',d=>ST.sel.has(d.id)?1:0.18);
  }
  else{ Es.classed('hi',false).classed('dim',false); Ns.select('circle').style('opacity',null); }
}
function applyPinVis(){ if(Ns)Ns.classed('pinned',d=>ST.pinned.has(d.id)); }
function clearSel(){ ST.sel.clear();applySelVis();badge(); document.getElementById('node-detail').style.display='none'; document.getElementById('multi-detail').style.display='none'; document.querySelectorAll('.node-list-item').forEach(e=>e.classList.remove('active')); }
function badge(){ const el=document.getElementById('sel-badge'),n=ST.sel.size; el.style.display=n?'block':'none'; if(n)el.textContent=`${n} node${n>1?'s':''} selected`; }

// â”€â”€ LABELS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function lblClass(d){ const top=!ST.topOnly||(d[ST.opts.sz]||0)>=q85; return 'n-label'+(ST.showLabels&&top?'':' hidden'); }
function applyLabels(){ if(Ls)Ls.attr('class',d=>lblClass(d)); }

// â”€â”€ TOOLTIP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showTooltip(ev,d){ const tt=document.getElementById('tooltip'); tt.style.display='block'; tt.innerHTML=`<div class="tt-name">${d.id}</div><div class="tt-role">${d.inferred_role||'â€”'}</div><div class="tt-row"><span class="tt-key">Community</span><span class="tt-val">${d.community??'â€”'}</span></div><div class="tt-row"><span class="tt-key">PageRank</span><span class="tt-val">${(d.pagerank||0).toFixed(5)}</span></div><div class="tt-row"><span class="tt-key">Betweenness</span><span class="tt-val">${(d.betweenness||0).toFixed(5)}</span></div><div class="tt-row"><span class="tt-key">Sent / Recv</span><span class="tt-val">${(d.sent||0).toLocaleString()} / ${(d.received||0).toLocaleString()}</span></div><div class="tt-row"><span class="tt-key">Contacts</span><span class="tt-val">${d.unique_contacts||0}</span></div><div class="tt-hint">Click Â· Shift+click multi Â· Dbl-click pin</div>`; moveTT(ev); }
function moveTT(ev){ const tt=document.getElementById('tooltip'),r=document.getElementById('main').getBoundingClientRect(); let x=ev.clientX-r.left+14,y=ev.clientY-r.top-12; if(x+244>r.width)x-=256; if(y+225>r.height)y=r.height-230; tt.style.left=x+'px';tt.style.top=y+'px'; }
function hideTT(){ document.getElementById('tooltip').style.display='none'; }

// â”€â”€ FOCUS NODE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function focusNode(d){
  document.getElementById('node-detail').style.display='block'; document.getElementById('multi-detail').style.display='none';
  document.querySelectorAll('.node-list-item').forEach(e=>e.classList.remove('active'));
  const li=document.getElementById('nli-'+d.id); if(li){li.classList.add('active');li.scrollIntoView({block:'nearest'});}
  document.getElementById('dd-name').textContent=d.id; document.getElementById('dd-role').textContent=d.inferred_role||'â€”';
  const mets=[{l:'PageRank',v:(d.pagerank||0).toFixed(5)},{l:'Betweenness',v:(d.betweenness||0).toFixed(5)},{l:'Eigenvector',v:(d.eigenvector||0).toFixed(5)},{l:'Clustering',v:(d.clustering||0).toFixed(4)},{l:'Sent',v:(d.sent||0).toLocaleString()},{l:'Received',v:(d.received||0).toLocaleString()},{l:'Contacts',v:d.unique_contacts||0},{l:'Months Active',v:d.months_active||0}];
  document.getElementById('dd-metrics').innerHTML=mets.map(m=>`<div class="metric-card"><div class="metric-val">${m.v}</div><div class="metric-lbl">${m.l}</div></div>`).join('');
  const nbrs=ED.filter(e=>{const s=e.source.id!=null?e.source.id:e.source,t=e.target.id!=null?e.target.id:e.target;return s===d.id||t===d.id;}).map(e=>{const s=e.source.id!=null?e.source.id:e.source,t=e.target.id!=null?e.target.id:e.target;return{other:s===d.id?t:s,weight:e.weight||0};}).sort((a,b)=>b.weight-a.weight).slice(0,15);
  document.getElementById('dd-neighbours').innerHTML=nbrs.map(n=>`<div class="nbr-item" data-id="${n.other}"><span>${n.other.split('@')[0]}</span><span class="nbr-weight">${n.weight.toFixed(1)}</span></div>`).join('');
  document.getElementById('dd-neighbours').querySelectorAll('.nbr-item').forEach(el=>el.addEventListener('click',()=>focusById(el.dataset.id)));
}
function focusById(id){ const d=ND.find(n=>n.id===id);if(!d)return; ST.sel.clear();ST.sel.add(id);applySelVis();badge();focusNode(d);panTo(d); }
function panTo(d){ if(d.x==null||d.y==null)return; const svg=d3.select('#network-svg'),W=svg.node().clientWidth,H=svg.node().clientHeight,t=d3.zoomTransform(svg.node()); svg.transition().duration(600).call(ZM.transform,d3.zoomIdentity.translate(W/2-t.k*d.x,H/2-t.k*d.y).scale(t.k)); }

// â”€â”€ MULTI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showMultiPanel(){ const n=ST.sel.size; if(n<2){ document.getElementById('multi-detail').style.display='none'; return; } document.getElementById('node-detail').style.display='none';document.getElementById('multi-detail').style.display='block'; document.getElementById('multi-title').textContent=`${n} nodes selected`; const sel=ND.filter(d=>ST.sel.has(d.id)),avg=k=>(sel.reduce((s,d)=>s+(d[k]||0),0)/sel.length).toFixed(4),sum=k=>sel.reduce((s,d)=>s+(d[k]||0),0).toLocaleString(); document.getElementById('multi-metrics').innerHTML=[{l:'Avg PageRank',v:avg('pagerank')},{l:'Avg Betweenness',v:avg('betweenness')},{l:'Total Sent',v:sum('sent')},{l:'Total Received',v:sum('received')}].map(m=>`<div class="metric-card"><div class="metric-val" style="font-size:12px">${m.v}</div><div class="metric-lbl">${m.l}</div></div>`).join(''); }

// â”€â”€ FIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fitGraph(){ if(!ND.length)return; const svg=d3.select('#network-svg'),W=svg.node().clientWidth,H=svg.node().clientHeight; const xs=ND.map(d=>d.x||0).filter(isFinite),ys=ND.map(d=>d.y||0).filter(isFinite); const x0=d3.min(xs),x1=d3.max(xs),y0=d3.min(ys),y1=d3.max(ys),pad=55; const k=Math.min((W-pad*2)/((x1-x0)||1),(H-pad*2)/((y1-y0)||1),5); svg.transition().duration(650).call(ZM.transform,d3.zoomIdentity.translate(W/2-k*(x0+x1)/2,H/2-k*(y0+y1)/2).scale(k)); }

// â”€â”€ PNG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function exportPNG(){ const svgEl=document.getElementById('network-svg'),s=new XMLSerializer().serializeToString(svgEl),c=document.createElement('canvas'); c.width=svgEl.clientWidth*2;c.height=svgEl.clientHeight*2; const ctx=c.getContext('2d'); ctx.fillStyle='#05070d';ctx.fillRect(0,0,c.width,c.height); const img=new Image(); img.onload=()=>{ctx.drawImage(img,0,0,c.width,c.height);const a=document.createElement('a');a.download='enron-sna.png';a.href=c.toDataURL();a.click();}; img.src='data:image/svg+xml;base64,'+btoa(unescape(encodeURIComponent(s))); }

// â”€â”€ SEARCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setupSearch(){ const inp=document.getElementById('node-search'),res=document.getElementById('search-results'); inp.addEventListener('input',()=>{ const q=inp.value.trim().toLowerCase();if(!q){res.style.display='none';return;} const hits=ND.filter(n=>n.id.toLowerCase().includes(q)||(n.label||'').toLowerCase().includes(q)).slice(0,10);if(!hits.length){res.style.display='none';return;} res.style.display='block'; res.innerHTML=hits.map(n=>`<div class="search-item" data-id="${n.id}">${n.label||n.id.split('@')[0]}<span style="color:var(--muted);font-size:8px"> ${n.id}</span></div>`).join(''); res.querySelectorAll('.search-item').forEach(el=>el.addEventListener('click',()=>{focusById(el.dataset.id);inp.value='';res.style.display='none';})); }); document.addEventListener('click',e=>{if(!e.target.closest('.search-wrap'))res.style.display='none';}); }

// â”€â”€ CONTROLS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const db=(fn,ms,k)=>{clearTimeout(DT[k]);DT[k]=setTimeout(fn,ms);};
const rebuild=()=>{if(RAW.graph_data)buildNetwork(RAW.graph_data,ST.opts);};

function setupControls(){
  const wsl=document.getElementById('slider-weight');
  wsl.addEventListener('input',function(){ const v=Math.pow(10,+this.value/33.33); document.getElementById('weight-val').textContent=v<10?v.toFixed(1):Math.round(v); ST.opts.minW=v; db(rebuild,350,'w'); });
  document.getElementById('slider-nodes').addEventListener('input',function(){ document.getElementById('nodes-val').textContent=this.value; ST.opts.maxN=+this.value; db(rebuild,350,'n'); });
  document.getElementById('slider-dist').addEventListener('input',function(){ const v=+this.value; document.getElementById('dist-val').textContent=v; ST.opts.dist=v; if(sim){sim.force('link').distance(d=>v/Math.sqrt(Math.max(d.weight,0.01)));sim.alpha(0.3).restart();} });
  document.getElementById('slider-rep').addEventListener('input',function(){ const v=+this.value; document.getElementById('rep-val').textContent=v; ST.opts.rep=v; if(sim){sim.force('charge').strength(-v);sim.alpha(0.3).restart();} });
  document.getElementById('sel-size').addEventListener('change',e=>{ST.opts.sz=e.target.value;refreshVisuals();});
  document.getElementById('sel-color').addEventListener('change',e=>{ST.opts.col=e.target.value;refreshVisuals();});

  // display toggles
  document.getElementById('tog-labels').addEventListener('change',e=>{ ST.showLabels=e.target.checked; document.getElementById('tb-labels').classList.toggle('active',ST.showLabels); applyLabels(); });
  document.getElementById('tog-toplabels').addEventListener('change',e=>{ ST.topOnly=e.target.checked; applyLabels(); });
  document.getElementById('tog-isolated').addEventListener('change',e=>{ ST.showIsolated=e.target.checked; rebuild(); });
  document.getElementById('tog-edgewidth').addEventListener('change',e=>{
    ST.edgeByW=e.target.checked;
    if(Es&&ED.length){
      const wv=ED.map(e=>e.weight||1),wMin=Math.max(d3.min(wv)||0.01,0.01),wMax=d3.max(wv)||1;
      const sc=d3.scaleLog().domain([wMin,wMax]).range([0.4,4]).clamp(true);
      Es.attr('stroke-width',d=>ST.edgeByW?sc(d.weight||1):0.8);
    } else { rebuild(); }
  });

  // sim
  document.getElementById('btn-play').addEventListener('click',()=>{ isRunning=true;if(sim)sim.alpha(0.3).restart(); document.getElementById('btn-play').classList.add('active'); document.getElementById('btn-pause').classList.remove('active'); });
  document.getElementById('btn-pause').addEventListener('click',()=>{ isRunning=false;if(sim)sim.stop(); document.getElementById('btn-pause').classList.add('active'); document.getElementById('btn-play').classList.remove('active'); });
  document.getElementById('btn-heat').addEventListener('click',()=>{ isRunning=true; if(sim)sim.alpha(1).restart(); document.getElementById('btn-play').classList.add('active'); document.getElementById('btn-pause').classList.remove('active'); });
  document.getElementById('btn-reset').addEventListener('click',()=>{ secCharts={}; rebuild(); });
  document.getElementById('btn-fit').addEventListener('click',fitGraph);
  document.getElementById('btn-unpin').addEventListener('click',()=>{ ST.pinned.clear();ND.forEach(d=>{d.fx=null;d.fy=null;});applyPinVis();if(sim)sim.alpha(0.3).restart(); });

  // toolbar
  document.getElementById('tb-select').addEventListener('click',()=>{ST.mode='select';applyMode();});
  document.getElementById('tb-lasso').addEventListener('click',()=>{ST.mode=ST.mode==='lasso'?'select':'lasso';applyMode();});
  document.getElementById('tb-pan').addEventListener('click',()=>{ST.mode='pan';applyMode();});
  document.getElementById('tb-labels').addEventListener('click',()=>{ ST.showLabels=!ST.showLabels; document.getElementById('tog-labels').checked=ST.showLabels; document.getElementById('tb-labels').classList.toggle('active',ST.showLabels); applyLabels(); });
  document.getElementById('tb-png').addEventListener('click',exportPNG);

  // multi panel
  document.getElementById('btn-clear-sel').addEventListener('click',clearSel);
  document.getElementById('btn-focus-sub').addEventListener('click',()=>{ if(!Es||ST.sel.size<2)return; const subEdge=e=>{const s=e.source?.id??e.source,t=e.target?.id??e.target;return ST.sel.has(s)&&ST.sel.has(t);}; Es.classed('dim',e=>!subEdge(e)).classed('hi',subEdge); });
}

// â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setupTabs(){ document.querySelectorAll('.tab').forEach(tab=>{ tab.addEventListener('click',()=>{ const nm=tab.dataset.tab; document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); tab.classList.add('active'); document.getElementById('network-svg').style.display=nm==='network'?'block':'none'; document.getElementById('toolbar').style.display=nm==='network'?'flex':'none'; document.querySelectorAll('.secondary-chart-area').forEach(a=>a.classList.remove('visible')); if(nm!=='network'){document.getElementById('tab-'+nm).classList.add('visible');if(nm==='timeline'){if(secCharts.timeline)secCharts.timeline.destroy();secCharts.timeline=null;renderTimelineChart(RAW.timeline);}if(nm==='degree'){if(secCharts.degree)secCharts.degree.destroy();secCharts.degree=null;renderDegreeChart(RAW.degree_dist);}if(nm==='centrality'){if(secCharts.centrality)secCharts.centrality.destroy();secCharts.centrality=null;renderCentralityChart(RAW.top_nodes);}} }); }); }

// â”€â”€ KEYBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('keydown',ev=>{ if(ev.target.tagName==='INPUT')return; if(ev.key==='Escape'){clearSel();ST.mode='select';applyMode();} if(ev.key==='l'||ev.key==='L'){ST.mode=ST.mode==='lasso'?'select':'lasso';applyMode();} if(ev.key==='p'||ev.key==='P'){ST.mode=ST.mode==='pan'?'select':'pan';applyMode();} if(ev.key==='f'||ev.key==='F')fitGraph(); if(ev.key==='h'||ev.key==='H'){ST.showLabels=!ST.showLabels;document.getElementById('tog-labels').checked=ST.showLabels;document.getElementById('tb-labels').classList.toggle('active',ST.showLabels);applyLabels();} });

// â”€â”€ BOOTSTRAP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(async()=>{
  await loadAll();
  setLoad('Rendering panelsâ€¦',86); await pause(28);
  if(RAW.stats && Object.keys(RAW.stats).length)renderStats(RAW.stats);
  renderCommLegend(RAW.communities); renderTopList(RAW.top_nodes); renderCloud(RAW.keywords);
  renderCommChart(RAW.communities); renderTopChart(RAW.top_nodes);
  setLoad('Building force graphâ€¦',93); await pause(28);
  buildNetwork(RAW.graph_data,ST.opts);
  setupControls(); setupSearch(); setupTabs();
  setLoad('Done',100); await pause(200); hideLd();
})();
</script>
</body>
</html>