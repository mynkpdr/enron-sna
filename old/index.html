<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Enron SNA Dashboard</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Phosphor Icons -->
  <script src="https://unpkg.com/@phosphor-icons/web"></script>

  <!-- React & ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  
  <!-- Babel for in-browser JSX compilation -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    /* Custom Scrollbar */
    .custom-scrollbar::-webkit-scrollbar {
      width: 6px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
      background: transparent;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: #475569;
      border-radius: 10px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background: #64748b;
    }

    /* Animation Utilities (replacing tailwindcss-animate plugin) */
    .animate-in {
      animation: fade-in-up 0.5s ease-out forwards;
    }
    @keyframes fade-in-up {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>
<body class="bg-slate-900 text-slate-200">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef, useMemo } = React;

    // ============================================================================
    // ICON MAPPINGS (Replacing lucide-react with Phosphor Icons for single-file)
    // ============================================================================
    const IconWrapper = ({ icon, size = 24, className = "" }) => (
      <i className={`ph ${icon} ${className}`} style={{ fontSize: size }}></i>
    );
    const Network = (props) => <IconWrapper icon="ph-share-network" {...props} />;
    const BarChart2 = (props) => <IconWrapper icon="ph-chart-bar" {...props} />;
    const Users = (props) => <IconWrapper icon="ph-users" {...props} />;
    const Activity = (props) => <IconWrapper icon="ph-trend-up" {...props} />;
    const Upload = (props) => <IconWrapper icon="ph-upload-simple" {...props} />;
    const Database = (props) => <IconWrapper icon="ph-database" {...props} />;
    const Share2 = (props) => <IconWrapper icon="ph-share-network" {...props} />;
    const Zap = (props) => <IconWrapper icon="ph-lightning" {...props} />;
    const LayoutDashboard = (props) => <IconWrapper icon="ph-squares-four" {...props} />;
    const ChevronRight = (props) => <IconWrapper icon="ph-caret-right" {...props} />;
    const FileJson = (props) => <IconWrapper icon="ph-file-code" {...props} />;

    // ============================================================================
    // MOCK DATA (Simulating the output of the provided Python script)
    // ============================================================================
    const MOCK_STATS = {
      total_emails: 245190, total_nodes: 18450, total_edges: 84320,
      n_communities: 14, density: 0.00049, avg_clustering: 0.4215,
      lcc_nodes: 17200, lcc_edges: 82100,
      date_range_start: "1999-01-04", date_range_end: "2002-07-20"
    };

    const MOCK_TIMELINE = [
      { period: '1999-10', email_count: 500 }, { period: '2000-01', email_count: 1200 },
      { period: '2000-05', email_count: 3400 }, { period: '2000-09', email_count: 8900 },
      { period: '2001-01', email_count: 15400 }, { period: '2001-05', email_count: 22000 },
      { period: '2001-09', email_count: 45000 }, { period: '2001-11', email_count: 65000 },
      { period: '2002-01', email_count: 32000 }, { period: '2002-04', email_count: 5000 }
    ];

    const MOCK_KEYWORDS = [
      { word: "energy", count: 45032 }, { word: "power", count: 38102 },
      { word: "california", count: 29014 }, { word: "gas", count: 25430 },
      { word: "meeting", count: 21000 }, { word: "agreement", count: 18400 },
      { word: "contract", count: 17500 }, { word: "market", count: 16200 },
    ];

    const MOCK_TOP_NODES = [
      { id: "jeff.skilling@enron.com", sent: 4500, received: 12000, unique_contacts: 850, pagerank: 0.015, betweenness: 0.08, community: 1, role: "Executive / Broker" },
      { id: "ken.lay@enron.com", sent: 1200, received: 15000, unique_contacts: 920, pagerank: 0.018, betweenness: 0.06, community: 1, role: "Information Sink" },
      { id: "andrew.fastow@enron.com", sent: 3200, received: 8400, unique_contacts: 410, pagerank: 0.012, betweenness: 0.09, community: 2, role: "Executive / Broker" },
      { id: "louise.kitchen@enron.com", sent: 8400, received: 9200, unique_contacts: 630, pagerank: 0.014, betweenness: 0.07, community: 3, role: "Broadcaster" },
      { id: "sally.beck@enron.com", sent: 5400, received: 6100, unique_contacts: 540, pagerank: 0.011, betweenness: 0.05, community: 4, role: "Connector" },
    ];

    const generateMockGraph = () => {
      const nodes = [];
      const edges = [];
      const roles = ["Regular Employee", "Connector", "Broadcaster", "Information Sink", "Executive / Broker"];
      
      for (let i = 0; i < 200; i++) {
        nodes.push({
          id: `user${i}@enron.com`, label: `user${i}`,
          pagerank: Math.random() * 0.01, betweenness: Math.random() * 0.05,
          community: Math.floor(Math.random() * 8),
          inferred_role: roles[Math.floor(Math.random() * roles.length)],
          weighted_degree: Math.random() * 100
        });
      }
      for (let i = 0; i < 400; i++) {
        const u = Math.floor(Math.random() * 200);
        let v = Math.floor(Math.random() * 200);
        if (Math.random() > 0.5) v = Math.floor(Math.random() * 20); 
        if (u !== v) {
          edges.push({ source: `user${u}@enron.com`, target: `user${v}@enron.com`, weight: Math.random() * 5 });
        }
      }
      MOCK_TOP_NODES.forEach((n, i) => {
        nodes.push({ ...n, label: n.id.split('@')[0], inferred_role: n.role, weighted_degree: 500 });
        for(let j=0; j<15; j++) {
          edges.push({ source: n.id, target: `user${Math.floor(Math.random() * 200)}@enron.com`, weight: 10 });
        }
      });
      return { nodes, edges };
    };
    const MOCK_GRAPH = generateMockGraph();

    const MOCK_COMMUNITIES = [
      { community_id: 1, size: 450, top_members: ["jeff.skilling@enron.com", "ken.lay@enron.com", "greg.whalley@enron.com"] },
      { community_id: 2, size: 320, top_members: ["andrew.fastow@enron.com", "richard.causey@enron.com"] },
      { community_id: 3, size: 280, top_members: ["louise.kitchen@enron.com", "john.lavorato@enron.com"] },
    ];

    // ============================================================================
    // UTILITY COMPONENTS
    // ============================================================================
    const ROLE_COLORS = {
      "Executive / Broker": "bg-red-500/20 text-red-400 border-red-500/30",
      "Information Broker": "bg-purple-500/20 text-purple-400 border-purple-500/30",
      "Broadcaster": "bg-blue-500/20 text-blue-400 border-blue-500/30",
      "Information Sink": "bg-emerald-500/20 text-emerald-400 border-emerald-500/30",
      "Connector": "bg-amber-500/20 text-amber-400 border-amber-500/30",
      "Regular Employee": "bg-gray-500/20 text-gray-400 border-gray-500/30",
      "Unknown": "bg-gray-500/20 text-gray-400 border-gray-500/30"
    };

    const COMM_COLORS = [
      "#ef4444", "#3b82f6", "#10b981", "#f59e0b", "#8b5cf6", 
      "#ec4899", "#06b6d4", "#f97316", "#64748b", "#84cc16"
    ];

    const StatCard = ({ icon: Icon, label, value, subtext }) => (
      <div className="bg-slate-800/50 border border-slate-700 p-5 rounded-xl flex items-center space-x-4">
        <div className="p-3 bg-blue-500/10 rounded-lg text-blue-400">
          <Icon size={24} />
        </div>
        <div>
          <p className="text-slate-400 text-sm font-medium">{label}</p>
          <h3 className="text-2xl font-bold text-slate-100">{value}</h3>
          {subtext && <p className="text-xs text-slate-500 mt-1">{subtext}</p>}
        </div>
      </div>
    );

    // ============================================================================
    // CUSTOM CHARTS
    // ============================================================================
    const TimelineChart = ({ data }) => {
      if (!data || data.length === 0) return null;
      const maxVal = Math.max(...data.map(d => d.email_count));
      
      return (
        <div className="h-64 flex items-end space-x-2 pt-4">
          {data.map((d, i) => {
            const heightPct = Math.max((d.email_count / maxVal) * 100, 2);
            return (
              <div key={i} className="flex-1 flex flex-col items-center group relative">
                <div className="opacity-0 group-hover:opacity-100 absolute -top-10 bg-slate-800 border border-slate-600 px-3 py-1 rounded text-xs text-white whitespace-nowrap transition-opacity z-10 pointer-events-none shadow-lg">
                  {d.period}: {d.email_count.toLocaleString()} emails
                </div>
                <div className="w-full flex justify-center h-full items-end">
                  <div 
                    className="w-full max-w-[20px] bg-gradient-to-t from-blue-600/40 to-blue-400 hover:to-blue-300 rounded-t-sm transition-all duration-300"
                    style={{ height: `${heightPct}%` }}
                  ></div>
                </div>
                <div className="text-[10px] text-slate-500 mt-2 rotate-45 origin-left truncate w-full text-left">
                  {i % Math.ceil(data.length/12) === 0 ? d.period : ''}
                </div>
              </div>
            );
          })}
        </div>
      );
    };

    const KeywordsChart = ({ data }) => {
      if (!data || data.length === 0) return null;
      const maxVal = Math.max(...data.map(d => d.count));
      return (
        <div className="space-y-3 h-64 overflow-y-auto pr-2 custom-scrollbar">
          {data.slice(0, 20).map((d, i) => (
            <div key={i} className="flex items-center text-sm">
              <div className="w-24 text-slate-400 truncate pr-2 text-right">{d.word}</div>
              <div className="flex-1 h-5 bg-slate-800 rounded-full overflow-hidden flex items-center">
                <div 
                  className="h-full bg-indigo-500/60 rounded-full" 
                  style={{ width: `${(d.count / maxVal) * 100}%` }}
                ></div>
              </div>
              <div className="w-16 text-slate-500 text-xs ml-3">{d.count.toLocaleString()}</div>
            </div>
          ))}
        </div>
      );
    };

    // ============================================================================
    // HIGH-PERFORMANCE CANVAS NETWORK GRAPH (Physics Engine)
    // ============================================================================
    const NetworkGraph = ({ data }) => {
      const canvasRef = useRef(null);
      const containerRef = useRef(null);
      const [hoveredNode, setHoveredNode] = useState(null);

      useEffect(() => {
        if (!data || !data.nodes || !data.edges || !canvasRef.current || !containerRef.current) return;
        
        const canvas = canvasRef.current;
        const ctx = canvas.getContext('2d', { alpha: false });
        const { width, height } = containerRef.current.getBoundingClientRect();
        
        const dpr = window.devicePixelRatio || 1;
        canvas.width = width * dpr;
        canvas.height = height * dpr;
        canvas.style.width = `${width}px`;
        canvas.style.height = `${height}px`;
        ctx.scale(dpr, dpr);

        const nodes = data.nodes.map(n => ({
          ...n,
          x: width/2 + (Math.random() - 0.5) * width * 0.5,
          y: height/2 + (Math.random() - 0.5) * height * 0.5,
          vx: 0, vy: 0,
          radius: Math.max(3, Math.min(25, (n.pagerank || 0) * 1500 + 3))
        }));

        const nodeMap = new Map(nodes.map(n => [n.id, n]));
        const edges = data.edges
          .map(e => ({ source: nodeMap.get(e.source), target: nodeMap.get(e.target), weight: e.weight || 1 }))
          .filter(e => e.source && e.target);

        let animationFrameId;
        let isRunning = true;
        
        const REPULSION = 400;
        const SPRING_K = 0.005;
        const SPRING_L = 40;
        const DAMPING = 0.85; 

        let mouseX = 0, mouseY = 0;
        let draggedNode = null;
        let hovered = null;
        
        let transform = { x: 0, y: 0, k: 1 };
        let isPanning = false;
        let panStart = { x: 0, y: 0 };

        const render = () => {
          ctx.fillStyle = '#0f172a';
          ctx.fillRect(0, 0, width, height);

          ctx.save();
          ctx.translate(transform.x, transform.y);
          ctx.scale(transform.k, transform.k);

          if (isRunning) {
            for(let step = 0; step < 2; step++) {
              for (let i = 0; i < nodes.length; i++) {
                const n = nodes[i];
                n.vx += (width/2 - n.x) * 0.001;
                n.vy += (height/2 - n.y) * 0.001;
              }

              for (let i = 0; i < nodes.length; i++) {
                for (let j = i + 1; j < nodes.length; j++) {
                  const dx = nodes[j].x - nodes[i].x;
                  const dy = nodes[j].y - nodes[i].y;
                  let distSq = dx*dx + dy*dy;
                  if (distSq > 0 && distSq < 40000) {
                    const dist = Math.sqrt(distSq);
                    const force = REPULSION / distSq;
                    const fx = (dx / dist) * force;
                    const fy = (dy / dist) * force;
                    nodes[i].vx -= fx; nodes[i].vy -= fy;
                    nodes[j].vx += fx; nodes[j].vy += fy;
                  }
                }
              }

              for (let i = 0; i < edges.length; i++) {
                const e = edges[i];
                const dx = e.target.x - e.source.x;
                const dy = e.target.y - e.source.y;
                const dist = Math.sqrt(dx*dx + dy*dy) || 1;
                const force = (dist - SPRING_L) * SPRING_K;
                const fx = (dx / dist) * force;
                const fy = (dy / dist) * force;
                e.source.vx += fx; e.source.vy += fy;
                e.target.vx -= fx; e.target.vy -= fy;
              }

              let maxV = 0;
              for (let i = 0; i < nodes.length; i++) {
                const n = nodes[i];
                if (n === draggedNode) continue;
                
                n.vx *= DAMPING;
                n.vy *= DAMPING;
                
                const speed = Math.sqrt(n.vx*n.vx + n.vy*n.vy);
                if (speed > 10) {
                  n.vx = (n.vx/speed) * 10;
                  n.vy = (n.vy/speed) * 10;
                }
                
                n.x += n.vx;
                n.y += n.vy;
                maxV = Math.max(maxV, speed);
              }
              
              if (maxV < 0.05) isRunning = false;
            }
          }

          ctx.lineWidth = 0.5 / transform.k;
          ctx.strokeStyle = 'rgba(100, 116, 139, 0.2)';
          ctx.beginPath();
          for (let i = 0; i < edges.length; i++) {
            const e = edges[i];
            if (hovered && (e.source !== hovered && e.target !== hovered)) continue;
            ctx.moveTo(e.source.x, e.source.y);
            ctx.lineTo(e.target.x, e.target.y);
          }
          ctx.stroke();

          if (hovered) {
            ctx.lineWidth = 1.5 / transform.k;
            ctx.strokeStyle = 'rgba(96, 165, 250, 0.6)';
            ctx.beginPath();
            for (let i = 0; i < edges.length; i++) {
              const e = edges[i];
              if (e.source === hovered || e.target === hovered) {
                ctx.moveTo(e.source.x, e.source.y);
                ctx.lineTo(e.target.x, e.target.y);
              }
            }
            ctx.stroke();
          }

          for (let i = 0; i < nodes.length; i++) {
            const n = nodes[i];
            const isHovered = hovered === n;
            const isFaded = hovered && hovered !== n;
            
            ctx.beginPath();
            ctx.arc(n.x, n.y, n.radius, 0, Math.PI * 2);
            
            const colorHex = COMM_COLORS[(n.community || 0) % COMM_COLORS.length];
            ctx.fillStyle = isFaded ? 'rgba(71, 85, 105, 0.3)' : colorHex;
            ctx.fill();
            
            ctx.lineWidth = isHovered ? 2 / transform.k : 1 / transform.k;
            ctx.strokeStyle = isHovered ? '#fff' : '#1e293b';
            ctx.stroke();

            if (isHovered || (n.radius > 10 && !hovered) || transform.k > 2.5) {
              ctx.font = `${isHovered ? 14 : 10}px Inter, sans-serif`;
              ctx.fillStyle = isFaded ? 'rgba(255,255,255,0.1)' : '#cbd5e1';
              ctx.textAlign = 'center';
              ctx.fillText(n.label || n.id, n.x, n.y + n.radius + (isHovered ? 15 : 10) / transform.k);
            }
          }

          ctx.restore();
          animationFrameId = requestAnimationFrame(render);
        };

        render();

        const getPointerPos = (e) => {
          const rect = canvas.getBoundingClientRect();
          return {
            x: (e.clientX - rect.left) / transform.k - transform.x / transform.k,
            y: (e.clientY - rect.top) / transform.k - transform.y / transform.k,
            rawX: e.clientX - rect.left,
            rawY: e.clientY - rect.top
          };
        };

        const handleMouseMove = (e) => {
          const pos = getPointerPos(e);
          mouseX = pos.x; mouseY = pos.y;
          
          if (isPanning) {
            transform.x = pos.rawX - panStart.x;
            transform.y = pos.rawY - panStart.y;
            return;
          }

          if (draggedNode) {
            draggedNode.x = mouseX;
            draggedNode.y = mouseY;
            isRunning = true;
            return;
          }

          let found = null;
          for (let i = nodes.length - 1; i >= 0; i--) {
            const n = nodes[i];
            const dx = mouseX - n.x;
            const dy = mouseY - n.y;
            if (dx*dx + dy*dy < (n.radius + 3)*(n.radius + 3)) {
              found = n;
              break;
            }
          }
          
          if (found !== hovered) {
            hovered = found;
            setHoveredNode(found);
            isRunning = true;
            canvas.style.cursor = found ? 'pointer' : 'default';
          }
        };

        const handleMouseDown = (e) => {
          const pos = getPointerPos(e);
          if (hovered) {
            draggedNode = hovered;
            draggedNode.vx = 0; draggedNode.vy = 0;
          } else {
            isPanning = true;
            panStart = { x: pos.rawX - transform.x, y: pos.rawY - transform.y };
            canvas.style.cursor = 'grabbing';
          }
        };

        const handleMouseUp = () => {
          draggedNode = null;
          isPanning = false;
          if (canvas) canvas.style.cursor = hovered ? 'pointer' : 'default';
        };

        const handleWheel = (e) => {
          e.preventDefault();
          const zoomSensitivity = 0.001;
          const delta = -e.deltaY * zoomSensitivity;
          const newK = Math.max(0.1, Math.min(10, transform.k * Math.exp(delta)));
          
          const rect = canvas.getBoundingClientRect();
          const x = e.clientX - rect.left;
          const y = e.clientY - rect.top;
          
          transform.x = x - (x - transform.x) * (newK / transform.k);
          transform.y = y - (y - transform.y) * (newK / transform.k);
          transform.k = newK;
          isRunning = true;
        };

        canvas.addEventListener('mousemove', handleMouseMove);
        canvas.addEventListener('mousedown', handleMouseDown);
        window.addEventListener('mouseup', handleMouseUp);
        canvas.addEventListener('wheel', handleWheel, { passive: false });

        return () => {
          cancelAnimationFrame(animationFrameId);
          canvas.removeEventListener('mousemove', handleMouseMove);
          canvas.removeEventListener('mousedown', handleMouseDown);
          window.removeEventListener('mouseup', handleMouseUp);
          canvas.removeEventListener('wheel', handleWheel);
        };
      }, [data]);

      return (
        <div ref={containerRef} className="relative w-full h-full bg-slate-950 rounded-xl overflow-hidden border border-slate-800 shadow-2xl">
          <canvas ref={canvasRef} className="absolute inset-0" />
          
          <div className="absolute top-4 left-4 bg-slate-900/80 backdrop-blur border border-slate-700 p-3 rounded-lg pointer-events-none">
            <h3 className="text-white font-semibold text-sm flex items-center gap-2">
              <Network size={16} className="text-blue-400" /> Interaction Graph
            </h3>
            <p className="text-xs text-slate-400 mt-1">Scroll to zoom. Drag to pan or move nodes.</p>
            <p className="text-[10px] text-slate-500 mt-1">{data?.nodes?.length} Nodes, {data?.edges?.length} Edges</p>
          </div>

          {hoveredNode && (
            <div className="absolute bottom-4 left-4 right-4 md:right-auto md:w-80 bg-slate-900/95 backdrop-blur border border-slate-600 p-4 rounded-xl shadow-xl pointer-events-none z-10 transition-all duration-200">
              <div className="flex justify-between items-start mb-2">
                <div>
                  <h4 className="text-slate-100 font-bold truncate">{hoveredNode.label || hoveredNode.id}</h4>
                  <p className="text-xs text-slate-400">{hoveredNode.id}</p>
                </div>
                <span className={`text-[10px] px-2 py-1 rounded-full border ${ROLE_COLORS[hoveredNode.inferred_role] || ROLE_COLORS["Unknown"]}`}>
                  {hoveredNode.inferred_role}
                </span>
              </div>
              
              <div className="grid grid-cols-2 gap-3 mt-4">
                <div className="bg-slate-800 p-2 rounded">
                  <span className="text-[10px] text-slate-500 uppercase">Comm ID</span>
                  <p className="text-sm text-slate-200 font-mono">{hoveredNode.community}</p>
                </div>
                <div className="bg-slate-800 p-2 rounded">
                  <span className="text-[10px] text-slate-500 uppercase">PageRank</span>
                  <p className="text-sm text-slate-200 font-mono">{(hoveredNode.pagerank || 0).toFixed(4)}</p>
                </div>
                <div className="bg-slate-800 p-2 rounded">
                  <span className="text-[10px] text-slate-500 uppercase">Sent</span>
                  <p className="text-sm text-emerald-400 font-mono">{hoveredNode.sent || 0}</p>
                </div>
                <div className="bg-slate-800 p-2 rounded">
                  <span className="text-[10px] text-slate-500 uppercase">Received</span>
                  <p className="text-sm text-rose-400 font-mono">{hoveredNode.received || 0}</p>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    // ============================================================================
    // MAIN DASHBOARD APP
    // ============================================================================
    function App() {
      const [activeTab, setActiveTab] = useState('overview');
      const [data, setData] = useState({
        stats: MOCK_STATS,
        timeline: MOCK_TIMELINE,
        keywords: MOCK_KEYWORDS,
        topNodes: MOCK_TOP_NODES,
        graph: MOCK_GRAPH,
        communities: MOCK_COMMUNITIES
      });
      const [isDataLoaded, setIsDataLoaded] = useState(false);
      const [loadingMsg, setLoadingMsg] = useState('');

      const handleDirectoryUpload = async (e) => {
        const files = e.target.files;
        if (!files.length) return;
        
        setLoadingMsg('Parsing JSON files...');
        const newData = { ...data };
        
        try {
          for (let i = 0; i < files.length; i++) {
            const file = files[i];
            if (!file.name.endsWith('.json')) continue;
            
            const text = await file.text();
            const json = JSON.parse(text);
            
            if (file.name === 'stats.json') newData.stats = json;
            if (file.name === 'timeline.json') newData.timeline = json;
            if (file.name === 'keywords.json') newData.keywords = json;
            if (file.name === 'top_nodes.json') newData.topNodes = json;
            if (file.name === 'graph_data.json') newData.graph = json;
            if (file.name === 'communities.json') newData.communities = json;
          }
          
          setData(newData);
          setIsDataLoaded(true);
          setLoadingMsg('');
        } catch (err) {
          alert("Error parsing files: " + err.message);
          setLoadingMsg('');
        }
      };

      const renderOverview = () => (
        <div className="space-y-6 animate-in">
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <StatCard icon={Database} label="Total Emails Parsed" value={data.stats.total_emails.toLocaleString()} subtext={`${data.stats.date_range_start} to ${data.stats.date_range_end}`} />
            <StatCard icon={Users} label="Graph Nodes (Entities)" value={data.stats.total_nodes.toLocaleString()} subtext={`${data.stats.lcc_nodes.toLocaleString()} in LCC`} />
            <StatCard icon={Share2} label="Graph Edges (Links)" value={data.stats.total_edges.toLocaleString()} subtext={`Density: ${(data.stats.density*100).toFixed(3)}%`} />
            <StatCard icon={Network} label="Identified Communities" value={data.stats.n_communities} subtext={`Avg Clustering: ${data.stats.avg_clustering}`} />
          </div>

          <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div className="lg:col-span-2 bg-slate-800/40 border border-slate-700 rounded-xl p-5 shadow-lg backdrop-blur">
              <h2 className="text-lg font-bold text-slate-100 flex items-center mb-4">
                <Activity className="mr-2 text-indigo-400" size={20}/> Email Volume Timeline
              </h2>
              <TimelineChart data={data.timeline} />
            </div>

            <div className="bg-slate-800/40 border border-slate-700 rounded-xl p-5 shadow-lg backdrop-blur">
              <h2 className="text-lg font-bold text-slate-100 flex items-center mb-4">
                <BarChart2 className="mr-2 text-pink-400" size={20}/> Top Keywords
              </h2>
              <KeywordsChart data={data.keywords} />
            </div>
          </div>
          
          <div className="bg-slate-800/40 border border-slate-700 rounded-xl p-5 shadow-lg backdrop-blur h-96 flex flex-col">
             <div className="flex justify-between items-center mb-4">
                <h2 className="text-lg font-bold text-slate-100 flex items-center">
                  <Zap className="mr-2 text-amber-400" size={20}/> Network Preview (LCC Sample)
                </h2>
                <button onClick={() => setActiveTab('network')} className="text-sm text-blue-400 hover:text-blue-300 flex items-center">
                  Open Fullscreen <ChevronRight size={16} />
                </button>
             </div>
             <div className="flex-1 relative rounded-lg overflow-hidden">
                <NetworkGraph data={data.graph} />
             </div>
          </div>
        </div>
      );

      const renderNodes = () => (
        <div className="bg-slate-800/40 border border-slate-700 rounded-xl overflow-hidden shadow-lg animate-in">
          <div className="p-5 border-b border-slate-700 flex justify-between items-center bg-slate-800/80">
            <h2 className="text-lg font-bold text-slate-100 flex items-center">
              <Users className="mr-2 text-emerald-400" size={20}/> Top Influencers (PageRank)
            </h2>
          </div>
          <div className="overflow-x-auto">
            <table className="w-full text-left text-sm">
              <thead className="bg-slate-900/50 text-slate-400 uppercase text-xs">
                <tr>
                  <th className="px-6 py-4 font-medium">Employee / Node</th>
                  <th className="px-6 py-4 font-medium">Inferred Role</th>
                  <th className="px-6 py-4 font-medium">Sent</th>
                  <th className="px-6 py-4 font-medium">Received</th>
                  <th className="px-6 py-4 font-medium">Contacts</th>
                  <th className="px-6 py-4 font-medium">PageRank</th>
                  <th className="px-6 py-4 font-medium">Community</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-slate-700/50">
                {data.topNodes.map((node, i) => (
                  <tr key={i} className="hover:bg-slate-700/30 transition-colors">
                    <td className="px-6 py-4 font-medium text-slate-200 truncate max-w-[200px]" title={node.id}>
                      {node.id.split('@')[0]}
                    </td>
                    <td className="px-6 py-4">
                      <span className={`px-2.5 py-1 rounded-full text-[10px] font-semibold tracking-wide border ${ROLE_COLORS[node.role] || ROLE_COLORS["Unknown"]}`}>
                        {node.role}
                      </span>
                    </td>
                    <td className="px-6 py-4 text-slate-400">{node.sent.toLocaleString()}</td>
                    <td className="px-6 py-4 text-slate-400">{node.received.toLocaleString()}</td>
                    <td className="px-6 py-4 text-slate-400">{node.unique_contacts}</td>
                    <td className="px-6 py-4 text-slate-300 font-mono">{node.pagerank.toFixed(5)}</td>
                    <td className="px-6 py-4">
                      <span className="flex items-center gap-2">
                        <span className="w-2 h-2 rounded-full" style={{backgroundColor: COMM_COLORS[node.community % COMM_COLORS.length]}}></span>
                        {node.community}
                      </span>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      );

      const renderCommunities = () => (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 animate-in">
          {data.communities.map((comm, i) => (
            <div key={i} className="bg-slate-800/40 border border-slate-700 rounded-xl p-5 shadow-lg hover:border-slate-500 transition-colors">
              <div className="flex justify-between items-center mb-4 border-b border-slate-700 pb-3">
                <h3 className="text-lg font-bold text-slate-100 flex items-center gap-2">
                  <span className="w-3 h-3 rounded-full" style={{backgroundColor: COMM_COLORS[comm.community_id % COMM_COLORS.length]}}></span>
                  Community {comm.community_id}
                </h3>
                <span className="text-xs font-semibold px-2 py-1 bg-slate-700 rounded-md text-slate-300">
                  {comm.size} members
                </span>
              </div>
              <h4 className="text-xs text-slate-500 uppercase tracking-wider mb-3">Key Members</h4>
              <ul className="space-y-2">
                {comm.top_members.map((member, j) => (
                  <li key={j} className="text-sm text-slate-300 flex items-center gap-2 bg-slate-900/50 p-2 rounded">
                    <div className="w-6 h-6 rounded bg-slate-700 flex items-center justify-center text-xs font-bold text-slate-400">
                      {j+1}
                    </div>
                    <span className="truncate">{member.split('@')[0]}</span>
                  </li>
                ))}
              </ul>
            </div>
          ))}
        </div>
      );

      return (
        <div className="min-h-screen bg-slate-900 text-slate-200 font-sans flex flex-col md:flex-row overflow-hidden">
          <nav className="w-full md:w-64 bg-slate-950 border-r border-slate-800 flex flex-col z-20 shrink-0">
            <div className="p-6 border-b border-slate-800">
              <h1 className="text-xl font-bold bg-gradient-to-r from-blue-400 to-indigo-500 bg-clip-text text-transparent flex items-center gap-2">
                <Network className="text-blue-500" />
                Enron SNA
              </h1>
              <p className="text-xs text-slate-500 mt-1">Social Network Analysis</p>
            </div>
            
            <div className="p-4 space-y-2 flex-1 overflow-y-auto custom-scrollbar">
              {[
                { id: 'overview', icon: LayoutDashboard, label: 'Dashboard Overview' },
                { id: 'network', icon: Network, label: 'Interactive Network' },
                { id: 'nodes', icon: Users, label: 'Node Metrics & Roles' },
                { id: 'communities', icon: Database, label: 'Communities (Louvain)' },
              ].map(item => (
                <button
                  key={item.id}
                  onClick={() => setActiveTab(item.id)}
                  className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all text-sm font-medium
                    ${activeTab === item.id 
                      ? 'bg-blue-600/10 text-blue-400 border border-blue-500/30 shadow-inner' 
                      : 'text-slate-400 hover:bg-slate-800 hover:text-slate-200 border border-transparent'}`}
                >
                  <item.icon size={18} /> {item.label}
                </button>
              ))}
            </div>

            <div className="p-4 m-4 bg-slate-800/50 border border-slate-700 border-dashed rounded-xl text-center">
              <label className="cursor-pointer block group">
                <div className="bg-slate-900 p-3 rounded-full w-12 h-12 flex items-center justify-center mx-auto mb-2 group-hover:bg-blue-600/20 group-hover:text-blue-400 transition-colors text-slate-500">
                  <Upload size={20} />
                </div>
                <span className="text-sm font-semibold text-slate-300 block mb-1">Load Custom Output</span>
                <span className="text-[10px] text-slate-500 px-2 block">
                  Select your <code className="text-amber-500/70">sna_output</code> folder containing the 7 JSON files.
                </span>
                <input 
                  type="file" 
                  webkitdirectory="" 
                  directory="" 
                  multiple 
                  className="hidden" 
                  onChange={handleDirectoryUpload}
                  accept=".json"
                  /* Automatically open /sna_output/ as default if possible */
                  ref={input => {
                    if (input && !window._sna_output_autoloaded) {
                      window._sna_output_autoloaded = true;
                      try {
                        // Try to trigger the file picker with /sna_output/ as default
                        // Note: Browsers restrict setting default folder for security reasons
                        // This will only work if user has previously granted access
                        // Otherwise, fallback to manual selection
                        input.webkitdirectory = true;
                        input.directory = true;
                        // Optionally, auto-click to prompt user
                        // input.click();
                      } catch (e) {}
                    }
                  }}
                />
              </label>
            </div>
          </nav>

          <main className="flex-1 flex flex-col h-screen overflow-hidden relative">
            <header className="h-16 border-b border-slate-800 bg-slate-900/50 backdrop-blur-md flex items-center justify-between px-6 z-10">
              <div className="flex items-center gap-3">
                <h2 className="text-lg font-semibold capitalize text-slate-100">
                  {activeTab.replace('-', ' ')}
                </h2>
                {!isDataLoaded && (
                  <span className="px-2 py-0.5 rounded text-[10px] uppercase font-bold bg-amber-500/20 text-amber-400 border border-amber-500/30 flex items-center gap-1">
                    <FileJson size={10} /> Preview Data
                  </span>
                )}
                {isDataLoaded && (
                  <span className="px-2 py-0.5 rounded text-[10px] uppercase font-bold bg-emerald-500/20 text-emerald-400 border border-emerald-500/30 flex items-center gap-1">
                    <FileJson size={10} /> Custom Data Loaded
                  </span>
                )}
              </div>
              {loadingMsg && <span className="text-sm text-blue-400 animate-pulse">{loadingMsg}</span>}
            </header>

            <div className="flex-1 overflow-y-auto p-6 relative custom-scrollbar">
              {activeTab === 'overview' && renderOverview()}
              {activeTab === 'nodes' && renderNodes()}
              {activeTab === 'communities' && renderCommunities()}
              
              {activeTab === 'network' && (
                <div className="absolute inset-4 animate-in">
                  <NetworkGraph data={data.graph} />
                </div>
              )}
            </div>
          </main>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>