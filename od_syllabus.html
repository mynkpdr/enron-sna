<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>OD Syllabus Mapping ‚Äî Enron SNA √ó IIMB</title>
  <meta name="description" content="Mapping Enron SNA insights to the OD course outline ‚Äî Power & Politics, Organizational Control, and future org shapes."/>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.9.0/d3.min.js"></script>
  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
    :root{--bg:#05070d;--bg2:#0b0f1a;--bg3:#111827;--border:#1e2a3a;--accent:#00e5ff;
      --accent2:#ff4d6d;--accent3:#a855f7;--amber:#fbbf24;--green:#22c55e;
      --text:#e2e8f0;--muted:#64748b;--font-ui:"Syne",sans-serif;--font-mono:"Space Mono",monospace;}
    html{scroll-behavior:smooth;}
    body{background:var(--bg);color:var(--text);font-family:var(--font-ui);font-size:15px;line-height:1.7;overflow-x:hidden;}

    /* NAV */
    nav{position:fixed;top:0;left:0;right:0;z-index:100;background:rgba(5,7,13,0.92);
      backdrop-filter:blur(16px);border-bottom:1px solid var(--border);padding:0 32px;height:52px;
      display:flex;align-items:center;justify-content:space-between;}
    nav::after{content:"";position:absolute;bottom:0;left:0;right:0;height:1px;
      background:linear-gradient(90deg,transparent,var(--accent3) 40%,var(--accent) 60%,transparent);opacity:0.5;}
    .nav-logo{font-family:var(--font-mono);font-size:13px;color:var(--accent3);letter-spacing:0.13em;text-transform:uppercase;}
    .nav-logo span{color:var(--accent);}
    .nav-links{display:flex;gap:24px;}
    .nav-links a{font-size:12px;color:var(--muted);text-decoration:none;text-transform:uppercase;letter-spacing:0.1em;transition:color 0.2s;}
    .nav-links a:hover{color:var(--accent);}

    /* SECTIONS */
    .section{max-width:1200px;margin:0 auto;padding:100px 32px;}
    .section-label{font-family:var(--font-mono);font-size:11px;color:var(--accent3);text-transform:uppercase;letter-spacing:0.2em;margin-bottom:12px;}
    .section h2{font-size:clamp(1.6rem,3vw,2.4rem);font-weight:700;margin-bottom:16px;line-height:1.25;}
    .section h2 .hl{color:var(--accent);}
    .section h2 .hl2{color:var(--accent3);}
    .section-desc{font-size:15px;color:var(--muted);max-width:700px;margin-bottom:40px;line-height:1.7;}
    .sep{max-width:1200px;margin:0 auto;padding:0 32px;}
    .sep hr{border:none;height:1px;background:linear-gradient(90deg,transparent,var(--border) 20%,var(--border) 80%,transparent);}

    /* HERO */
    .hero{min-height:60vh;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:80px 32px 48px;position:relative;}
    .hero::before{content:"";position:absolute;inset:0;pointer-events:none;
      background:radial-gradient(ellipse 70% 60% at 50% 40%,rgba(168,85,247,0.06) 0%,transparent 70%);}
    .hero h1{font-size:clamp(2rem,4vw,3.2rem);font-weight:800;line-height:1.2;max-width:800px;margin-bottom:16px;}
    .hero h1 .glow{background:linear-gradient(135deg,var(--accent3),var(--accent));-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;}
    .hero-sub{font-size:16px;color:var(--muted);max-width:600px;line-height:1.6;}

    /* SESSION CARDS */
    .session-card{background:var(--bg2);border:1px solid var(--border);border-radius:14px;overflow:hidden;margin-bottom:24px;}
    .session-header{padding:20px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:14px;}
    .session-num{font-family:var(--font-mono);font-size:11px;background:var(--accent3);color:#fff;
      padding:4px 10px;border-radius:8px;text-transform:uppercase;letter-spacing:0.1em;flex-shrink:0;}
    .session-header h3{font-size:16px;font-weight:700;}
    .session-body{padding:24px;}
    .session-body p{font-size:13px;color:var(--muted);line-height:1.7;margin-bottom:16px;}

    /* BROKER TABLE */
    .broker-table{width:100%;border-collapse:collapse;margin-top:16px;font-size:12px;}
    .broker-table th{text-align:left;font-family:var(--font-mono);font-size:10px;color:var(--accent);
      text-transform:uppercase;letter-spacing:0.1em;padding:8px 12px;border-bottom:1px solid var(--border);}
    .broker-table td{padding:8px 12px;border-bottom:1px solid rgba(30,42,58,0.4);color:var(--text);}
    .broker-table tr:hover td{background:rgba(0,229,255,0.03);}
    .broker-table .mono{font-family:var(--font-mono);font-size:11px;}
    .broker-table .tag{font-size:9px;padding:2px 8px;border-radius:8px;display:inline-block;}
    .tag-high{background:rgba(0,229,255,0.1);color:var(--accent);}
    .tag-medium{background:rgba(168,85,247,0.1);color:var(--accent3);}

    /* BRIDGE VIZ */
    #bridge-viz{background:var(--bg3);border:1px solid var(--border);border-radius:12px;overflow:hidden;margin-top:20px;}
    #bridge-svg{width:100%;height:400px;}
    .bridge-controls{padding:12px 16px;border-top:1px solid var(--border);display:flex;gap:8px;flex-wrap:wrap;}
    .bridge-btn{font-family:var(--font-mono);font-size:10px;text-transform:uppercase;letter-spacing:0.07em;
      padding:6px 14px;border:1px solid var(--border);background:var(--bg2);color:var(--muted);
      border-radius:6px;cursor:pointer;transition:all 0.2s;}
    .bridge-btn:hover,.bridge-btn.active{border-color:var(--accent);color:var(--accent);background:rgba(0,229,255,0.05);}

    /* HEATMAP */
    .heatmap-wrap{margin-top:20px;overflow-x:auto;padding-right:24px;}
    #heatmap-svg{min-width:600px;}

    /* ORG SHAPES */
    .shape-wrap{display:flex;gap:20px;margin-top:40px;flex-wrap:wrap;justify-content:center;}
    .shape-card{background:var(--bg2);border:1px solid var(--border);border-radius:14px;padding:24px;
      flex:1;min-width:260px;max-width:350px;text-align:center;cursor:pointer;transition:all 0.3s;}
    .shape-card:hover,.shape-card.active{border-color:var(--accent3);transform:translateY(-3px);}
    .shape-card.active{box-shadow:0 0 30px rgba(168,85,247,0.15);}
    .shape-card h4{font-size:14px;font-weight:700;margin-bottom:8px;}
    .shape-card p{font-size:12px;color:var(--muted);line-height:1.5;}
    .shape-svg-wrap{height:180px;display:flex;align-items:center;justify-content:center;margin-bottom:12px;}
    .shape-svg-wrap svg{width:140px;height:160px;}

    /* INSIGHT BOX */
    .insight-box{padding:16px 20px;background:rgba(0,229,255,0.04);border-left:3px solid var(--accent);
      border-radius:0 10px 10px 0;margin-top:20px;font-size:13px;line-height:1.6;}
    .insight-box.purple{background:rgba(168,85,247,0.04);border-left-color:var(--accent3);}
    .insight-box strong{color:var(--accent);}
    .insight-box.purple strong{color:var(--accent3);}

    /* FOOTER */
    footer{text-align:center;padding:48px 32px;border-top:1px solid var(--border);color:var(--muted);font-size:12px;}
    footer a{color:var(--accent);text-decoration:none;}
    footer a:hover{text-decoration:underline;}

    @media(max-width:768px){.shape-wrap{flex-direction:column;align-items:center;}}
  </style>
</head>
<body>

<nav>
  <div class="nav-logo">OD<span> √ó </span>SNA <span>// Syllabus Map</span></div>
  <div class="nav-links">
    <a href="#session8">Session 8</a>
    <a href="#session10">Session 10</a>
    <a href="#shapes">Org Shapes</a>
    <a href="learning_module.html">Learning Module</a>
    <a href="index.html">Dashboard ‚Üó</a>
  </div>
</nav>

<!-- HERO -->
<section class="hero">
  <h1>Mapping SNA to the <span class="glow">OD Course</span></h1>
  <p class="hero-sub">
    How does Social Network Analysis connect to Organizational Design & Behaviour?
    We align Enron data insights to specific sessions from the IIMB PGP Term 1 OD course.
  </p>
</section>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SESSION 8 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="sep"><hr/></div>
<section class="section" id="session8">
  <div class="section-label">OD Course Alignment</div>
  <h2>Session 8: <span class="hl">Power & Politics</span></h2>
  <p class="section-desc">
    Power in organizations isn't just about titles ‚Äî it's about <strong>information control</strong>.
    A "broker" is someone who sits between otherwise disconnected groups, controlling what information flows and to whom.
  </p>

  <div class="session-card">
    <div class="session-header">
      <span class="session-num">Key Concept</span>
      <h3>Information Brokerage ‚Äî Who Controls the Flow?</h3>
    </div>
    <div class="session-body">
      <p>
        In French & Raven's power framework, <strong>Information Power</strong> is the least visible yet most potent.
        Unlike legitimate or expert power, information power doesn't show up on an org chart. Our SNA reveals it through
        <strong>Betweenness Centrality</strong> ‚Äî the fraction of shortest paths that pass through a person.
      </p>
      <p>
        Below: the top 10 information brokers at Enron. Notice how some have low email volumes but sit at critical junctions.
        Click any broker to see which communities they bridge.
      </p>

      <table class="broker-table" id="broker-table">
        <thead>
          <tr><th>#</th><th>Person</th><th>Betweenness</th><th>PageRank</th><th>Sent</th><th>Received</th><th>Contacts</th><th>Power Level</th></tr>
        </thead>
        <tbody id="broker-table-body"></tbody>
      </table>

      <div class="insight-box">
        <strong>Key insight:</strong> Jeff Skilling (CEO) had the highest betweenness among named individuals (0.0407) despite sending only 88 emails.
        His structural position made him the single most critical relay point ‚Äî remove him and entire communities would lose connectivity.
        This is exactly French & Raven's <em>information power</em> made visible.
      </div>
    </div>
  </div>

  <div class="session-card">
    <div class="session-header">
      <span class="session-num">Interactive</span>
      <h3>Bridge Visualization ‚Äî Remove the Broker</h3>
    </div>
    <div class="session-body">
      <p>
        Select a broker below to see which communities they connect. Then click <strong>"Remove Broker"</strong> to see how
        the network fragments ‚Äî demonstrating how one person can hold disproportionate informal power.
      </p>
      <div id="bridge-viz">
        <svg id="bridge-svg"></svg>
        <div class="bridge-controls" id="bridge-controls"></div>
      </div>
    </div>
  </div>
</section>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SESSION 10 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="sep"><hr/></div>
<section class="section" id="session10">
  <div class="section-label">OD Course Alignment</div>
  <h2>Session 10: <span class="hl2">Organizational Control</span></h2>
  <p class="section-desc">
    Do employees <em>actually</em> follow the formal control systems? Or do they bypass the hierarchy?
    Mining "digital exhaust" lets managers see the difference between <em>designed</em> and <em>actual</em> behavior.
  </p>

  <div class="session-card">
    <div class="session-header">
      <span class="session-num" style="background:var(--accent2);">Analysis</span>
      <h3>Formal vs. Actual Communication ‚Äî The Bypass Matrix</h3>
    </div>
    <div class="session-body">
      <p>
        The heatmap below compares <strong>expected</strong> communication patterns (based on Enron's known hierarchy) with
        <strong>actual</strong> email flows. Bright cells indicate heavy communication; dark cells indicate silence.
        Look for <em>off-diagonal hotspots</em> ‚Äî these indicate bypasses of the formal control chain.
      </p>
      <div class="heatmap-wrap">
        <svg id="heatmap-svg" width="700" height="400"></svg>
      </div>
      <div class="insight-box purple">
        <strong>What the data reveals:</strong> Several mid-level employees communicated directly with the CEO/Chairman offices,
        bypassing their direct managers entirely. In control theory terms, these are <em>informal feedback loops</em> that the
        formal structure didn't account for ‚Äî exactly the kind of hidden dynamics that AI-powered monitoring can surface.
      </div>
    </div>
  </div>

  <div class="session-card">
    <div class="session-header">
      <span class="session-num" style="background:var(--green);">Key Takeaway</span>
      <h3>Digital Exhaust as a Control Mechanism</h3>
    </div>
    <div class="session-body">
      <p>Traditional control relies on:</p>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin:16px 0;">
        <div style="background:var(--bg3);border-radius:10px;padding:16px;">
          <h4 style="font-size:13px;color:var(--muted);margin-bottom:8px;">üè¢ Formal Controls</h4>
          <ul style="font-size:12px;color:var(--text);list-style:none;">
            <li>‚Ä¢ Reporting hierarchies</li><li>‚Ä¢ KPIs and dashboards</li>
            <li>‚Ä¢ Approval workflows</li><li>‚Ä¢ Job descriptions</li>
          </ul>
        </div>
        <div style="background:var(--bg3);border-radius:10px;padding:16px;">
          <h4 style="font-size:13px;color:var(--accent);margin-bottom:8px;">üîç Digital Exhaust Controls</h4>
          <ul style="font-size:12px;color:var(--text);list-style:none;">
            <li>‚Ä¢ Email network patterns</li><li>‚Ä¢ Communication frequency maps</li>
            <li>‚Ä¢ Bypass detection algorithms</li><li>‚Ä¢ Real-time community detection</li>
          </ul>
        </div>
      </div>
      <p>
        <em>"More you can formalize it or more you can bring it on the table, the better it is for you as a designer.
        Because then the informal is never within your control."</em> ‚Äî SNA makes the informal <strong>visible and measurable</strong>.
      </p>
    </div>
  </div>
</section>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ORG SHAPES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="sep"><hr/></div>
<section class="section" id="shapes">
  <div class="section-label">Future of Organizations</div>
  <h2>The <span class="hl2">Hourglass</span> vs. the <span class="hl">Diamond</span></h2>
  <p class="section-desc">
    AI isn't just trimming the pyramid ‚Äî it might fundamentally reshape it.
    Three competing models for how AI agents reshape organizational structure.
  </p>

  <div class="shape-wrap" id="shape-cards">
    <div class="shape-card" data-shape="pyramid">
      <div class="shape-svg-wrap" id="shape-pyramid"></div>
      <h4>Traditional Pyramid</h4>
      <p>Few leaders at top, many workers at base. Communication flows through middle management layers. The classic model since the industrial age.</p>
    </div>
    <div class="shape-card" data-shape="diamond">
      <div class="shape-svg-wrap" id="shape-diamond"></div>
      <h4>AI Diamond</h4>
      <p>AI replaces lower-level routine tasks. The middle <strong>expands</strong> ‚Äî more people managing AI agents, coordinating workflows, and interfacing with customers. Top stays narrow.</p>
    </div>
    <div class="shape-card" data-shape="hourglass">
      <div class="shape-svg-wrap" id="shape-hourglass"></div>
      <h4>AI Hourglass</h4>
      <p>AI <strong>hollows out</strong> middle management. Senior leaders and front-line workers remain, but the relay layer disappears. Communication connects top to bottom directly via AI systems.</p>
    </div>
  </div>

  <div class="session-card" style="margin-top:32px;">
    <div class="session-header">
      <span class="session-num" style="background:var(--amber);color:#000;">Discussion</span>
      <h3>What Does Enron's Data Suggest?</h3>
    </div>
    <div class="session-body">
      <p>
        Looking at Enron's <em>actual</em> communication patterns through our SNA, we can already see signs of each model:
      </p>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px;margin:16px 0;">
        <div style="background:var(--bg3);border-radius:10px;padding:14px;border-left:3px solid var(--accent2);">
          <h4 style="font-size:12px;color:var(--accent2);margin-bottom:6px;">Hourglass Evidence</h4>
          <p style="font-size:12px;color:var(--muted);line-height:1.5;">
            CEOs (Lay, Skilling) received emails directly from mid-level employees who bypassed their VP.
            The "middle" was already being hollowed out by informal communication.
          </p>
        </div>
        <div style="background:var(--bg3);border-radius:10px;padding:14px;border-left:3px solid var(--accent);">
          <h4 style="font-size:12px;color:var(--accent);margin-bottom:6px;">Diamond Evidence</h4>
          <p style="font-size:12px;color:var(--muted);line-height:1.5;">
            The largest communities (71 and 69 members) were dominated by middle managers who coordinated
            across departments ‚Äî suggesting an expanded coordination layer.
          </p>
        </div>
        <div style="background:var(--bg3);border-radius:10px;padding:14px;border-left:3px solid var(--amber);">
          <h4 style="font-size:12px;color:var(--amber);margin-bottom:6px;">Span of Control</h4>
          <p style="font-size:12px;color:var(--muted);line-height:1.5;">
            Traditional limit: 5‚Äì10 direct reports. In Enron's email network, some managers had 400+ unique contacts.
            AI agents could scale this to thousands ‚Äî fundamentally altering the pyramid.
          </p>
        </div>
      </div>
      <div class="insight-box">
        <strong>Prof. Sourav's question:</strong> <em>"Are we talking of a diamond-shaped hierarchy coming up? Or is it that
        the middle management is going to disappear ‚Äî in that case you will have an hourglass?"</em>
        The answer may depend on the industry. Knowledge work ‚Üí hourglass. Service coordination ‚Üí diamond.
      </div>
    </div>
  </div>
</section>

<footer>
  <p>OD Syllabus Mapping ¬∑ Built for PGP Term 1 OD Course ¬∑ IIMB</p>
  <p style="margin-top:8px;">
    <a href="learning_module.html">‚Üê Learning Module</a> ¬∑
    <a href="passion_for_learning.html">Passion for Learning ‚Üí</a> ¬∑
    <a href="index.html">Dashboard ‚Üó</a>
  </p>
</footer>

<script>
let graphData, statsData, topNodes;

async function loadData() {
  [graphData, statsData, topNodes] = await Promise.all([
    fetch("sna_output/graph_data.json").then(r=>r.json()),
    fetch("sna_output/stats.json").then(r=>r.json()),
    fetch("sna_output/top_nodes.json").then(r=>r.json()),
  ]);
  initAll();
}

function initAll() {
  renderBrokerTable();
  renderBridgeViz();
  renderHeatmap();
  renderOrgShapes();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê BROKER TABLE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderBrokerTable() {
  const top = graphData.nodes
    .slice().sort((a,b) => b.betweenness - a.betweenness)
    .filter(n => !n.id.includes("outlook.") && !n.id.includes("body."))
    .slice(0,10);

  const tbody = document.getElementById("broker-table-body");
  top.forEach((n,i) => {
    const power = n.betweenness > 0.01 ? "High" : n.betweenness > 0.005 ? "Medium" : "Low";
    const cls = power === "High" ? "tag-high" : "tag-medium";
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="mono">${i+1}</td>
      <td>${n.label}</td>
      <td class="mono">${n.betweenness.toFixed(5)}</td>
      <td class="mono">${n.pagerank.toFixed(5)}</td>
      <td class="mono">${n.sent.toLocaleString()}</td>
      <td class="mono">${n.received.toLocaleString()}</td>
      <td class="mono">${n.unique_contacts}</td>
      <td><span class="tag ${cls}">${power}</span></td>
    `;
    tr.style.cursor = "pointer";
    tr.addEventListener("click", () => highlightBroker(n));
    tbody.appendChild(tr);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê BRIDGE VISUALIZATION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let bridgeNodes, bridgeEdges, bridgeNodeG, bridgeLinkG;
let _bridgeGen = 0; // generation counter to kill stale animations
let _bridgeDragX = null;
let _bridgeSpinning = true;
let _bridgeAngle = 0;
let _bridgeUpdate = null; // current update function

// Named handlers so we don't stack duplicates
function _bridgeMouseMove(e) {
  if (_bridgeDragX === null) return;
  _bridgeAngle += (e.clientX - _bridgeDragX) * 0.005;
  _bridgeDragX = e.clientX;
  if (_bridgeUpdate) _bridgeUpdate();
}
function _bridgeMouseUp() {
  if (_bridgeDragX !== null) {
    _bridgeDragX = null;
    _bridgeSpinning = true;
  }
}
// Install global handlers once
window.addEventListener("mousemove", _bridgeMouseMove);
window.addEventListener("mouseup", _bridgeMouseUp);

function renderBridgeViz() {
  const brokers = graphData.nodes.slice().sort((a,b)=>b.betweenness-a.betweenness)
    .filter(n=>!n.id.includes("outlook.")&&!n.id.includes("body."))
    .slice(0,5);

  const controls = document.getElementById("bridge-controls");
  brokers.forEach((b,i) => {
    const btn = document.createElement("button");
    btn.className = "bridge-btn" + (i===0?" active":"");
    btn.textContent = b.label;
    btn.dataset.id = b.id;
    btn.addEventListener("click", () => {
      controls.querySelectorAll(".bridge-btn:not(.remove-btn)").forEach(x=>x.classList.remove("active"));
      btn.classList.add("active");
      highlightBroker(graphData.nodes.find(n=>n.id===b.id));
    });
    controls.appendChild(btn);
  });

  const rmBtn = document.createElement("button");
  rmBtn.className = "bridge-btn remove-btn";
  rmBtn.textContent = "üóë Remove Broker";
  rmBtn.style.borderColor = "var(--accent2)";
  rmBtn.style.color = "var(--accent2)";
  rmBtn.addEventListener("click", removeBroker);
  controls.appendChild(rmBtn);

  const restoreBtn = document.createElement("button");
  restoreBtn.className = "bridge-btn";
  restoreBtn.textContent = "‚Ü∫ Restore";
  restoreBtn.addEventListener("click", () => buildBridgeGraph());
  controls.appendChild(restoreBtn);

  buildBridgeGraph();
  setTimeout(() => highlightBroker(brokers[0]), 500);
}

function buildBridgeGraph(excludeId) {
  // Kill any running animation from previous build
  _bridgeGen++;
  const myGen = _bridgeGen;
  _bridgeSpinning = true;
  _bridgeDragX = null;

  const top50 = graphData.nodes.slice().sort((a,b)=>b.pagerank-a.pagerank).slice(0,50);
  bridgeNodes = top50.filter(n => n.id !== excludeId).map(n=>({...n}));
  const nodeSet = new Set(bridgeNodes.map(n=>n.id));
  bridgeEdges = graphData.edges
    .filter(e=>nodeSet.has(e.source)&&nodeSet.has(e.target))
    .map(e=>({source:e.source,target:e.target,weight:e.weight}));

  const svg = d3.select("#bridge-svg");
  svg.selectAll("*").remove();
  const width = document.getElementById("bridge-viz").clientWidth;
  const height = 400;
  svg.attr("viewBox", `0 0 ${width} ${height}`);

  // ‚îÄ‚îÄ Glow filter ‚îÄ‚îÄ
  const defs = svg.append("defs");
  const glowF = defs.append("filter").attr("id", "bridge-glow").attr("x", "-50%").attr("y", "-50%").attr("width", "200%").attr("height", "200%");
  glowF.append("feGaussianBlur").attr("stdDeviation", "4").attr("result", "blur");
  glowF.append("feMerge").selectAll("feMergeNode").data(["blur", "SourceGraphic"]).join("feMergeNode").attr("in", d => d);

  // ‚îÄ‚îÄ Community sphere positions ‚îÄ‚îÄ
  const comms = [...new Set(bridgeNodes.map(n => n.community ?? -1))].sort((a,b) => a - b);
  const commIdx = new Map(comms.map((c,i) => [c, i]));
  const nComm = comms.length || 1;
  const commCounts = new Map();
  bridgeNodes.forEach(n => { const c = n.community ?? -1; commCounts.set(c, (commCounts.get(c) || 0) + 1); });
  const GOLDEN = (1 + Math.sqrt(5)) / 2;
  const cx = width / 2, cy = height / 2;
  const sphR = Math.min(width, height) * 0.38;

  // Pre-compute per-node community-local index
  const commLocalIdx = new Map();
  const commCounter = new Map();
  bridgeNodes.forEach(n => {
    const c = n.community ?? -1;
    const idx = commCounter.get(c) || 0;
    commLocalIdx.set(n.id, idx);
    commCounter.set(c, idx + 1);
  });

  function computePositions() {
    bridgeNodes.forEach(n => {
      const c = n.community ?? -1, ci = commIdx.get(c) || 0;
      const localN = commCounts.get(c) || 1;
      const li = commLocalIdx.get(n.id) || 0;
      const latMin = (ci / nComm) * Math.PI * 0.92 + 0.08 * Math.PI;
      const latMax = ((ci + 1) / nComm) * Math.PI * 0.92 + 0.08 * Math.PI;
      const t = localN > 1 ? (li + 0.5) / localN : 0.5;
      const phi = latMin + t * (latMax - latMin);
      const theta = (2 * Math.PI * li) / GOLDEN + ci * 2.1 + _bridgeAngle;
      n.x = cx + sphR * Math.sin(phi) * Math.cos(theta);
      n.y = cy + sphR * Math.cos(phi);
      n._z = Math.sin(phi) * Math.sin(theta);
    });
  }
  computePositions();

  const commPal = d3.scaleOrdinal().domain(comms)
    .range(["#00e5ff","#a855f7","#ff4d6d","#22c55e","#fbbf24","#f97316","#06b6d4","#ec4899","#84cc16","#6366f1","#14b8a6","#ef4444"]);
  const prScale = d3.scaleSqrt().domain(d3.extent(bridgeNodes,d=>d.pagerank)).range([3,16]);
  const q85 = d3.quantile(bridgeNodes.map(n=>n.pagerank).sort(d3.ascending), 0.85) || 0;

  // Sphere guide
  svg.append("circle").attr("cx", cx).attr("cy", cy).attr("r", sphR)
    .attr("fill", "none").attr("stroke", "rgba(0,229,255,0.05)")
    .attr("stroke-width", 1).attr("stroke-dasharray", "4,4");

  // Edge refs
  const nodeMap = new Map(bridgeNodes.map(n => [n.id, n]));
  const edgeObjs = bridgeEdges.map(e => ({...e, _src: nodeMap.get(e.source), _tgt: nodeMap.get(e.target)}))
    .filter(e => e._src && e._tgt);
  const wv = edgeObjs.map(e => e.weight || 1);
  const wMin = Math.max(d3.min(wv) || 0.01, 0.01), wMax = d3.max(wv) || 1;
  const stSc = d3.scaleLog().domain([wMin, wMax]).range([0.2, 2]).clamp(true);

  bridgeLinkG = svg.append("g");
  const linkSel = bridgeLinkG.selectAll("line").data(edgeObjs).join("line")
    .attr("x1", d => d._src.x).attr("y1", d => d._src.y)
    .attr("x2", d => d._tgt.x).attr("y2", d => d._tgt.y)
    .attr("stroke", "rgba(0,229,255,0.1)")
    .attr("stroke-width", d => stSc(d.weight || 1))
    .attr("stroke-opacity", d => 0.1 + 0.15 * Math.min(1, (d.weight || 1) / (wMax * 0.5)));

  // Nodes (depth sorted)
  bridgeNodes.sort((a,b) => a._z - b._z);
  bridgeNodeG = svg.append("g");
  const ng = bridgeNodeG.selectAll("g").data(bridgeNodes).join("g")
    .attr("transform", d => `translate(${d.x},${d.y})`)
    .style("cursor", "pointer");

  ng.append("circle")
    .attr("r", d => prScale(d.pagerank))
    .attr("fill", d => commPal(d.community))
    .attr("stroke", "rgba(255,255,255,0.12)")
    .attr("stroke-width", 0.8)
    .attr("opacity", d => 0.65 + 0.35 * ((d._z + 1) / 2))
    .attr("filter", d => d.pagerank > q85 ? "url(#bridge-glow)" : null);

  ng.append("text")
    .attr("dy", d => prScale(d.pagerank) + 10)
    .attr("text-anchor", "middle")
    .attr("fill", d => d.pagerank > q85 ? "rgba(226,232,240,0.7)" : "rgba(226,232,240,0)")
    .attr("font-size", "7px")
    .attr("font-family", "Space Mono,monospace")
    .text(d => (d.label || d.id).split("@")[0]);

  // ‚îÄ‚îÄ Update function (shared by spin + drag) ‚îÄ‚îÄ
  function updateViz() {
    computePositions();
    ng.attr("transform", d => `translate(${d.x},${d.y})`)
      .select("circle").attr("opacity", d => 0.65 + 0.35 * ((d._z + 1) / 2));
    linkSel.attr("x1", d => d._src.x).attr("y1", d => d._src.y)
           .attr("x2", d => d._tgt.x).attr("y2", d => d._tgt.y);
  }
  _bridgeUpdate = updateViz;

  // ‚îÄ‚îÄ Auto-rotation (stops if generation changes) ‚îÄ‚îÄ
  function spin() {
    if (myGen !== _bridgeGen) return; // killed by newer build
    if (_bridgeSpinning) {
      _bridgeAngle += 0.003;
      updateViz();
    }
    requestAnimationFrame(spin);
  }
  spin(); // start immediately

  // ‚îÄ‚îÄ Drag to rotate via SVG mousedown ‚îÄ‚îÄ
  svg.node().addEventListener("mousedown", e => {
    if (e.target.closest(".bridge-controls")) return;
    _bridgeDragX = e.clientX;
    _bridgeSpinning = false;
  });
}

function highlightBroker(broker) {
  if (!bridgeNodeG) return;
  const neighbors = new Set();
  bridgeEdges.forEach(e=>{
    const s=typeof e.source==="object"?e.source.id:e.source;
    const t=typeof e.target==="object"?e.target.id:e.target;
    if(s===broker.id) neighbors.add(t);
    if(t===broker.id) neighbors.add(s);
  });

  bridgeNodeG.selectAll("circle")
    .transition().duration(300)
    .attr("opacity",d=>d.id===broker.id||neighbors.has(d.id)?1:0.15)
    .attr("stroke",d=>d.id===broker.id?"#fff":"rgba(255,255,255,0.1)")
    .attr("stroke-width",d=>d.id===broker.id?2.5:0.5);

  bridgeLinkG.selectAll("line")
    .transition().duration(300)
    .attr("stroke",d=>{
      const s=typeof d.source==="object"?d.source.id:d.source;
      const t=typeof d.target==="object"?d.target.id:d.target;
      return(s===broker.id||t===broker.id)?"var(--accent)":"rgba(0,229,255,0.08)";
    })
    .attr("stroke-opacity",d=>{
      const s=typeof d.source==="object"?d.source.id:d.source;
      const t=typeof d.target==="object"?d.target.id:d.target;
      return(s===broker.id||t===broker.id)?0.8:0.03;
    })
    .attr("stroke-width",d=>{
      const s=typeof d.source==="object"?d.source.id:d.source;
      const t=typeof d.target==="object"?d.target.id:d.target;
      return(s===broker.id||t===broker.id)?2:0.3;
    });
}

function removeBroker() {
  const active = document.querySelector(".bridge-btn.active:not(.remove-btn)");
  if (!active) return;
  const id = active.dataset.id;
  buildBridgeGraph(id);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HEATMAP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderHeatmap() {
  const executives = [
    {id:"kenneth.lay@enron.com",label:"K.Lay (Chair)",level:0},
    {id:"jeff.skilling@enron.com",label:"J.Skilling (CEO)",level:1},
    {id:"louise.kitchen@enron.com",label:"L.Kitchen (Pres)",level:2},
    {id:"john.lavorato@enron.com",label:"J.Lavorato (COO)",level:2},
    {id:"sally.beck@enron.com",label:"S.Beck (VP Ops)",level:3},
    {id:"steven.kean@enron.com",label:"S.Kean (VP Gov)",level:2},
    {id:"rick.buy@enron.com",label:"R.Buy (CRO)",level:2},
    {id:"mark.haedicke@enron.com",label:"M.Haedicke (Legal)",level:3},
    {id:"richard.sanders@enron.com",label:"R.Sanders (VP Legal)",level:3},
    {id:"vince.kaminski@enron.com",label:"V.Kaminski (Quant)",level:3},
    {id:"tana.jones@enron.com",label:"T.Jones (Legal Asst)",level:4},
    {id:"kay.mann@enron.com",label:"K.Mann (Legal)",level:4},
    {id:"jeff.dasovich@enron.com",label:"J.Dasovich (Gov Aff)",level:3},
  ];

  // Build matrix from actual edges
  const nodeMap = {};
  graphData.nodes.forEach(n=>nodeMap[n.id]=n);
  const edgeMap = {};
  graphData.edges.forEach(e=>{edgeMap[e.source+"‚Üí"+e.target]=e.weight; edgeMap[e.target+"‚Üí"+e.source]=e.weight;});

  const matrix = [];
  executives.forEach((row,ri) => {
    executives.forEach((col,ci) => {
      if (ri === ci) return;
      const w = edgeMap[row.id+"‚Üí"+col.id] || 0;
      const levelDiff = Math.abs(row.level - col.level);
      const bypass = levelDiff > 1 && w > 10;
      matrix.push({row:ri, col:ci, weight:w, bypass, rowLabel:row.label, colLabel:col.label});
    });
  });

  const svg = d3.select("#heatmap-svg");
  const margin = {top:110,right:20,bottom:20,left:140};
  const cellSize = 40;
  const w = margin.left + cellSize * executives.length + margin.right;
  const h = margin.top + cellSize * executives.length + margin.bottom;
  svg.attr("width",w).attr("height",h).attr("viewBox",`0 0 ${w} ${h}`);

  const maxW = d3.max(matrix, d=>d.weight) || 1;
  const colorScale = d3.scaleSequential(d3.interpolatePlasma).domain([0, Math.sqrt(maxW)]);

  // Row labels
  svg.selectAll(".row-label").data(executives).join("text")
    .attr("class","row-label")
    .attr("x",margin.left-8).attr("y",(d,i)=>margin.top+i*cellSize+cellSize/2+4)
    .attr("text-anchor","end").attr("fill","var(--muted)").attr("font-size","10px")
    .attr("font-family","Space Mono,monospace").text(d=>d.label);

  // Col labels
  svg.selectAll(".col-label").data(executives).join("text")
    .attr("class","col-label")
    .attr("x",(d,i)=>margin.left+i*cellSize+cellSize/2)
    .attr("y",margin.top-8)
    .attr("text-anchor","start").attr("fill","var(--muted)").attr("font-size","10px")
    .attr("font-family","Space Mono,monospace")
    .attr("transform",(d,i)=>`rotate(-55,${margin.left+i*cellSize+cellSize/2},${margin.top-8})`)
    .text(d=>d.label);

  // Cells
  const cells = svg.selectAll(".cell").data(matrix).join("rect")
    .attr("class","cell")
    .attr("x",d=>margin.left+d.col*cellSize+1)
    .attr("y",d=>margin.top+d.row*cellSize+1)
    .attr("width",cellSize-2).attr("height",cellSize-2)
    .attr("rx",3)
    .attr("fill",d=>d.weight===0?"var(--bg3)":colorScale(Math.sqrt(d.weight)))
    .attr("stroke",d=>d.bypass?"var(--accent2)":"none")
    .attr("stroke-width",d=>d.bypass?2:0)
    .style("cursor", "pointer");

  // Tooltip for heatmap
  const hmTT = document.createElement("div");
  hmTT.style.cssText = "position:fixed;background:rgba(10,14,22,0.96);border:1px solid var(--accent);border-radius:8px;padding:8px 12px;pointer-events:none;display:none;font-size:11px;z-index:100;font-family:Space Mono,monospace;color:#e2e8f0;box-shadow:0 0 16px rgba(0,229,255,0.15);";
  document.body.appendChild(hmTT);

  cells.on("mouseenter", (e, d) => {
    hmTT.style.display = "block";
    hmTT.innerHTML = `<div style="color:var(--accent);font-weight:700;">${d.rowLabel} ‚Üí ${d.colLabel}</div>`
      + `<div>Weight: ${d.weight.toFixed(1)} emails</div>`
      + (d.bypass ? `<div style="color:var(--accent2);margin-top:4px;">‚ö† HIERARCHY BYPASS</div>` : "");
  }).on("mousemove", e => {
    hmTT.style.left = (e.clientX + 14) + "px";
    hmTT.style.top = (e.clientY - 10) + "px";
  }).on("mouseleave", () => { hmTT.style.display = "none"; });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ORG SHAPES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderOrgShapes() {
  function drawShape(containerId, type) {
    const wrap = document.getElementById(containerId);
    const svg = d3.select(wrap).append("svg").attr("viewBox","0 0 140 160");

    // Glow filter
    const defs = svg.append("defs");
    const glowF = defs.append("filter").attr("id", `${type}-glow`).attr("x", "-50%").attr("y", "-50%").attr("width", "200%").attr("height", "200%");
    glowF.append("feGaussianBlur").attr("stdDeviation", "3").attr("result", "blur");
    glowF.append("feMerge").selectAll("feMergeNode").data(["blur", "SourceGraphic"]).join("feMergeNode").attr("in", d => d);

    const g = svg.append("g").attr("transform","translate(70,80)");

    const layers = [];
    if (type === "pyramid") {
      layers.push({y:-55,w:24},{y:-25,w:50},{y:5,w:76},{y:35,w:100},{y:55,w:118});
    } else if (type === "diamond") {
      layers.push({y:-55,w:24},{y:-25,w:68},{y:5,w:100},{y:35,w:68},{y:55,w:24});
    } else {
      layers.push({y:-55,w:36},{y:-25,w:76},{y:5,w:28},{y:35,w:76},{y:55,w:36});
    }

    const colors = ["#a855f7","#00e5ff","#00e5ff","#fbbf24","#64748b"];
    const glows = [true, false, false, false, false];

    // Connecting lines between layers
    layers.forEach((l, i) => {
      if (i === 0) return;
      const prev = layers[i - 1];
      // Left line
      g.append("line")
        .attr("x1", -prev.w / 2).attr("y1", prev.y + 2)
        .attr("x2", -l.w / 2).attr("y2", l.y - 12)
        .attr("stroke", "rgba(0,229,255,0.12)").attr("stroke-width", 0.8);
      // Right line
      g.append("line")
        .attr("x1", prev.w / 2).attr("y1", prev.y + 2)
        .attr("x2", l.w / 2).attr("y2", l.y - 12)
        .attr("stroke", "rgba(0,229,255,0.12)").attr("stroke-width", 0.8);
    });

    layers.forEach((l, i) => {
      // Bar with rounded corners and gradient
      g.append("rect")
        .attr("x", -l.w / 2).attr("y", l.y - 10)
        .attr("width", l.w).attr("height", 18)
        .attr("rx", 9).attr("fill", colors[i])
        .attr("opacity", 0.7)
        .attr("filter", glows[i] ? `url(#${type}-glow)` : null);

      // Dot indicators inside the bar
      const dotCount = Math.max(1, Math.round(l.w / 12));
      for (let d = 0; d < dotCount; d++) {
        const dx = -l.w / 2 + 8 + (d * (l.w - 16)) / Math.max(1, dotCount - 1);
        g.append("circle")
          .attr("cx", dotCount === 1 ? 0 : dx).attr("cy", l.y - 1)
          .attr("r", 2).attr("fill", "rgba(255,255,255,0.25)");
      }
    });

    // Labels
    const labels = type==="pyramid"?["CEO","VPs","Directors","Managers","Workers"]:
      type==="diamond"?["CEO","VPs+AI","Expanded","Specialists","AI Agents"]:
      ["CEO","Strategy","AI Layer","Front-line","AI Agents"];
    layers.forEach((l,i)=>{
      g.append("text").attr("x",0).attr("y",l.y+3)
        .attr("text-anchor","middle").attr("fill","var(--text)")
        .attr("font-size","7px").attr("font-weight","600")
        .attr("font-family","Space Mono,monospace")
        .text(labels[i]);
    });
  }

  drawShape("shape-pyramid","pyramid");
  drawShape("shape-diamond","diamond");
  drawShape("shape-hourglass","hourglass");

  // Card click
  document.querySelectorAll(".shape-card").forEach(card=>{
    card.addEventListener("click",()=>{
      document.querySelectorAll(".shape-card").forEach(c=>c.classList.remove("active"));
      card.classList.add("active");
    });
  });
}

loadData();
</script>
</body>
</html>
