<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>Enron SNA ‚Äî Shadow Org Intelligence</title>
    <!-- Inline SVG favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><rect width='64' height='64' rx='12' fill='%23003A70'/><circle cx='20' cy='20' r='6' fill='%23FDB913'/><circle cx='44' cy='20' r='6' fill='%23FDB913'/><circle cx='32' cy='44' r='6' fill='%23FDB913'/><line x1='20' y1='20' x2='44' y2='20' stroke='%23FDB913' stroke-width='3'/><line x1='20' y1='20' x2='32' y2='44' stroke='%23FDB913' stroke-width='3'/><line x1='44' y1='20' x2='32' y2='44' stroke='%23FDB913' stroke-width='3'/></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link
      href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;500;600;700&family=IBM+Plex+Sans:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.9.0/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <style>
      *,
      *::before,
      *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      :root {
        --bg: #06080f;
        --bg2: #0c1018;
        --bg3: #111820;
        --bg4: #181f2a;
        --border: #1a2333;
        --border2: #243044;
        --c1: #00d4ff;
        --c2: #ff3d5a;
        --c3: #b97dff;
        --c4: #ffc13d;
        --c5: #3dff9a;
        --text: #dde4ef;
        --muted: #4a5a72;
        --muted2: #6b7f99;
        --font-mono: "IBM Plex Mono", monospace;
        --font-sans: "IBM Plex Sans", sans-serif;
        --glow-c1: rgba(0, 212, 255, 0.18);
        --glow-c2: rgba(255, 61, 90, 0.18);
      }
      html,
      body {
        background: var(--bg);
        color: var(--text);
        font-family: var(--font-sans);
        font-size: 12px;
        height: 100%;
        overflow: hidden;
        user-select: none;
      }

      /* ‚îÄ‚îÄ SCANLINE OVERLAY ‚îÄ‚îÄ */
      body::after {
        content: "";
        position: fixed;
        inset: 0;
        pointer-events: none;
        background: repeating-linear-gradient(
          0deg,
          transparent,
          transparent 2px,
          rgba(0, 0, 0, 0.08) 2px,
          rgba(0, 0, 0, 0.08) 4px
        );
        z-index: 9999;
      }

      /* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
      #app {
        display: grid;
        grid-template-rows: 52px 1fr;
        grid-template-columns: 270px 1fr 310px;
        height: 100vh;
        overflow: hidden;
        transition: grid-template-columns 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      #app.lc {
        grid-template-columns: 0px 1fr 310px;
      }
      #app.rc {
        grid-template-columns: 270px 1fr 0px;
      }
      #app.bc {
        grid-template-columns: 0px 1fr 0px;
      }

      /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
      header {
        grid-column: 1/-1;
        background: var(--bg2);
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        padding: 0 18px;
        gap: 14px;
        position: relative;
        z-index: 20;
      }
      header::after {
        content: "";
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(
          90deg,
          transparent 0%,
          var(--c1) 25%,
          var(--c3) 60%,
          var(--c2) 80%,
          transparent 100%
        );
        opacity: 0.6;
      }
      .logo {
        font-family: var(--font-mono);
        font-size: 13px;
        color: var(--c1);
        letter-spacing: 0.18em;
        text-transform: uppercase;
        font-weight: 700;
        white-space: nowrap;
      }
      .logo em {
        color: var(--c2);
        font-style: normal;
      }
      .logo small {
        color: var(--muted2);
        font-size: 9px;
        letter-spacing: 0.1em;
        display: block;
        margin-top: 1px;
        font-weight: 400;
      }
      .hstats {
        display: flex;
        gap: 22px;
        margin-left: auto;
        align-items: center;
      }
      .hs {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
      }
      .hs-v {
        font-family: var(--font-mono);
        font-size: 14px;
        color: var(--c1);
        font-weight: 600;
        line-height: 1;
      }
      .hs-l {
        font-size: 9px;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.1em;
        margin-top: 2px;
      }
      .hbtn {
        background: var(--bg3);
        border: 1px solid var(--border2);
        color: var(--muted2);
        font-family: var(--font-mono);
        font-size: 10px;
        padding: 5px 9px;
        border-radius: 3px;
        cursor: pointer;
        transition: all 0.15s;
      }
      .hbtn:hover {
        border-color: var(--c1);
        color: var(--c1);
      }

      /* Header center GitHub link */
      .header-center {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        z-index: 25;
        pointer-events: auto;
      }
      .header-center a {
        color: var(--c1);
        display: inline-flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
        font-family: var(--font-mono);
        font-size: 12px;
        font-weight: 600;
      }
      .header-center svg {
        width: 18px;
        height: 18px;
        display: block;
        fill: currentColor;
      }

      /* ‚îÄ‚îÄ SIDEBARS ‚îÄ‚îÄ */
      #sl,
      #sr {
        background: var(--bg2);
        overflow-y: auto;
        overflow-x: hidden;
        display: flex;
        flex-direction: column;
      }
      #sl {
        border-right: 1px solid var(--border);
      }
      #sr {
        border-left: 1px solid var(--border);
      }
      #sl.collapsed > *,
      #sr.collapsed > * {
        display: none;
      }
      #sl.collapsed {
        border-right: none;
      }
      #sr.collapsed {
        border-left: none;
      }
      ::-webkit-scrollbar {
        width: 2px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: var(--border2);
        border-radius: 1px;
      }

      /* ‚îÄ‚îÄ PANEL PRIMITIVES ‚îÄ‚îÄ */
      .ps {
        border-bottom: 1px solid var(--border);
        padding: 12px 13px;
      }
      .pt {
        font-size: 9px;
        color: var(--c1);
        text-transform: uppercase;
        letter-spacing: 0.18em;
        margin-bottom: 9px;
        display: flex;
        align-items: center;
        gap: 6px;
        font-weight: 600;
      }
      .pt::before {
        content: "";
        width: 4px;
        height: 4px;
        background: currentColor;
        border-radius: 50%;
        box-shadow: 0 0 5px currentColor;
        flex-shrink: 0;
      }
      .pt.amber {
        color: var(--c4);
      }
      .pt.purple {
        color: var(--c3);
      }
      .pt.red {
        color: var(--c2);
      }
      .pt.green {
        color: var(--c5);
      }

      label {
        font-size: 10px;
        color: var(--muted2);
        display: block;
        margin-bottom: 3px;
      }
      input[type="range"] {
        -webkit-appearance: none;
        appearance: none;
        width: 100%;
        height: 2px;
        background: var(--border2);
        border-radius: 1px;
        outline: none;
        margin: 4px 0 10px;
        cursor: pointer;
      }
      input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 11px;
        height: 11px;
        background: var(--c1);
        border-radius: 50%;
        box-shadow: 0 0 6px rgba(0, 212, 255, 0.6);
      }
      .sv {
        font-family: var(--font-mono);
        font-size: 10px;
        color: var(--text);
        float: right;
      }
      select {
        width: 100%;
        background: var(--bg3);
        border: 1px solid var(--border2);
        color: var(--text);
        padding: 5px 8px;
        font-family: var(--font-sans);
        font-size: 10px;
        border-radius: 3px;
        margin-bottom: 8px;
        cursor: pointer;
        outline: none;
      }
      select:focus {
        border-color: var(--c1);
      }
      .br {
        display: flex;
        gap: 5px;
        margin-bottom: 6px;
        flex-wrap: wrap;
      }
      .btn {
        flex: 1;
        min-width: 44px;
        padding: 5px 7px;
        font-family: var(--font-mono);
        font-size: 9px;
        text-transform: uppercase;
        letter-spacing: 0.07em;
        border: 1px solid var(--border2);
        background: var(--bg3);
        color: var(--muted2);
        border-radius: 3px;
        cursor: pointer;
        transition: all 0.15s;
        white-space: nowrap;
      }
      .btn:hover,
      .btn.active {
        border-color: var(--c1);
        color: var(--c1);
        background: rgba(0, 212, 255, 0.05);
      }
      .btn.r:hover,
      .btn.r.active {
        border-color: var(--c2);
        color: var(--c2);
        background: rgba(255, 61, 90, 0.05);
      }
      .tr-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 8px;
      }
      .tr-l {
        font-size: 9px;
        color: var(--muted2);
      }
      .ts {
        position: relative;
        width: 30px;
        height: 16px;
        cursor: pointer;
        flex-shrink: 0;
      }
      .ts input {
        opacity: 0;
        width: 0;
        height: 0;
        position: absolute;
      }
      .tt {
        position: absolute;
        inset: 0;
        background: var(--border2);
        border-radius: 8px;
        transition: background 0.18s;
      }
      .ts input:checked + .tt {
        background: var(--c1);
      }
      .tk {
        position: absolute;
        top: 2px;
        left: 2px;
        width: 12px;
        height: 12px;
        background: #fff;
        border-radius: 50%;
        transition: transform 0.18s;
        pointer-events: none;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
      }
      .ts input:checked ~ .tk {
        transform: translateX(14px);
      }
      .sw {
        position: relative;
        margin-bottom: 8px;
      }
      .sw input {
        width: 100%;
        background: var(--bg3);
        border: 1px solid var(--border2);
        color: var(--text);
        padding: 5px 24px 5px 8px;
        font-family: var(--font-mono);
        font-size: 9px;
        border-radius: 3px;
        outline: none;
      }
      .sw input:focus {
        border-color: var(--c1);
      }
      .sw input::placeholder {
        color: var(--muted);
      }
      .si {
        position: absolute;
        right: 7px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--muted);
        pointer-events: none;
        font-size: 10px;
      }
      .sr2 {
        background: var(--bg3);
        border: 1px solid var(--border2);
        border-radius: 3px;
        max-height: 140px;
        overflow-y: auto;
        display: none;
        margin-top: 2px;
        position: absolute;
        width: 100%;
        z-index: 50;
      }
      .sri {
        padding: 5px 8px;
        font-size: 9px;
        cursor: pointer;
        color: var(--text);
        border-bottom: 1px solid var(--border);
        transition: background 0.1s;
        font-family: var(--font-mono);
      }
      .sri:last-child {
        border-bottom: none;
      }
      .sri:hover {
        background: rgba(0, 212, 255, 0.06);
        color: var(--c1);
      }

      /* ‚îÄ‚îÄ LEGEND ITEMS ‚îÄ‚îÄ */
      .li {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 9px;
        color: var(--muted2);
        margin-bottom: 4px;
        cursor: pointer;
        border-radius: 2px;
        padding: 2px 3px;
        transition: background 0.1s;
      }
      .li.active {
        color: var(--c1);
        background: rgba(0, 212, 255, 0.04);
      }
      .li:hover {
        background: rgba(255, 255, 255, 0.03);
      }
      .ld {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        flex-shrink: 0;
      }
      .lc2 {
        font-family: var(--font-mono);
        font-size: 7px;
        color: var(--muted);
        margin-left: auto;
      }

      /* ‚îÄ‚îÄ TOP LIST ‚îÄ‚îÄ */
      .nli {
        display: flex;
        align-items: center;
        gap: 7px;
        padding: 5px 3px;
        border-bottom: 1px solid rgba(26, 35, 51, 0.4);
        cursor: pointer;
        border-radius: 3px;
        transition: all 0.12s;
      }
      .nli:hover {
        background: rgba(0, 212, 255, 0.04);
        padding-left: 4px;
      }
      .nli.active {
        background: rgba(0, 212, 255, 0.07);
        padding-left: 4px;
      }
      .nr {
        font-family: var(--font-mono);
        font-size: 8px;
        color: var(--muted);
        width: 14px;
        flex-shrink: 0;
      }
      .nn {
        font-size: 9px;
        color: var(--text);
        flex: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .nb {
        font-family: var(--font-mono);
        font-size: 7px;
        padding: 1px 5px;
        border-radius: 6px;
        background: rgba(0, 212, 255, 0.1);
        color: var(--c1);
        white-space: nowrap;
        flex-shrink: 0;
      }
      .pib {
        font-family: var(--font-mono);
        font-size: 8px;
        padding: 1px 5px;
        border-radius: 6px;
        flex-shrink: 0;
        font-weight: 600;
      }

      /* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
      #main {
        position: relative;
        overflow: hidden;
        background: var(--bg);
      }
      #main::before {
        content: "";
        position: absolute;
        inset: 0;
        pointer-events: none;
        background-image:
          radial-gradient(
            circle at 50% 38%,
            rgba(0, 212, 255, 0.025) 0%,
            transparent 60%
          ),
          linear-gradient(rgba(0, 212, 255, 0.02) 1px, transparent 1px),
          linear-gradient(90deg, rgba(0, 212, 255, 0.02) 1px, transparent 1px);
        background-size:
          auto,
          44px 44px,
          44px 44px;
      }
      #nsv {
        width: 100%;
        height: 100%;
        display: block;
        cursor: grab;
      }
      #nsv:active {
        cursor: grabbing;
      }

      /* ‚îÄ‚îÄ TOOLBAR ‚îÄ‚îÄ */
      #tb {
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 3px;
        z-index: 15;
      }
      .tbtn {
        padding: 5px 11px;
        font-size: 9px;
        font-family: var(--font-mono);
        text-transform: uppercase;
        letter-spacing: 0.08em;
        background: rgba(8, 12, 20, 0.9);
        border: 1px solid var(--border2);
        color: var(--muted2);
        border-radius: 3px;
        cursor: pointer;
        backdrop-filter: blur(12px);
        transition: all 0.15s;
        white-space: nowrap;
      }
      .tbtn:hover {
        border-color: var(--c1);
        color: var(--c1);
      }
      .tbtn.active {
        border-color: var(--c1);
        color: var(--c1);
        background: rgba(0, 212, 255, 0.07);
      }
      .tbtn.lasso-on {
        border-color: var(--c4) !important;
        color: var(--c4) !important;
      }
      #spath {
        position: absolute;
        top: 46px;
        right: 10px;
        z-index: 15;
        background: rgba(8, 12, 20, 0.95);
        border: 1px solid var(--c3);
        border-radius: 5px;
        padding: 6px 12px;
        font-family: var(--font-mono);
        font-size: 9px;
        color: var(--c3);
        display: none;
        backdrop-filter: blur(12px);
        max-width: 65vw;
        word-wrap: break-word;
        box-shadow: 0 0 20px rgba(185, 125, 255, 0.12);
      }

      /* ‚îÄ‚îÄ TOOLTIP ‚îÄ‚îÄ */
      #ttp {
        position: absolute;
        background: rgba(8, 12, 20, 0.97);
        border: 1px solid var(--c1);
        border-radius: 5px;
        padding: 10px 12px;
        pointer-events: none;
        max-width: 240px;
        z-index: 100;
        display: none;
        box-shadow:
          0 0 24px rgba(0, 212, 255, 0.15),
          0 4px 20px rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(18px);
      }
      .tn {
        font-family: var(--font-mono);
        font-size: 11px;
        color: var(--c1);
        margin-bottom: 5px;
        border-bottom: 1px solid var(--border2);
        padding-bottom: 4px;
        word-break: break-all;
      }
      .tr {
        font-size: 8px;
        padding: 1px 6px;
        border-radius: 6px;
        background: rgba(185, 125, 255, 0.12);
        color: var(--c3);
        border: 1px solid rgba(185, 125, 255, 0.25);
        display: inline-block;
        margin-bottom: 4px;
      }
      .trow {
        display: flex;
        justify-content: space-between;
        font-size: 8px;
        margin-bottom: 2px;
        gap: 8px;
      }
      .tk2 {
        color: var(--muted2);
      }
      .tv {
        color: var(--text);
        font-family: var(--font-mono);
      }
      .th {
        font-size: 7px;
        color: var(--muted);
        margin-top: 4px;
      }
      /* Power bar in tooltip */
      .tpow {
        margin: 5px 0 3px;
      }
      .tpow-lbl {
        font-size: 7px;
        color: var(--muted2);
        margin-bottom: 2px;
        text-transform: uppercase;
        letter-spacing: 0.1em;
      }
      .tpow-bar {
        height: 4px;
        background: var(--border2);
        border-radius: 2px;
        overflow: hidden;
      }
      .tpow-fill {
        height: 100%;
        border-radius: 2px;
        transition: width 0.3s;
      }

      /* ‚îÄ‚îÄ LOADING ‚îÄ‚îÄ */
      #ld {
        position: absolute;
        inset: 0;
        background: var(--bg);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 14px;
        z-index: 200;
      }
      .lring {
        width: 48px;
        height: 48px;
        border: 2px solid var(--border2);
        border-top-color: var(--c1);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .lbar {
        width: 200px;
        height: 2px;
        background: var(--border2);
        border-radius: 1px;
        overflow: hidden;
      }
      .lfill {
        height: 100%;
        background: linear-gradient(90deg, var(--c1), var(--c3));
        border-radius: 1px;
        transition: width 0.25s;
      }
      .ltxt {
        font-family: var(--font-mono);
        font-size: 9px;
        color: var(--muted2);
        letter-spacing: 0.12em;
        text-transform: uppercase;
      }

      /* ‚îÄ‚îÄ KBD HELP ‚îÄ‚îÄ */
      #kh {
        position: fixed;
        inset: 0;
        z-index: 500;
        background: rgba(6, 8, 15, 0.9);
        backdrop-filter: blur(16px);
        display: none;
        align-items: center;
        justify-content: center;
      }
      #kh.v {
        display: flex;
      }
      .kp {
        background: var(--bg2);
        border: 1px solid var(--border2);
        border-radius: 8px;
        padding: 22px 28px;
        max-width: 400px;
        width: 90%;
      }
      .kp h3 {
        font-family: var(--font-mono);
        font-size: 11px;
        color: var(--c1);
        margin-bottom: 12px;
        text-transform: uppercase;
        letter-spacing: 0.14em;
      }
      .kr {
        display: flex;
        justify-content: space-between;
        padding: 5px 0;
        font-size: 10px;
        border-bottom: 1px solid rgba(26, 35, 51, 0.4);
      }
      .kk {
        font-family: var(--font-mono);
        background: var(--bg3);
        border: 1px solid var(--border2);
        border-radius: 3px;
        padding: 2px 7px;
        font-size: 9px;
        color: var(--c1);
      }
      .kd {
        color: var(--muted2);
      }

      /* ‚îÄ‚îÄ SVG CLASSES ‚îÄ‚îÄ */
      .e-base {
        stroke: #2a3f5f;
        stroke-opacity: 0.28;
      }
      .e-base.dim {
        stroke-opacity: 0.03;
      }
      .e-base.hi {
        stroke: var(--c1) !important;
        stroke-opacity: 0.9 !important;
      }
      .ng {
        cursor: pointer;
      }
      .ng.selected circle {
        stroke: #fff !important;
        stroke-width: 2.5 !important;
      }
      .ng.pinned circle {
        stroke: var(--c4) !important;
        stroke-width: 2 !important;
      }
      .nlbl {
        font-family: var(--font-mono);
        font-size: 9px;
        fill: rgba(221, 228, 239, 0.65);
        pointer-events: none;
        text-anchor: middle;
      }
      .nlbl.h {
        display: none;
      }
      #lbox {
        fill: rgba(255, 193, 61, 0.04);
        stroke: var(--c4);
        stroke-width: 1;
        stroke-dasharray: 4 3;
        pointer-events: none;
      }

      /* ‚îÄ‚îÄ RIGHT SIDEBAR ‚îÄ‚îÄ */
      .rtabs {
        display: flex;
        gap: 5px;
        padding: 10px 12px;
        background: var(--bg2);
        border-bottom: 1px solid var(--border);
      }
      .rtab {
        padding: 5px 10px;
        background: var(--bg3);
        border: 1px solid var(--border2);
        color: var(--muted2);
        border-radius: 4px;
        cursor: pointer;
        font-size: 10px;
        font-family: var(--font-mono);
        transition: all 0.15s;
      }
      .rtab.active {
        border-color: var(--c1);
        color: var(--c1);
        background: rgba(0, 212, 255, 0.06);
      }
      .cw {
        padding: 12px;
        border-bottom: 1px solid var(--border);
      }
      .ct {
        font-size: 9px;
        color: var(--c3);
        text-transform: uppercase;
        letter-spacing: 0.14em;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .ct::before {
        content: "";
        width: 4px;
        height: 4px;
        background: var(--c3);
        border-radius: 50%;
        box-shadow: 0 0 5px var(--c3);
        flex-shrink: 0;
      }

      /* ‚îÄ‚îÄ NODE DETAIL ‚îÄ‚îÄ */
      #nd {
        padding: 12px;
        display: none;
        border-bottom: 1px solid var(--border);
      }
      .dname {
        font-family: var(--font-mono);
        font-size: 13px;
        color: var(--c1);
        margin-bottom: 4px;
        word-break: break-all;
      }
      .drole {
        display: inline-block;
        font-size: 8px;
        padding: 2px 8px;
        border-radius: 8px;
        background: rgba(185, 125, 255, 0.12);
        color: var(--c3);
        border: 1px solid rgba(185, 125, 255, 0.25);
        margin-bottom: 10px;
      }
      .mg {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 5px;
        margin-bottom: 10px;
      }
      .mc {
        background: var(--bg3);
        border: 1px solid var(--border);
        border-radius: 4px;
        padding: 7px;
      }
      .mv {
        font-family: var(--font-mono);
        font-size: 13px;
        color: var(--text);
        font-weight: 600;
        line-height: 1;
      }
      .ml {
        font-size: 7px;
        color: var(--muted2);
        text-transform: uppercase;
        letter-spacing: 0.08em;
        margin-top: 2px;
      }
      /* Power Index Big Display */
      .pi-display {
        background: var(--bg3);
        border: 1px solid var(--border2);
        border-radius: 5px;
        padding: 10px;
        margin-bottom: 10px;
        position: relative;
        overflow: hidden;
      }
      .pi-display::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        bottom: 0;
        width: 4px;
        background: linear-gradient(180deg, var(--c1), var(--c3));
      }
      .pi-num {
        font-family: var(--font-mono);
        font-size: 28px;
        font-weight: 700;
        line-height: 1;
        color: var(--c1);
      }
      .pi-lbl {
        font-size: 8px;
        color: var(--muted2);
        text-transform: uppercase;
        letter-spacing: 0.1em;
        margin-top: 2px;
      }
      .pi-bar {
        height: 3px;
        background: var(--border2);
        border-radius: 2px;
        margin-top: 8px;
        overflow: hidden;
      }
      .pi-fill {
        height: 100%;
        border-radius: 2px;
        background: linear-gradient(
          90deg,
          var(--c5),
          var(--c1),
          var(--c3),
          var(--c2)
        );
      }
      /* French & Raven Power Bars */
      .frb {
        margin-bottom: 10px;
      }
      .fr-row {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-bottom: 4px;
      }
      .fr-lbl {
        font-size: 8px;
        color: var(--muted2);
        width: 70px;
        flex-shrink: 0;
        text-transform: uppercase;
        letter-spacing: 0.06em;
      }
      .fr-bar {
        flex: 1;
        height: 5px;
        background: var(--border2);
        border-radius: 3px;
        overflow: hidden;
      }
      .fr-fill {
        height: 100%;
        border-radius: 3px;
        transition: width 0.4s;
      }
      .fr-val {
        font-family: var(--font-mono);
        font-size: 8px;
        color: var(--text);
        width: 16px;
        text-align: right;
        flex-shrink: 0;
      }
      /* Evidence Quotes */
      .eq {
        margin-bottom: 10px;
      }
      .eq-title {
        font-size: 8px;
        color: var(--c4);
        text-transform: uppercase;
        letter-spacing: 0.12em;
        margin-bottom: 6px;
        font-weight: 600;
      }
      .eq-item {
        background: var(--bg3);
        border-left: 2px solid var(--c4);
        border-radius: 0 3px 3px 0;
        padding: 6px 8px;
        margin-bottom: 5px;
        font-size: 9px;
        color: var(--text);
        font-family: var(--font-mono);
        line-height: 1.5;
        word-break: break-word;
      }
      /* Analysis */
      .an-box {
        background: var(--bg3);
        border: 1px solid var(--border2);
        border-radius: 4px;
        padding: 9px;
        margin-bottom: 10px;
      }
      .an-title {
        font-size: 8px;
        color: var(--c3);
        text-transform: uppercase;
        letter-spacing: 0.12em;
        margin-bottom: 5px;
        font-weight: 600;
      }
      .an-text {
        font-size: 9px;
        color: var(--muted2);
        line-height: 1.6;
      }
      /* Neighbours */
      .nt {
        font-size: 8px;
        color: var(--c1);
        text-transform: uppercase;
        letter-spacing: 0.12em;
        margin-bottom: 4px;
      }
      .nlist {
        display: flex;
        flex-direction: column;
        gap: 2px;
        max-height: 100px;
        overflow-y: auto;
      }
      .nitem {
        display: flex;
        justify-content: space-between;
        font-size: 9px;
        font-family: var(--font-mono);
        color: var(--muted2);
        padding: 2px 0;
        cursor: pointer;
        transition: color 0.1s;
      }
      .nitem:hover {
        color: var(--c1);
      }

      /* ‚îÄ‚îÄ MULTI DETAIL ‚îÄ‚îÄ */
      #md {
        padding: 12px;
        display: none;
        border-bottom: 1px solid var(--border);
      }
      .mdt {
        font-size: 9px;
        color: var(--c4);
        margin-bottom: 8px;
        font-family: var(--font-mono);
      }

      /* ‚îÄ‚îÄ CLOUD ‚îÄ‚îÄ */
      #kwc {
        padding: 12px;
      }
      .cwords {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        align-items: center;
      }
      .cw2 {
        font-family: var(--font-mono);
        cursor: default;
        color: var(--text);
        transition: all 0.2s;
        padding: 1px 3px;
        border-radius: 2px;
      }
      .cw2:hover {
        color: var(--c1);
        text-shadow: 0 0 8px var(--c1);
      }

      /* ‚îÄ‚îÄ COMM TABLE ‚îÄ‚îÄ */
      .ctbl {
        width: 100%;
        border-collapse: collapse;
        font-size: 8px;
        font-family: var(--font-mono);
      }
      .ctbl th {
        color: var(--c1);
        text-transform: uppercase;
        letter-spacing: 0.07em;
        font-size: 7px;
        padding: 4px 3px;
        text-align: left;
        border-bottom: 1px solid var(--border);
      }
      .ctbl td {
        padding: 3px;
        color: var(--text);
        border-bottom: 1px solid rgba(26, 35, 51, 0.3);
      }

      /* ‚îÄ‚îÄ POWER DISTRIBUTION PANEL ‚îÄ‚îÄ */
      .pwr-dist {
        display: flex;
        flex-direction: column;
        gap: 3px;
        margin-top: 6px;
      }
      .pwr-tier {
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .pwr-tier-lbl {
        font-size: 8px;
        color: var(--muted2);
        width: 60px;
        flex-shrink: 0;
        font-family: var(--font-mono);
      }
      .pwr-tier-bar {
        flex: 1;
        height: 6px;
        background: var(--border2);
        border-radius: 3px;
        overflow: hidden;
      }
      .pwr-tier-fill {
        height: 100%;
        border-radius: 3px;
      }
      .pwr-tier-cnt {
        font-family: var(--font-mono);
        font-size: 8px;
        color: var(--muted2);
        width: 24px;
        text-align: right;
        flex-shrink: 0;
      }

      /* ‚îÄ‚îÄ COMMUNITY vs POWER TOGGLE ‚îÄ‚îÄ */
      .view-mode-btns {
        display: flex;
        gap: 4px;
        margin-bottom: 8px;
      }
      .vm-btn {
        flex: 1;
        padding: 5px;
        font-family: var(--font-mono);
        font-size: 8px;
        text-transform: uppercase;
        letter-spacing: 0.07em;
        border: 1px solid var(--border2);
        background: var(--bg3);
        color: var(--muted2);
        border-radius: 3px;
        cursor: pointer;
        transition: all 0.15s;
        text-align: center;
      }
      .vm-btn.active {
        border-color: var(--c3);
        color: var(--c3);
        background: rgba(185, 125, 255, 0.07);
      }

      /* Light theme */
      .light {
        --bg: #f4f7fc;
        --bg2: #eaeff7;
        --bg3: #fff;
        --bg4: #e0e7f0;
        --border: #d0daea;
        --border2: #b8c8de;
        --text: #0a1422;
        --muted: #7090b0;
        --muted2: #5570a0;
        --c1: #0078a8;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <!-- HEADER -->
      <header>
        <div class="header-center">
          <a
            href="https://github.com/mynkpdr/enron-sna"
            target="_blank"
            rel="noopener noreferrer"
            title="View source on GitHub"
          >
            <svg
              viewBox="0 0 16 16"
              xmlns="http://www.w3.org/2000/svg"
              aria-hidden="true"
              focusable="false"
            >
              <path
                d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.292 6.532 5.47 7.59.4.074.547-.174.547-.386 0-.19-.007-.693-.01-1.36-2.226.483-2.695-1.073-2.695-1.073-.364-.924-.89-1.17-.89-1.17-.727-.497.055-.487.055-.487.803.057 1.226.825 1.226.825.714 1.223 1.873.87 2.33.665.072-.517.28-.87.509-1.07-1.777-.202-3.644-.888-3.644-3.953 0-.873.312-1.588.824-2.148-.083-.203-.357-1.017.078-2.12 0 0 .672-.215 2.2.82A7.658 7.658 0 018 4.845c.68.003 1.366.092 2.005.27 1.527-1.035 2.198-.82 2.198-.82.437 1.103.163 1.917.08 2.12.513.56.823 1.275.823 2.148 0 3.073-1.87 3.748-3.652 3.947.287.247.543.735.543 1.482 0 1.07-.01 1.93-.01 2.193 0 .214.145.462.55.384C13.71 14.53 16 11.54 16 8c0-4.42-3.58-8-8-8z"
              />
            </svg>
          </a>
        </div>
        <div class="logo">
          ENRON <em>SNA</em
          ><small
            >Shadow Organization Intelligence v2 ¬∑
            <a
              href="https://github.com/mynkpdr/enron-sna"
              target="_blank"
              rel="noopener noreferrer"
              style="color: var(--c1); text-decoration: none"
              >Source</a
            ></small
          >
        </div>
        <div
          style="
            display: flex;
            gap: 6px;
            align-items: center;
            margin-left: 10px;
          "
        >
          <button class="hbtn" id="bcl" title="Collapse left">&lsaquo;</button>
          <button class="hbtn" id="bth" title="Toggle theme">&#9788;</button>
          <button class="hbtn" id="bcr" title="Collapse right">&rsaquo;</button>
        </div>
        <div class="hstats">
          <div class="hs">
            <span class="hs-v" id="s-em">‚Äî</span
            ><span class="hs-l">Emails</span>
          </div>
          <div class="hs">
            <span class="hs-v" id="s-nd">‚Äî</span><span class="hs-l">Nodes</span>
          </div>
          <div class="hs">
            <span class="hs-v" id="s-ed">‚Äî</span><span class="hs-l">Edges</span>
          </div>
          <div class="hs">
            <span class="hs-v" id="s-cm">‚Äî</span
            ><span class="hs-l">Communities</span>
          </div>
          <div class="hs">
            <span class="hs-v" id="s-dn">‚Äî</span
            ><span class="hs-l">Density</span>
          </div>
          <div class="hs">
            <span class="hs-v" id="s-dt">‚Äî</span
            ><span class="hs-l">Period</span>
          </div>
        </div>
      </header>

      <!-- LEFT SIDEBAR -->
      <div id="sl">
        <div class="ps">
          <div class="pt">Search Node</div>
          <div class="sw">
            <input type="text" id="nsrch" placeholder="name or email‚Ä¶" /><span
              class="si"
              >‚åï</span
            >
            <div class="sr2" id="nsr"></div>
          </div>
        </div>
        <div class="ps">
          <div class="pt">Shortest Path</div>
          <label for="pf">From</label>
          <div class="sw">
            <input type="text" id="pf" placeholder="name or email‚Ä¶" /><span
              class="si"
              >‚åï</span
            >
            <div class="sr2" id="pfr"></div>
          </div>
          <label for="pt2">To</label>
          <div class="sw">
            <input type="text" id="pt2" placeholder="name or email‚Ä¶" /><span
              class="si"
              >‚åï</span
            >
            <div class="sr2" id="ptr"></div>
          </div>
          <div class="br" style="margin-bottom: 0">
            <button class="btn" id="bpf">Find Path</button
            ><button class="btn r" id="bpc">Clear</button>
          </div>
        </div>
        <div class="ps">
          <div class="pt">Network Filter</div>
          <label for="sw2">Min Edge Weight<span class="sv" id="wv">8.0</span></label>
          <input type="range" id="sw2" min="0" max="100" value="29" />
          <label for="smn">Max Nodes<span class="sv" id="mnv">500</span></label>
          <input
            type="range"
            id="smn"
            min="20"
            max="500"
            value="500"
            step="10"
          />
          <label for="sdr">Sphere Radius<span class="sv" id="drv">38</span></label>
          <input type="range" id="sdr" min="10" max="60" value="38" step="1" />
          <label for="ssp">Spin Speed<span class="sv" id="spv">15</span></label>
          <input type="range" id="ssp" min="0" max="20" value="15" step="1" />
        </div>
        <div class="ps">
          <div class="pt">Visual Encoding</div>
          <div class="view-mode-btns">
            <div
              class="vm-btn active"
              id="vm-comm"
              title="Color by community clusters"
            >
              Community View
            </div>
            <div class="vm-btn" id="vm-power" title="Color by LLM power index">
              Power View
            </div>
            <div
              class="vm-btn"
              id="vm-role"
              title="Color by inferred informal role"
            >
              Role View
            </div>
          </div>
          <label for="ssz">Node Size by</label>
          <select id="ssz">
            <option value="pagerank">PageRank</option>
            <option value="power_index">LLM Power Index</option>
            <option value="betweenness">Betweenness Centrality</option>
            <option value="weighted_degree">Weighted Degree</option>
            <option value="unique_contacts">Unique Contacts</option>
            <option value="sent">Emails Sent</option>
            <option value="received">Emails Received</option>
          </select>
        </div>
        <div class="ps">
          <div class="pt">Display Options</div>
          <div class="tr-row">
            <span class="tr-l">Show Labels</span
            ><label class="ts"
              ><input type="checkbox" id="tl" />
              <div class="tt"></div>
              <div class="tk"></div
            ></label>
          </div>
          <div class="tr-row">
            <span class="tr-l">Top nodes only</span
            ><label class="ts"
              ><input type="checkbox" id="ttl" checked />
              <div class="tt"></div>
              <div class="tk"></div
            ></label>
          </div>
          <div class="tr-row">
            <span class="tr-l">Show isolated nodes</span
            ><label class="ts"
              ><input type="checkbox" id="tis" />
              <div class="tt"></div>
              <div class="tk"></div
            ></label>
          </div>
          <div class="tr-row">
            <span class="tr-l">Edge width by weight</span
            ><label class="ts"
              ><input type="checkbox" id="tew" checked />
              <div class="tt"></div>
              <div class="tk"></div
            ></label>
          </div>
        </div>
        <div class="ps">
          <div class="pt">View Controls</div>
          <div class="br">
            <button class="btn" id="bpl">‚Üª Spin</button
            ><button class="btn" id="bst">‚è∏ Stop</button>
          </div>
          <div class="br">
            <button class="btn" id="brb">‚Ü∫ Rebuild</button
            ><button class="btn" id="bft">‚ä° Fit</button
            ><button class="btn r" id="bup">Unpin All</button>
          </div>
        </div>
        <div class="ps" id="cp">
          <div class="pt purple">Community Legend</div>
          <div id="cl"></div>
        </div>
        <div class="ps" id="rp" style="display: none">
          <div class="pt">Role Legend</div>
          <div id="rl"></div>
        </div>
        <div class="ps" id="pp" style="display: none">
          <div class="pt red">Power Legend</div>
          <div id="pl"></div>
        </div>
        <div class="ps" id="tp">
          <div class="pt amber" id="ttitle">Top 20 by PageRank</div>
          <div id="tnl"></div>
        </div>
      </div>

      <!-- MAIN -->
      <div id="main">
        <div id="ld">
          <div class="lring"></div>
          <div class="lbar"><div class="lfill" id="lf"></div></div>
          <div class="ltxt" id="lm">Initialising‚Ä¶</div>
        </div>
        <div id="tb">
          <button class="tbtn active" id="tb-sel">‚ò∞ Select</button>
          <button class="tbtn" id="tb-las">‚¨° Lasso</button>
          <button class="tbtn" id="tb-pan">‚ú• Pan</button>
          <button class="tbtn" id="tb-lbl">‚í∂ Labels</button>
          <button class="tbtn" id="tb-ego">üë§ Ego</button>
          <button class="tbtn" id="tb-pth">‚áÑ Path</button>
          <button class="tbtn" id="tb-png">‚¨á PNG</button>
          <button class="tbtn" id="tb-jsn">{ } JSON</button>
          <button class="tbtn" id="tb-hlp">? Help</button>
        </div>
        <div id="spath"></div>
        <svg id="nsv">
          <defs>
            <filter id="gf" x="-50%" y="-50%" width="200%" height="200%">
              <feGaussianBlur stdDeviation="3" result="b" />
              <feMerge>
                <feMergeNode in="b" />
                <feMergeNode in="SourceGraphic" />
              </feMerge>
            </filter>
          </defs>
          <rect id="lbox" display="none" x="0" y="0" width="0" height="0" />
        </svg>
        <div id="ttp"></div>
      </div>

      <!-- RIGHT SIDEBAR -->
      <div id="sr">
        <div class="rtabs">
          <div class="rtab active" id="rt-ov">Overview</div>
          <div class="rtab" id="rt-an">Analytics</div>
          <div class="rtab" id="rt-sl">Selected</div>
        </div>
        <div id="tab-ov">
          <div class="cw">
            <div class="ct">Community Sizes</div>
            <canvas id="chc" height="150"></canvas>
          </div>
          <div class="cw">
            <div class="ct">Power Index Distribution</div>
            <canvas id="chp" height="110"></canvas>
          </div>
          <div class="cw" id="kwc">
            <div class="ct">Subject Keywords</div>
            <div class="cwords" id="kw"></div>
          </div>
        </div>
        <div id="tab-an" style="display: none">
          <div class="cw">
            <div class="ct">Email Volume Timeline</div>
            <canvas id="chtl" height="130"></canvas>
          </div>
          <div class="cw">
            <div class="ct">Degree Distribution (log-log)</div>
            <canvas id="chdd" height="130"></canvas>
          </div>
          <div class="cw">
            <div class="ct">Power Tier Breakdown</div>
            <div id="ptb"></div>
          </div>
          <div class="cw">
            <div class="ct">Community Stats</div>
            <div id="cst"></div>
          </div>
        </div>
        <div id="tab-sl" style="display: none">
          <div id="nd">
            <div class="dname" id="dd-name">‚Äî</div>
            <div class="drole" id="dd-role">‚Äî</div>
            <!-- Power Index -->
            <div class="pi-display">
              <div style="display: flex; align-items: baseline; gap: 10px">
                <div class="pi-num" id="dd-pi">‚Äî</div>
                <div style="flex: 1">
                  <div class="pi-lbl">Overall Power Index (LLM)</div>
                  <div class="pi-bar">
                    <div class="pi-fill" id="dd-pibar" style="width: 0%"></div>
                  </div>
                </div>
              </div>
            </div>
            <!-- Network Metrics Grid -->
            <div class="mg" id="dd-met"></div>
            <!-- French & Raven Power Bases -->
            <div class="frb" id="dd-frb"></div>
            <!-- Evidence Quotes -->
            <div class="eq" id="dd-eq" style="display: none">
              <div class="eq-title">Evidence Quotes</div>
              <div id="dd-quotes"></div>
            </div>
            <!-- LLM Analysis -->
            <div class="an-box" id="dd-an" style="display: none">
              <div class="an-title">Academic Analysis (LLM)</div>
              <div class="an-text" id="dd-analysis"></div>
            </div>
            <div class="nt">Neighbours</div>
            <div
              style="
                display: flex;
                justify-content: space-between;
                padding: 3px 0 6px;
                font-size: 8px;
                color: var(--muted2);
              "
            >
              <span>Contact</span><span>Weight</span>
            </div>
            <div class="nlist" id="dd-nbr"></div>
          </div>
          <div id="md">
            <div class="mdt" id="md-t">0 nodes selected</div>
            <div class="mg" id="md-m"></div>
            <div class="br">
              <button class="btn" id="bfs">‚ä† Only Selected</button
              ><button class="btn r" id="bcs">‚úï Clear</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- KBD HELP -->
    <div id="kh">
      <div class="kp">
        <h3>Keyboard Shortcuts</h3>
        <div class="kr">
          <span class="kd">Lasso mode</span><span class="kk">L</span>
        </div>
        <div class="kr">
          <span class="kd">Pan mode</span><span class="kk">P</span>
        </div>
        <div class="kr">
          <span class="kd">Ego network</span><span class="kk">E</span>
        </div>
        <div class="kr">
          <span class="kd">Rebuild graph</span><span class="kk">R</span>
        </div>
        <div class="kr">
          <span class="kd">Fit to view</span><span class="kk">F</span>
        </div>
        <div class="kr">
          <span class="kd">Toggle labels</span><span class="kk">H</span>
        </div>
        <div class="kr">
          <span class="kd">Clear / Exit</span><span class="kk">Esc</span>
        </div>
        <div class="kr">
          <span class="kd">Multi-select</span
          ><span class="kk">Shift+Click</span>
        </div>
        <div class="kr">
          <span class="kd">Pin / Unpin</span
          ><span class="kk">Double-click</span>
        </div>
        <div class="kr">
          <span class="kd">Shortest path</span
          ><span class="kk">Alt+Click or Path Tool</span>
        </div>
        <div style="text-align: center; margin-top: 12px">
          <button
            class="btn"
            onclick="document.getElementById('kh').classList.remove('v')"
          >
            Close
          </button>
        </div>
      </div>
    </div>

    <script>
      "use strict";
      const FOLDER = "sna_output/";
      const FILEMAP = {
        graph_data: "graph_data.json",
        enriched: "llm_deep_enriched_nodes.json",
        communities: "communities.json",
        keywords: "keywords.json",
        stats: "stats.json",
        timeline: "timeline.json",
        degree_dist: "degree_dist.json",
        top_nodes: "top_nodes.json",
      };

      /* ‚îÄ‚îÄ PALETTE ‚îÄ‚îÄ */
      const CPAL = [
        "#00d4ff",
        "#ff3d5a",
        "#b97dff",
        "#ffc13d",
        "#3dff9a",
        "#f97316",
        "#3b82f6",
        "#ec4899",
        "#84cc16",
        "#06b6d4",
        "#8b5cf6",
        "#ef4444",
        "#10b981",
        "#f59e0b",
        "#6366f1",
        "#e879f9",
        "#34d399",
        "#60a5fa",
      ];
      const RCOL = {
        "Executive / Broker": "#ff3d5a",
        "Information Broker": "#ffc13d",
        Broadcaster: "#b97dff",
        "Information Sink": "#3dff9a",
        Connector: "#00d4ff",
        "Regular Employee": "#4a5a72",
      };
      const cc = (id) => CPAL[((id % CPAL.length) + CPAL.length) % CPAL.length];
      const rc = (r) => RCOL[(r || "").trim()] || "#4a5a72";
      const piColor = (v) => {
        if (v >= 80) return "#ff3d5a";
        if (v >= 60) return "#ffc13d";
        if (v >= 40) return "#3dff9a";
        if (v >= 20) return "#00d4ff";
        return "#4a5a72";
      };
      const frColors = {
        expert: "#00d4ff",
        referent: "#3dff9a",
        legitimate: "#ffc13d",
        coercive: "#ff3d5a",
      };
      const fmt = (n) =>
        n >= 1e6
          ? (n / 1e6).toFixed(1) + "M"
          : n >= 1e3
            ? (n / 1e3).toFixed(0) + "K"
            : "" + n;

      /* ‚îÄ‚îÄ STATE ‚îÄ‚îÄ */
      const ST = {
        showLabels: false,
        topOnly: true,
        showIsolated: false,
        edgeByW: true,
        mode: "select",
        sel: new Set(),
        pinned: new Set(),
        _dragging: false,
        isolate: false,
        egoNode: null,
        colorMode: "community",
        opts: { maxN: 500, minW: 8.0, sz: "pagerank", dist: 38, rep: 15 },
      };
      let RAW = {},
        Ns,
        Es,
        Ls,
        ND = [],
        ED = [],
        q85 = 0,
        isRunning = false;
      let RC = {},
        DT = {};
      let _szSc, _stSc, _getColorFn;

      /* ‚îÄ‚îÄ SPHERE GLOBALS ‚îÄ‚îÄ */
      let SPHERE_ROT = [
        [1, 0, 0],
        [0, 1, 0],
        [0, 0, 1],
      ];
      let _sphR = 300,
        _sphCx = 0,
        _sphCy = 0;
      let _raf = null,
        _autoSpin = false,
        _spinSpeed = 0.015;
      let _dragX0 = 0,
        _dragY0 = 0;

      /* ‚îÄ‚îÄ SPHERE MATH ‚îÄ‚îÄ */
      const matVec = (m, v) => [
        m[0][0] * v[0] + m[0][1] * v[1] + m[0][2] * v[2],
        m[1][0] * v[0] + m[1][1] * v[1] + m[1][2] * v[2],
        m[2][0] * v[0] + m[2][1] * v[1] + m[2][2] * v[2],
      ];
      const matMul = (a, b) =>
        a.map((r, i) =>
          b[0].map((_, j) => r.reduce((s, _, k) => s + a[i][k] * b[k][j], 0)),
        );
      const rotAA = (ax, ay, az, a) => {
        const c = Math.cos(a),
          s = Math.sin(a),
          t = 1 - c;
        return [
          [t * ax * ax + c, t * ax * ay - s * az, t * ax * az + s * ay],
          [t * ax * ay + s * az, t * ay * ay + c, t * ay * az - s * ax],
          [t * ax * az - s * ay, t * ay * az + s * ax, t * az * az + c],
        ];
      };
      const n3 = (v) => {
        const m = Math.hypot(v[0], v[1], v[2]) || 1;
        return [v[0] / m, v[1] / m, v[2] / m];
      };
      const cross3 = (a, b) => [
        a[1] * b[2] - a[2] * b[1],
        a[2] * b[0] - a[0] * b[2],
        a[0] * b[1] - a[1] * b[0],
      ];

      /* ‚îÄ‚îÄ ENRICHED NODE MAP ‚îÄ‚îÄ */
      let ENODE = {};
      function buildEnrichedMap() {
        ENODE = {};
        (RAW.enriched || []).forEach((n) => {
          ENODE[n.email] = n.deep_profile || {};
        });
      }

      /* ‚îÄ‚îÄ LOAD ‚îÄ‚îÄ */
      async function loadAll() {
        const keys = Object.keys(FILEMAP);
        for (let i = 0; i < keys.length; i++) {
          const k = keys[i];
          setLoad(`Loading ${k}.json‚Ä¶`, (i / keys.length) * 80);
          try {
            const r = await fetch(FOLDER + FILEMAP[k]);
            if (!r.ok) throw 0;
            RAW[k] = await r.json();
          } catch {
            RAW[k] =
              k === "graph_data"
                ? { nodes: [], edges: [] }
                : k === "stats"
                  ? {}
                  : [];
          }
          await pause(15);
        }
        buildEnrichedMap();
      }
      const pause = (ms) => new Promise((r) => setTimeout(r, ms));
      function setLoad(m, p) {
        document.getElementById("lm").textContent = m;
        if (p != null) document.getElementById("lf").style.width = p + "%";
      }
      function hideLd() {
        const e = document.getElementById("ld");
        e.style.transition = "opacity .4s";
        e.style.opacity = 0;
        setTimeout(() => (e.style.display = "none"), 420);
      }

      /* ‚îÄ‚îÄ STATS ‚îÄ‚îÄ */
      function renderStats(s) {
        document.getElementById("s-em").textContent = fmt(s.total_emails || 0);
        document.getElementById("s-nd").textContent = fmt(s.total_nodes || 0);
        document.getElementById("s-ed").textContent = fmt(s.total_edges || 0);
        document.getElementById("s-cm").textContent = s.n_communities || "‚Äî";
        document.getElementById("s-dn").textContent = (s.density || 0).toFixed(
          4,
        );
        const a = (s.date_range_start || "").slice(0, 7),
          b = (s.date_range_end || "").slice(0, 7);
        document.getElementById("s-dt").textContent =
          a && b ? `${a}‚Üí${b}` : "‚Äî";
      }

      /* ‚îÄ‚îÄ COMMUNITY LEGEND ‚îÄ‚îÄ */
      function renderCommLegend(comms) {
        const el = document.getElementById("cl");
        el.innerHTML = "";
        (comms || []).slice(0, 12).forEach((c) => {
          const d = document.createElement("div");
          d.className = "li";
          d.innerHTML = `<div class="ld" style="background:${cc(c.community_id)}"></div>Comm. ${c.community_id} <span class="lc2">${c.size}</span>`;
          d.onclick = () => selComm(c.community_id);
          el.appendChild(d);
        });
      }
      function renderRoleLegend() {
        const el = document.getElementById("rl");
        el.innerHTML = "";
        Object.keys(RCOL).forEach((r) => {
          const d = document.createElement("div");
          d.className = "li";
          d.innerHTML = `<div class="ld" style="background:${rc(r)}"></div>${r}`;
          d.onclick = () => selRole(r);
          el.appendChild(d);
        });
      }
      function renderPowerLegend() {
        const el = document.getElementById("pl");
        el.innerHTML = "";
        [
          { lbl: "Elite (80-100)", col: "#ff3d5a", min: 80 },
          { lbl: "Senior (60-79)", col: "#ffc13d", min: 60 },
          { lbl: "Mid (40-59)", col: "#3dff9a", min: 40 },
          { lbl: "Junior (20-39)", col: "#00d4ff", min: 20 },
          { lbl: "Staff (0-19)", col: "#4a5a72", min: 0 },
        ].forEach((t) => {
          const d = document.createElement("div");
          d.className = "li";
          d.innerHTML = `<div class="ld" style="background:${t.col}"></div>${t.lbl}`;
          d.onclick = () => selPowerTier(t.min, t.min + 19);
          el.appendChild(d);
        });
      }
      function selComm(cid) {
        ST.sel.clear();
        ND.forEach((n) => {
          if (n.community === cid) ST.sel.add(n.id);
        });
        applySelVis();
        badge();
        if (ST.sel.size === 1) {
          const s = ND.find((n) => ST.sel.has(n.id));
          if (s) focusNode(s);
        } else if (ST.sel.size > 1) showMulti();
      }
      function selRole(role) {
        ST.sel.clear();
        ND.forEach((n) => {
          if ((n.inferred_role || "").trim() === role.trim()) ST.sel.add(n.id);
        });
        applySelVis();
        badge();
        if (ST.sel.size > 1) showMulti();
      }
      function selPowerTier(mn, mx) {
        ST.sel.clear();
        ND.forEach((n) => {
          const p =
            (ENODE[n.id] || {}).overall_power_index ||
            n.power_level_heuristic * 10 ||
            0;
          if (p >= mn && p <= mx) ST.sel.add(n.id);
        });
        applySelVis();
        badge();
        if (ST.sel.size > 1) showMulti();
      }

      /* ‚îÄ‚îÄ TOP LIST ‚îÄ‚îÄ */
      function renderTopList() {
        const el = document.getElementById("tnl"),
          sel = document.getElementById("ssz");
        const k = ST?.opts?.sz || "pagerank";
        const lbl = sel?.options?.[sel.selectedIndex]?.textContent || k;
        document.getElementById("ttitle").textContent = `Top 20 by ${lbl}`;
        el.innerHTML = "";
        ND.slice()
          .sort((a, b) => (b[k] || 0) - (a[k] || 0))
          .slice(0, 20)
          .forEach((n, i) => {
            const dp = ENODE[n.id] || {};
            const pi =
              dp.overall_power_index || n.power_level_heuristic * 10 || 0;
            const d = document.createElement("div");
            d.className = "nli";
            d.id = "nli-" + n.id;
            const piC = piColor(pi);
            d.innerHTML = `<span class="nr">${i + 1}</span><span class="nn">${n.id.split("@")[0]}</span><span class="nb">${(n.inferred_role || "").split(" ")[0] || "‚Äî"}</span><span class="pib" style="background:${piC}22;color:${piC};border:1px solid ${piC}44">${pi}</span>`;
            d.onclick = () => focusById(n.id);
            el.appendChild(d);
          });
      }

      /* ‚îÄ‚îÄ CLOUD ‚îÄ‚îÄ */
      function renderCloud(kw) {
        const el = document.getElementById("kw");
        el.innerHTML = "";
        if (!kw?.length) return;
        const mx = kw[0].count,
          mn = kw[kw.length - 1].count;
        kw.slice(0, 60).forEach(({ word, count }) => {
          const t = (count - mn) / Math.max(mx - mn, 1),
            s = document.createElement("span");
          s.className = "cw2";
          s.textContent = word;
          s.style.fontSize = 8 + t * 14 + "px";
          s.style.opacity = 0.35 + t * 0.65;
          el.appendChild(s);
        });
      }

      /* ‚îÄ‚îÄ CHARTS ‚îÄ‚îÄ */
      const TTopt = {
        backgroundColor: "#08101a",
        borderColor: "#1a2333",
        borderWidth: 1,
        titleColor: "#00d4ff",
        bodyColor: "#dde4ef",
      };
      function renderCommChart(c) {
        c = (c || []).slice(0, 10);
        const ctx = document.getElementById("chc").getContext("2d");
        if (RC.cm) RC.cm.destroy();
        RC.cm = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: c.map((x) => `C${x.community_id}`),
            datasets: [
              {
                data: c.map((x) => x.size),
                backgroundColor: c.map((x) => cc(x.community_id) + "bb"),
                borderColor: c.map((x) => cc(x.community_id)),
                borderWidth: 1.5,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: { legend: { display: false }, tooltip: TTopt },
          },
        });
      }
      function renderPowerChart() {
        const enriched = RAW.enriched || [];
        if (!enriched.length) return;
        const ctx = document.getElementById("chp").getContext("2d");
        if (RC.pw) RC.pw.destroy();
        // Histogram: bins 0-9,10-19,...,90-100
        const bins = new Array(10).fill(0);
        enriched.forEach((n) => {
          const p = (n.deep_profile || {}).overall_power_index || 0;
          const b = Math.min(9, Math.floor(p / 10));
          bins[b]++;
        });
        const lbls = [
          "0-9",
          "10-19",
          "20-29",
          "30-39",
          "40-49",
          "50-59",
          "60-69",
          "70-79",
          "80-89",
          "90-100",
        ];
        const bColors = bins.map((_, i) =>
          i >= 8
            ? "#ff3d5a"
            : i >= 6
              ? "#ffc13d"
              : i >= 4
                ? "#3dff9a"
                : "#00d4ff",
        );
        RC.pw = new Chart(ctx, {
          type: "bar",
          data: {
            labels: lbls,
            datasets: [
              {
                data: bins,
                backgroundColor: bColors.map((c) => c + "99"),
                borderColor: bColors,
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: { legend: { display: false }, tooltip: TTopt },
            scales: {
              x: {
                ticks: { color: "#4a5a72", font: { size: 7 } },
                grid: { display: false },
              },
              y: {
                ticks: { color: "#4a5a72" },
                grid: { color: "rgba(26,35,51,.5)" },
              },
            },
          },
        });
      }
      function renderTimelineChart(tl) {
        if (!tl?.length) return;
        const ctx = document.getElementById("chtl").getContext("2d");
        if (RC.tl) RC.tl.destroy();
        RC.tl = new Chart(ctx, {
          type: "line",
          data: {
            labels: tl.map((x) => x.period),
            datasets: [
              {
                label: "Emails",
                data: tl.map((x) => x.email_count),
                borderColor: "rgba(0,212,255,.8)",
                backgroundColor: "rgba(0,212,255,.1)",
                fill: true,
                tension: 0.3,
                pointRadius: 2,
                borderWidth: 1.5,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: { legend: { display: false }, tooltip: TTopt },
            scales: {
              x: {
                ticks: { color: "#4a5a72", font: { size: 7 }, maxRotation: 45 },
                grid: { display: false },
              },
              y: {
                ticks: { color: "#4a5a72" },
                grid: { color: "rgba(26,35,51,.5)" },
              },
            },
          },
        });
      }
      function renderDegDistChart(dd) {
        if (!dd?.length) return;
        const ctx = document.getElementById("chdd").getContext("2d");
        if (RC.dd) RC.dd.destroy();
        RC.dd = new Chart(ctx, {
          type: "scatter",
          data: {
            datasets: [
              {
                data: dd
                  .filter((x) => x.degree > 0 && x.count > 0)
                  .map((x) => ({
                    x: Math.log10(x.degree),
                    y: Math.log10(x.count),
                  })),
                backgroundColor: "rgba(185,125,255,.6)",
                pointRadius: 2.5,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: { legend: { display: false }, tooltip: TTopt },
            scales: {
              x: {
                title: {
                  display: true,
                  text: "log‚ÇÅ‚ÇÄ(degree)",
                  color: "#4a5a72",
                  font: { size: 8 },
                },
                ticks: { color: "#4a5a72" },
                grid: { color: "rgba(26,35,51,.5)" },
              },
              y: {
                title: {
                  display: true,
                  text: "log‚ÇÅ‚ÇÄ(count)",
                  color: "#4a5a72",
                  font: { size: 8 },
                },
                ticks: { color: "#4a5a72" },
                grid: { color: "rgba(26,35,51,.5)" },
              },
            },
          },
        });
      }
      function renderPowerTierBreakdown() {
        const el = document.getElementById("ptb");
        if (!el) return;
        const enriched = RAW.enriched || [];
        if (!enriched.length) return;
        const tiers = [
          { lbl: "Elite 80-100", col: "#ff3d5a", min: 80, max: 100 },
          { lbl: "Senior 60-79", col: "#ffc13d", min: 60, max: 79 },
          { lbl: "Mid 40-59", col: "#3dff9a", min: 40, max: 59 },
          { lbl: "Junior 20-39", col: "#00d4ff", min: 20, max: 39 },
          { lbl: "Staff 0-19", col: "#4a5a72", min: 0, max: 19 },
        ];
        const tot = enriched.length;
        el.innerHTML = "";
        const div = document.createElement("div");
        div.className = "pwr-dist";
        tiers.forEach((t) => {
          const cnt = enriched.filter((n) => {
            const p = (n.deep_profile || {}).overall_power_index || 0;
            return p >= t.min && p <= t.max;
          }).length;
          const pct = ((cnt / tot) * 100).toFixed(1);
          div.innerHTML += `<div class="pwr-tier"><span class="pwr-tier-lbl" style="color:${t.col}">${t.lbl}</span><div class="pwr-tier-bar"><div class="pwr-tier-fill" style="width:${pct}%;background:${t.col}88"></div></div><span class="pwr-tier-cnt" style="color:${t.col}">${cnt}</span></div>`;
        });
        el.appendChild(div);
      }
      function renderCommStats(comms) {
        const el = document.getElementById("cst");
        if (!el || !comms?.length) return;
        const rows = (comms || [])
          .slice(0, 12)
          .map(
            (c) =>
              `<tr><td style="color:${cc(c.community_id)}">${c.community_id}</td><td>${c.size}</td><td>${(
                c.top_members || []
              )
                .slice(0, 3)
                .map((m) => m.split("@")[0])
                .join(", ")}</td></tr>`,
          )
          .join("");
        el.innerHTML = `<table class="ctbl"><thead><tr><th>ID</th><th>Size</th><th>Top Members</th></tr></thead><tbody>${rows}</tbody></table>`;
      }

      /* ‚îÄ‚îÄ BUILD NETWORK ‚îÄ‚îÄ */
      function buildNetwork(gd, opts) {
        const { maxN, minW, sz, dist } = opts;
        const svg = d3.select("#nsv");
        const W = svg.node().clientWidth,
          H = svg.node().clientHeight;
        if (_raf) {
          cancelAnimationFrame(_raf);
          _raf = null;
        }
        stopAutoSpin();
        svg.selectAll("g").remove();
        const ZM = d3
          .zoom()
          .scaleExtent([0.3, 4])
          .filter((ev) => ev.type === "wheel" || ev.type === "dblclick")
          .on("zoom", (e) => {
            _sphR = ((Math.min(W, H) * opts.dist) / 100) * e.transform.k;
            drawSphere();
          });
        svg.call(ZM);
        svg.select("#bg-hit").remove();
        svg
          .insert("rect", "#lbox")
          .attr("id", "bg-hit")
          .attr("width", W)
          .attr("height", H)
          .attr("fill", "transparent")
          .on("click", (ev) => {
            if (ST.mode === "select") {
              if (ST._dragging) {
                ST._dragging = false;
                return;
              }
              clearSel();
            }
          });
        const gMain = svg.append("g"),
          gEdges = gMain.append("g"),
          gNodes = gMain.append("g");

        let nodes = [...(gd.nodes || [])]
          .sort((a, b) => b[sz] - a[sz])
          .slice(0, maxN);
        const nids = new Set(nodes.map((n) => n.id));
        const rawEdges = (gd.edges || []).map((e) => ({
          source: e.source?.id ?? e.source,
          target: e.target?.id ?? e.target,
          weight: e.weight || 1,
        }));
        let edges = rawEdges.filter(
          (e) => e.weight >= minW && nids.has(e.source) && nids.has(e.target),
        );
        if (!ST.showIsolated) {
          const con = new Set();
          edges.forEach((e) => {
            con.add(e.source);
            con.add(e.target);
          });
          nodes = nodes.filter((n) => con.has(n.id));
        }
        if (!nodes.length) {
          ND = [];
          ED = [];
          Ns = null;
          Es = null;
          Ls = null;
          return;
        }

        // Merge power index from enriched data into each node
        nodes.forEach((n) => {
          const dp = ENODE[n.id] || {};
          n.power_index =
            dp.overall_power_index || n.power_level_heuristic * 10 || 0;
        });

        ND = nodes;
        ED = edges;

        // Sphere layout
        const communities = [
          ...new Set(nodes.map((n) => n.community ?? -1)),
        ].sort((a, b) => a - b);
        const commIdx = new Map(communities.map((c, i) => [c, i]));
        const nComm = communities.length || 1;
        const commCounts = new Map();
        nodes.forEach((n) => {
          const c = n.community ?? -1;
          commCounts.set(c, (commCounts.get(c) || 0) + 1);
        });
        const commOff = new Map(communities.map((c) => [c, 0]));
        const GOLDEN = (1 + Math.sqrt(5)) / 2;
        nodes.forEach((n) => {
          const c = n.community ?? -1,
            ci = commIdx.get(c) || 0;
          const li = commOff.get(c) || 0;
          commOff.set(c, li + 1);
          const localN = commCounts.get(c) || 1;
          const latMin = (ci / nComm) * Math.PI * 0.92 + 0.08 * Math.PI;
          const latMax = ((ci + 1) / nComm) * Math.PI * 0.92 + 0.08 * Math.PI;
          const t = localN > 1 ? (li + 0.5) / localN : 0.5;
          const phi = latMin + t * (latMax - latMin);
          const theta = (2 * Math.PI * li) / GOLDEN + ci * 2.1;
          n._sx = Math.sin(phi) * Math.cos(theta);
          n._sy = Math.sin(phi) * Math.sin(theta);
          n._sz = Math.cos(phi);
          n._px = 0;
          n._py = 0;
          n._pz = 0;
          n._ps = 1;
        });

        const nodeMap = new Map(nodes.map((n) => [n.id, n]));
        const edgeObjs = edges
          .map((e) => ({
            ...e,
            _src: nodeMap.get(e.source),
            _tgt: nodeMap.get(e.target),
          }))
          .filter((e) => e._src && e._tgt);

        // Scales
        const sv = nodes.map((n) => n[sz] || 0);
        _szSc = d3
          .scaleSqrt()
          .domain([0, d3.max(sv) || 1])
          .range([3, 20]);
        q85 = d3.quantile(sv.slice().sort(d3.ascending), 0.85) || 0;
        const wv = edges.map((e) => e.weight || 1),
          wMin = Math.max(d3.min(wv) || 0.01, 0.01),
          wMax = d3.max(wv) || 1;
        _stSc = d3.scaleLog().domain([wMin, wMax]).range([0.35, 3]).clamp(true);
        _getColorFn = makeColorFn(nodes);

        Es = gEdges
          .selectAll("line.e-base")
          .data(edgeObjs)
          .join("line")
          .attr("class", "e-base")
          .attr("stroke-width", (d) =>
            ST.edgeByW ? _stSc(d.weight || 1) : 0.6,
          );

        const ng = gNodes
          .selectAll("g.ng")
          .data(nodes, (d) => d.id)
          .join("g")
          .attr(
            "class",
            (d) =>
              "ng" +
              (ST.sel.has(d.id) ? " selected" : "") +
              (ST.pinned.has(d.id) ? " pinned" : ""),
          )
          .on("click", (ev, d) => {
            ev.stopPropagation();
            if (ST.mode !== "select") return;
            if (
              ev.altKey ||
              document.getElementById("tb-pth").classList.contains("active")
            ) {
              if (!PATH_START) {
                PATH_START = d.id;
                showPathBadge(
                  `<span style="color:var(--c4)">‚áÑ Path from:</span> <b style="color:var(--c1)">${d.id.split("@")[0]}</b> <span style="color:var(--muted2);font-size:8px">‚Äî click target node</span>`,
                );
              } else {
                showPathBetween(PATH_START, d.id);
                PATH_START = null;
                document.getElementById("tb-pth").classList.remove("active");
              }
              return;
            }
            if (ev.shiftKey || ev.ctrlKey || ev.metaKey) {
              ST.sel.has(d.id) ? ST.sel.delete(d.id) : ST.sel.add(d.id);
              applySelVis();
              badge();
              if (ST.sel.size === 1) {
                const s = ND.find((n) => ST.sel.has(n.id));
                if (s) focusNode(s);
              } else if (ST.sel.size === 0) {
                document.getElementById("nd").style.display = "none";
                document.getElementById("md").style.display = "none";
              } else showMulti();
              if (ST.isolate) rebuild();
            } else {
              ST.sel.clear();
              ST.sel.add(d.id);
              applySelVis();
              badge();
              focusNode(d);
              if (ST.isolate) rebuild();
            }
          })
          .on("dblclick", (ev, d) => {
            ev.stopPropagation();
            if (ST.mode !== "select") return;
            ST.pinned.has(d.id) ? ST.pinned.delete(d.id) : ST.pinned.add(d.id);
            applyPinVis();
            if (ST.pinned.has(d.id)) showEgo(d.id);
            else {
              clearPathHL();
              refreshVis();
            }
          })
          .on("mouseover", (ev, d) => {
            if (ST.mode !== "lasso") showTT(ev, d);
          })
          .on("mousemove", (ev) => moveTT(ev))
          .on("mouseout", () => hideTT());
        Ns = ng;
        ng.append("circle")
          .attr("r", (d) => _szSc(d[sz] || 0))
          .attr("fill", (d) => _getColorFn(d))
          .attr("stroke", "rgba(255,255,255,.1)")
          .attr("stroke-width", 0.7)
          .attr("filter", (d) => ((d[sz] || 0) > q85 ? "url(#gf)" : null));
        Ls = ng
          .append("text")
          .attr("class", (d) => lblCls(d))
          .attr("dy", (d) => _szSc(d[sz] || 0) + 8)
          .text((d) => d.label || d.id.split("@")[0]);

        _sphCx = W / 2;
        _sphCy = H / 2;
        _sphR = (Math.min(W, H) * opts.dist) / 100;
        setupSphereDrag(svg);
        drawSphere();
        applyMode();
        renderTopList();
      }

      /* ‚îÄ‚îÄ COLOR FUNCTION BY MODE ‚îÄ‚îÄ */
      function makeColorFn(nodes) {
        if (ST.colorMode === "community") return (n) => cc(n.community);
        if (ST.colorMode === "role") return (n) => rc(n.inferred_role);
        if (ST.colorMode === "power") return (n) => piColor(n.power_index || 0);
        const mx = d3.max(nodes.map((x) => x[ST.opts.col] || 0)) || 1;
        return (n) => d3.interpolatePlasma((n[ST.opts.col] || 0) / mx);
      }

      /* ‚îÄ‚îÄ SPHERE DRAG ‚îÄ‚îÄ */
      function setupSphereDrag(svg) {
        svg.on("mousedown.sph", function (ev) {
          if (ST.mode === "lasso") return;
          if (ev.target.tagName === "INPUT" || ev.target.tagName === "BUTTON")
            return;
          _dragX0 = ev.clientX;
          _dragY0 = ev.clientY;
          stopAutoSpin();
          ST._dragging = false;
          let _mv = 0;
          const onMove = (e) => {
            const dx = e.clientX - _dragX0,
              dy = e.clientY - _dragY0;
            _dragX0 = e.clientX;
            _dragY0 = e.clientY;
            _mv += Math.hypot(dx, dy);
            if (_mv > 3) ST._dragging = true;
            const ang = Math.hypot(dx, dy) * 0.006;
            if (ang < 0.0001) return;
            const ax = n3([dy, -dx, 0]);
            SPHERE_ROT = matMul(rotAA(ax[0], ax[1], ax[2], ang), SPHERE_ROT);
            drawSphere();
          };
          const onUp = () => {
            window.removeEventListener("mousemove", onMove);
            window.removeEventListener("mouseup", onUp);
            setTimeout(() => (ST._dragging = false), 150);
          };
          window.addEventListener("mousemove", onMove);
          window.addEventListener("mouseup", onUp);
          ev.preventDefault();
        });
      }

      /* ‚îÄ‚îÄ SPIN ‚îÄ‚îÄ */
      function startAutoSpin() {
        _autoSpin = true;
        isRunning = true;
        function frame() {
          if (!_autoSpin) {
            _raf = null;
            return;
          }
          SPHERE_ROT = matMul(rotAA(0, 1, 0, _spinSpeed), SPHERE_ROT);
          drawSphere();
          _raf = requestAnimationFrame(frame);
        }
        if (!_raf) _raf = requestAnimationFrame(frame);
      }
      function stopAutoSpin() {
        _autoSpin = false;
        isRunning = false;
        if (_raf) {
          cancelAnimationFrame(_raf);
          _raf = null;
        }
      }

      /* ‚îÄ‚îÄ DRAW SPHERE ‚îÄ‚îÄ */
      function drawSphere() {
        if (!ND.length || !Ns) return;
        const sz = ST.opts.sz;
        ND.forEach((n) => {
          const [rx, ry, rz] = matVec(SPHERE_ROT, [
            n._sx * _sphR,
            n._sy * _sphR,
            n._sz * _sphR,
          ]);
          const fov = _sphR * 2.2,
            ps = fov / (fov + rz);
          n._px = _sphCx + rx * ps;
          n._py = _sphCy + ry * ps;
          n._pz = rz;
          n._ps = ps;
        });
        Ns.sort((a, b) => a._pz - b._pz)
          .attr("transform", (d) => `translate(${d._px},${d._py})`)
          .attr("pointer-events", (d) =>
            d._pz > -_sphR * 0.95 ? "all" : "none",
          );
        Ns.select("circle")
          .attr("r", (d) =>
            Math.max(1.5, _szSc(d[sz] || 0) * (0.55 + 0.45 * d._ps)),
          )
          .style("opacity", (d) => {
            if (PATH_HL.nodes.size > 0)
              return PATH_HL.nodes.has(d.id) ? 1 : 0.08;
            if (ST.sel.size > 0 && !ST.isolate)
              return ST.sel.has(d.id) ? 1 : 0.12;
            return Math.max(0.07, 0.25 + 0.75 * ((d._pz / _sphR + 1) / 2));
          });
        if (Ls)
          Ls.style("opacity", (d) => {
            if (PATH_HL.nodes.size > 0) return PATH_HL.nodes.has(d.id) ? 1 : 0;
            if (ST.sel.size > 0 && !ST.isolate) return ST.sel.has(d.id) ? 1 : 0;
            return d._pz > 0 ? 1 : 0;
          });
        if (Es)
          Es.attr("x1", (d) => d._src._px)
            .attr("y1", (d) => d._src._py)
            .attr("x2", (d) => d._tgt._px)
            .attr("y2", (d) => d._tgt._py)
            .style("opacity", (d) => {
              if (PATH_HL.edges.size > 0) {
                const s = d.source?.id ?? d.source,
                  t = d.target?.id ?? d.target;
                return PATH_HL.edges.has(s + "|" + t) ? 0.95 : 0.03;
              }
              if (ST.sel.size > 0 && !ST.isolate) {
                const s = d.source?.id ?? d.source,
                  t = d.target?.id ?? d.target;
                if (ST.sel.has(s) || ST.sel.has(t)) return 0.85;
                return 0.04;
              }
              const mz = Math.min(d._src._pz, d._tgt._pz);
              return Math.max(0.03, 0.12 + 0.45 * ((mz / _sphR + 1) / 2));
            });
      }

      /* ‚îÄ‚îÄ PATH ‚îÄ‚îÄ */
      let PATH_START = null;
      let PATH_HL = { nodes: new Set(), edges: new Set() };
      let PATH_FROM_ID = null,
        PATH_TO_ID = null;
      function showPathBadge(html) {
        const el = document.getElementById("spath");
        el.innerHTML = html;
        el.style.display = "block";
      }
      function buildAdj() {
        const adj = new Map();
        ND.forEach((n) => adj.set(n.id, new Set()));
        (ED || []).forEach((e) => {
          const s = e.source?.id ?? e.source,
            t = e.target?.id ?? e.target;
          if (adj.has(s) && adj.has(t)) {
            adj.get(s).add(t);
            adj.get(t).add(s);
          }
        });
        return adj;
      }
      function shortestPath(a, b) {
        const adj = buildAdj();
        if (!adj.has(a) || !adj.has(b)) return null;
        const q = [a],
          prev = new Map();
        prev.set(a, null);
        while (q.length) {
          const u = q.shift();
          if (u === b) break;
          for (const v of adj.get(u) || [])
            if (!prev.has(v)) {
              prev.set(v, u);
              q.push(v);
            }
        }
        if (!prev.has(b)) return null;
        const path = [];
        let cur = b;
        while (cur != null) {
          path.push(cur);
          cur = prev.get(cur);
        }
        path.reverse();
        return path;
      }
      function showPathBetween(a, b) {
        clearPathHL();
        if (a === b) return;
        const p = shortestPath(a, b);
        if (!p) {
          showPathBadge(
            `<span style="color:var(--c2)">‚úï No path found:</span> <span style="color:var(--muted2);font-size:8px">${a.split("@")[0]} ‚Üí ${b.split("@")[0]}</span>`,
          );
          setTimeout(
            () => (document.getElementById("spath").style.display = "none"),
            4000,
          );
          return;
        }
        PATH_HL.nodes = new Set(p);
        const pek = new Set();
        for (let i = 0; i < p.length - 1; i++) {
          pek.add(p[i] + "|" + p[i + 1]);
          pek.add(p[i + 1] + "|" + p[i]);
        }
        PATH_HL.edges = pek;
        if (Ns) Ns.classed("selected", (d) => PATH_HL.nodes.has(d.id));
        if (Es)
          Es.classed("hi", (e) => {
            const s = e.source?.id ?? e.source,
              t = e.target?.id ?? e.target;
            return pek.has(s + "|" + t);
          }).classed("dim", (e) => {
            const s = e.source?.id ?? e.source,
              t = e.target?.id ?? e.target;
            return !pek.has(s + "|" + t);
          });
        const pn = p.map((id) => id.split("@")[0]);
        const hops = p.length - 1;
        showPathBadge(
          `<div style="margin-bottom:4px"><span style="color:var(--c1);font-weight:700">${pn[0]}</span> <span style="color:var(--muted2)">‚Üí</span> <span style="color:var(--c2);font-weight:700">${pn[pn.length - 1]}</span> <span style="color:var(--muted2);font-size:8px">(${hops} hop${hops !== 1 ? "s" : ""})</span></div><div style="color:var(--text);font-size:8px;line-height:1.6">${pn.join(' <span style="color:var(--c3)">‚Üí</span> ')}</div><div style="margin-top:4px"><span id="bcp" style="text-decoration:underline;cursor:pointer;color:var(--muted2);font-size:8px">[clear]</span></div>`,
        );
        const b2 = document.getElementById("bcp");
        if (b2)
          b2.onclick = (e) => {
            e.stopPropagation();
            clearPathHL();
            document.getElementById("spath").style.display = "none";
          };
        drawSphere();
      }
      function clearPathHL() {
        PATH_HL.nodes = new Set();
        PATH_HL.edges = new Set();
        if (Ns) {
          Ns.classed("selected", (d) => ST.sel.has(d.id));
          Ns.select("circle").style("opacity", null);
        }
        if (Es) {
          Es.classed("hi", false).classed("dim", false);
          Es.style("opacity", null);
        }
        drawSphere();
      }
      function showEgo(nodeId) {
        const adj = buildAdj(),
          neigh = adj.get(nodeId) || new Set();
        if (Ns)
          Ns.select("circle").style("opacity", (d) =>
            d.id === nodeId || neigh.has(d.id) ? 1 : 0.07,
          );
        if (Es)
          Es.style("opacity", (e) => {
            const s = e.source?.id ?? e.source,
              t = e.target?.id ?? e.target;
            return s === nodeId ||
              t === nodeId ||
              (neigh.has(s) && neigh.has(t))
              ? 0.9
              : 0.04;
          });
      }

      /* ‚îÄ‚îÄ REFRESH VISUALS ‚îÄ‚îÄ */
      function refreshVis() {
        if (!Ns || !ND.length) {
          rebuild();
          return;
        }
        const sz = ST.opts.sz;
        const sv = ND.map((n) => n[sz] || 0);
        _szSc = d3
          .scaleSqrt()
          .domain([0, d3.max(sv) || 1])
          .range([3, 20]);
        q85 = d3.quantile(sv.slice().sort(d3.ascending), 0.85) || 0;
        _getColorFn = makeColorFn(ND);
        Ns.select("circle")
          .attr("fill", (d) => _getColorFn(d))
          .attr("filter", (d) => ((d[sz] || 0) > q85 ? "url(#gf)" : null));
        if (Ls)
          Ls.attr("dy", (d) => _szSc(d[sz] || 0) + 8).attr("class", (d) =>
            lblCls(d),
          );
        drawSphere();
      }

      /* ‚îÄ‚îÄ MODE ‚îÄ‚îÄ */
      function applyMode() {
        const svg = d3.select("#nsv");
        svg.style("cursor", ST.mode === "lasso" ? "crosshair" : "grab");
        document
          .getElementById("tb-sel")
          .classList.toggle("active", ST.mode === "select");
        document
          .getElementById("tb-las")
          .classList.toggle("active", ST.mode === "lasso");
        document
          .getElementById("tb-las")
          .classList.toggle("lasso-on", ST.mode === "lasso");
        document
          .getElementById("tb-pan")
          .classList.toggle("active", ST.mode === "pan");
        if (ST.mode === "lasso") setupLasso(svg);
        else {
          svg
            .on("mousedown.lasso", null)
            .on("mousemove.lasso", null)
            .on("mouseup.lasso", null);
          d3.select("#lbox").attr("display", "none");
        }
      }

      /* ‚îÄ‚îÄ LASSO ‚îÄ‚îÄ */
      function setupLasso(svg) {
        svg.on("mousedown.zoom", null);
        const lb = d3.select("#lbox");
        let x0,
          y0,
          active = false;
        svg.on("mousedown.lasso", function (ev) {
          const tgt = ev.target;
          if (tgt.closest && tgt.closest(".ng")) return;
          [x0, y0] = d3.pointer(ev, this);
          lb.attr("x", x0)
            .attr("y", y0)
            .attr("width", 0)
            .attr("height", 0)
            .attr("display", null);
          active = true;
          ev.preventDefault();
          ev.stopImmediatePropagation();
        });
        svg.on("mousemove.lasso", function (ev) {
          if (!active) return;
          const [mx, my] = d3.pointer(ev, this);
          lb.attr("x", Math.min(mx, x0))
            .attr("y", Math.min(my, y0))
            .attr("width", Math.abs(mx - x0))
            .attr("height", Math.abs(my - y0));
        });
        svg.on("mouseup.lasso", function (ev) {
          if (!active) return;
          active = false;
          lb.attr("display", "none");
          const [mx, my] = d3.pointer(ev, this);
          const rx = Math.min(mx, x0),
            ry = Math.min(my, y0),
            rw = Math.abs(mx - x0),
            rh = Math.abs(my - y0);
          if (rw < 5 && rh < 5) return;
          if (!ev.shiftKey) ST.sel.clear();
          ND.forEach((d) => {
            if (
              (d._px || 0) >= rx &&
              (d._px || 0) <= rx + rw &&
              (d._py || 0) >= ry &&
              (d._py || 0) <= ry + rh
            )
              ST.sel.add(d.id);
          });
          applySelVis();
          badge();
          if (ST.sel.size === 1) {
            const s = ND.find((n) => ST.sel.has(n.id));
            if (s) focusNode(s);
          } else showMulti();
        });
      }

      /* ‚îÄ‚îÄ SELECTION ‚îÄ‚îÄ */
      function applySelVis() {
        if (!Ns) return;
        Ns.classed("selected", (d) => ST.sel.has(d.id));
        Ns.select("circle").style("opacity", null);
        if (Es) {
          Es.classed("hi", false).classed("dim", false);
          Es.style("opacity", null);
        }
        drawSphere();
      }
      function applyPinVis() {
        if (Ns) Ns.classed("pinned", (d) => ST.pinned.has(d.id));
      }
      function clearSel() {
        const wasIso = ST.isolate;
        ST.sel.clear();
        ST.isolate = false;
        clearPathHL();
        applySelVis();
        badge();
        document.getElementById("nd").style.display = "none";
        document.getElementById("md").style.display = "none";
        document
          .querySelectorAll(".nli")
          .forEach((e) => e.classList.remove("active"));
        if (wasIso) rebuild();
      }
      function badge() {
        const el = document.getElementById("spath"),
          n = ST.sel.size;
        if (PATH_HL.nodes.size > 0) return;
        el.style.display = n ? "block" : "none";
        if (n) {
          const isoLbl = ST.isolate ? "Show All" : "Only Selected";
          el.innerHTML = `<span style="color:var(--c3)">${n} node${n > 1 ? "s" : ""} selected</span> <span id="biq" style="margin-left:8px;text-decoration:underline;cursor:pointer;color:var(--c1);font-size:8px">[${isoLbl}]</span> <span id="bcq" style="margin-left:4px;text-decoration:underline;cursor:pointer;color:var(--c2);font-size:8px">[‚úï clear]</span>`;
          document.getElementById("biq").onclick = (e) => {
            e.stopPropagation();
            ST.isolate = !ST.isolate;
            rebuild();
            badge();
          };
          document.getElementById("bcq").onclick = (e) => {
            e.stopPropagation();
            clearSel();
          };
        }
      }

      /* ‚îÄ‚îÄ LABELS ‚îÄ‚îÄ */
      function lblCls(d) {
        const top = !ST.topOnly || (d[ST.opts.sz] || 0) >= q85;
        return "nlbl" + (ST.showLabels && top ? "" : " h");
      }
      function applyLabels() {
        if (Ls) Ls.attr("class", (d) => lblCls(d));
      }

      /* ‚îÄ‚îÄ TOOLTIP ‚îÄ‚îÄ */
      function showTT(ev, d) {
        const tt = document.getElementById("ttp");
        tt.style.display = "block";
        const dp = ENODE[d.id] || {};
        const pi = dp.overall_power_index || d.power_level_heuristic * 10 || 0;
        const piC = piColor(pi);
        const frb = dp.french_and_raven_bases || {};
        tt.innerHTML = `<div class="tn">${d.id}</div><div class="tr">${dp.inferred_informal_role || d.inferred_role || "‚Äî"}</div>
<div class="tpow"><div class="tpow-lbl">Power Index</div><div style="display:flex;align-items:center;gap:6px"><div class="tpow-bar" style="flex:1"><div class="tpow-fill" style="width:${pi}%;background:${piC}"></div></div><span style="font-family:var(--font-mono);font-size:10px;color:${piC};font-weight:700">${pi}</span></div></div>
<div class="trow"><span class="tk2">Community</span><span class="tv">${d.community ?? "‚Äî"}</span></div>
<div class="trow"><span class="tk2">PageRank</span><span class="tv">${(d.pagerank || 0).toFixed(5)}</span></div>
<div class="trow"><span class="tk2">Betweenness</span><span class="tv">${(d.betweenness || 0).toFixed(5)}</span></div>
<div class="trow"><span class="tk2">Sent/Recv</span><span class="tv">${(d.sent || 0).toLocaleString()} / ${(d.received || 0).toLocaleString()}</span></div>
${Object.keys(frb).length ? `<div style="margin-top:5px;font-size:7px;color:var(--muted2);text-transform:uppercase;letter-spacing:.1em;margin-bottom:3px">F&R Bases</div><div class="trow"><span class="tk2">Expert</span><span class="tv" style="color:#00d4ff">${frb.expert_power || 0}/10</span></div><div class="trow"><span class="tk2">Legitimate</span><span class="tv" style="color:#ffc13d">${frb.legitimate_power || 0}/10</span></div><div class="trow"><span class="tk2">Coercive</span><span class="tv" style="color:#ff3d5a">${frb.coercive_power || 0}/10</span></div>` : ""}
<div class="th">Click ¬∑ Shift+click multi ¬∑ Dbl-click pin</div>`;
        moveTT(ev);
      }
      function moveTT(ev) {
        const tt = document.getElementById("ttp"),
          r = document.getElementById("main").getBoundingClientRect();
        let x = ev.clientX - r.left + 14,
          y = ev.clientY - r.top - 12;
        if (x + 250 > r.width) x -= 262;
        if (y + 320 > r.height) y = r.height - 325;
        tt.style.left = x + "px";
        tt.style.top = y + "px";
      }
      function hideTT() {
        document.getElementById("ttp").style.display = "none";
      }

      /* ‚îÄ‚îÄ FOCUS NODE ‚îÄ‚îÄ */
      function focusNode(d) {
        switchTab("sl");
        document.getElementById("nd").style.display = "block";
        document.getElementById("md").style.display = "none";
        document
          .querySelectorAll(".nli")
          .forEach((e) => e.classList.remove("active"));
        const li = document.getElementById("nli-" + d.id);
        if (li) {
          li.classList.add("active");
          li.scrollIntoView({ block: "nearest" });
        }

        const dp = ENODE[d.id] || {};
        const pi = dp.overall_power_index || d.power_level_heuristic * 10 || 0;
        const piC = piColor(pi);
        const frb = dp.french_and_raven_bases || {};
        const style = dp.communication_style || "‚Äî";
        const infRole = dp.inferred_informal_role || d.inferred_role || "‚Äî";

        document.getElementById("dd-name").textContent = d.id;
        document.getElementById("dd-role").textContent =
          infRole + " ¬∑ " + style;
        document.getElementById("dd-pi").textContent = pi;
        document.getElementById("dd-pi").style.color = piC;
        document.getElementById("dd-pibar").style.width = pi + "%";

        // Metrics grid
        const mets = [
          { l: "PageRank", v: (d.pagerank || 0).toFixed(5) },
          { l: "Betweenness", v: (d.betweenness || 0).toFixed(5) },
          { l: "Eigenvector", v: (d.eigenvector || 0).toFixed(5) },
          { l: "Clustering", v: (d.clustering || 0).toFixed(4) },
          { l: "Sent", v: (d.sent || 0).toLocaleString() },
          { l: "Received", v: (d.received || 0).toLocaleString() },
          { l: "Contacts", v: d.unique_contacts || 0 },
          {
            l: "Out/In Ratio",
            v: (d.out_in_ratio || d.stats?.out_in_ratio || 0).toFixed(2),
          },
        ];
        document.getElementById("dd-met").innerHTML = mets
          .map(
            (m) =>
              `<div class="mc"><div class="mv">${m.v}</div><div class="ml">${m.l}</div></div>`,
          )
          .join("");

        // French & Raven power bars
        if (Object.keys(frb).length) {
          const frbEl = document.getElementById("dd-frb");
          const frDef = [
            { key: "expert_power", lbl: "Expert", col: "#00d4ff" },
            { key: "referent_power", lbl: "Referent", col: "#3dff9a" },
            { key: "legitimate_power", lbl: "Legitimate", col: "#ffc13d" },
            { key: "coercive_power", lbl: "Coercive", col: "#ff3d5a" },
          ];
          frbEl.innerHTML =
            `<div style="font-size:8px;color:var(--c3);text-transform:uppercase;letter-spacing:.12em;margin-bottom:6px;font-weight:600">French &amp; Raven Power Bases</div>` +
            frDef
              .map(
                (f) =>
                  `<div class="fr-row"><span class="fr-lbl" style="color:${f.col}">${f.lbl}</span><div class="fr-bar"><div class="fr-fill" style="width:${(frb[f.key] || 0) * 10}%;background:${f.col}88"></div></div><span class="fr-val">${frb[f.key] || 0}</span></div>`,
              )
              .join("");
        } else {
          document.getElementById("dd-frb").innerHTML = "";
        }

        // Evidence Quotes
        const quotes = dp.evidence_quotes || [];
        if (quotes.length) {
          document.getElementById("dd-eq").style.display = "block";
          document.getElementById("dd-quotes").innerHTML = quotes
            .map((q) => `<div class="eq-item">${q}</div>`)
            .join("");
        } else {
          document.getElementById("dd-eq").style.display = "none";
        }

        // LLM Analysis
        if (dp.comprehensive_analysis) {
          document.getElementById("dd-an").style.display = "block";
          document.getElementById("dd-analysis").textContent =
            dp.comprehensive_analysis;
        } else {
          document.getElementById("dd-an").style.display = "none";
        }

        // Neighbours
        const nbrs = ED.filter((e) => {
          const s = e.source.id != null ? e.source.id : e.source,
            t = e.target.id != null ? e.target.id : e.target;
          return s === d.id || t === d.id;
        })
          .map((e) => {
            const s = e.source.id != null ? e.source.id : e.source,
              t = e.target.id != null ? e.target.id : e.target;
            return { other: s === d.id ? t : s, weight: e.weight || 0 };
          })
          .sort((a, b) => b.weight - a.weight)
          .slice(0, 15);
        document.getElementById("dd-nbr").innerHTML = nbrs
          .map(
            (n) =>
              `<div class="nitem" data-id="${n.other}"><span>${n.other.split("@")[0]}</span><span style="color:var(--muted2)">${n.weight.toFixed(1)}</span></div>`,
          )
          .join("");
        document
          .getElementById("dd-nbr")
          .querySelectorAll(".nitem")
          .forEach((el) =>
            el.addEventListener("click", () => focusById(el.dataset.id)),
          );
      }
      function focusById(id) {
        const d = ND.find((n) => n.id === id);
        if (!d) return;
        ST.sel.clear();
        ST.sel.add(id);
        applySelVis();
        badge();
        focusNode(d);
        panTo(d);
      }
      function panTo(d) {
        if (d._sx == null) return;
        const cur = n3(matVec(SPHERE_ROT, [d._sx, d._sy, d._sz]));
        const cosA = Math.min(1, Math.max(-1, cur[2]));
        const angle = Math.acos(cosA);
        if (angle < 0.01) return;
        let ax = cross3(cur, [0, 0, 1]);
        if (Math.hypot(ax[0], ax[1], ax[2]) < 0.001) ax = [1, 0, 0];
        ax = n3(ax);
        const steps = 30;
        let step = 0;
        const pr = rotAA(ax[0], ax[1], ax[2], angle / steps);
        function frame() {
          if (step++ >= steps) return;
          SPHERE_ROT = matMul(pr, SPHERE_ROT);
          drawSphere();
          requestAnimationFrame(frame);
        }
        frame();
      }

      /* ‚îÄ‚îÄ MULTI ‚îÄ‚îÄ */
      function showMulti() {
        const n = ST.sel.size;
        if (n < 2) {
          document.getElementById("md").style.display = "none";
          return;
        }
        switchTab("sl");
        document.getElementById("nd").style.display = "none";
        document.getElementById("md").style.display = "block";
        document.getElementById("md-t").textContent = `${n} nodes selected`;
        const sel = ND.filter((d) => ST.sel.has(d.id)),
          avg = (k) =>
            sel.length
              ? (sel.reduce((s, d) => s + (d[k] || 0), 0) / sel.length).toFixed(
                  4,
                )
              : "‚Äî",
          sum = (k) =>
            sel.reduce((s, d) => s + (d[k] || 0), 0).toLocaleString();
        const avgPi = sel.length
          ? (
              sel.reduce((s, d) => s + (d.power_index || 0), 0) / sel.length
            ).toFixed(1)
          : "‚Äî";
        document.getElementById("md-m").innerHTML = [
          { l: "Avg PageRank", v: avg("pagerank") },
          { l: "Avg Betweenness", v: avg("betweenness") },
          { l: "Avg Power Index", v: avgPi },
          { l: "Total Sent", v: sum("sent") },
        ]
          .map(
            (m) =>
              `<div class="mc"><div class="mv" style="font-size:11px">${m.v}</div><div class="ml">${m.l}</div></div>`,
          )
          .join("");
        const bfs = document.getElementById("bfs");
        if (bfs)
          bfs.textContent = ST.isolate ? "‚ä° Show All Nodes" : "‚ä† Only Selected";
      }

      /* ‚îÄ‚îÄ TAB SWITCH ‚îÄ‚îÄ */
      function switchTab(which) {
        ["ov", "an", "sl"].forEach((t) => {
          document
            .getElementById("rt-" + t)
            .classList.toggle("active", t === which);
          document.getElementById("tab-" + t).style.display =
            t === which ? "block" : "none";
        });
      }

      /* ‚îÄ‚îÄ FIT ‚îÄ‚îÄ */
      function fitGraph() {
        if (!ND.length) return;
        SPHERE_ROT = [
          [1, 0, 0],
          [0, 1, 0],
          [0, 0, 1],
        ];
        const svg = d3.select("#nsv");
        const W = svg.node().clientWidth,
          H = svg.node().clientHeight;
        _sphCx = W / 2;
        _sphCy = H / 2;
        _sphR = (Math.min(W, H) * ST.opts.dist) / 100;
        drawSphere();
      }

      /* ‚îÄ‚îÄ EGO ‚îÄ‚îÄ */
      function toggleEgo() {
        if (ST.egoNode) {
          ST.egoNode = null;
          document.getElementById("tb-ego").classList.remove("active");
          rebuild();
          return;
        }
        if (ST.sel.size !== 1) {
          showPathBadge(
            '<span style="color:var(--c4)">Select exactly 1 node, then press E for ego view</span>',
          );
          setTimeout(() => {
            if (!ST.sel.size)
              document.getElementById("spath").style.display = "none";
          }, 2500);
          return;
        }
        const egoId = [...ST.sel][0];
        ST.egoNode = egoId;
        document.getElementById("tb-ego").classList.add("active");
        rebuild();
        // Show ego badge
        const en = RAW.graph_data?.nodes?.find((n) => n.id === egoId);
        if (!en) return;
        const neighbors = new Set();
        (RAW.graph_data?.edges || []).forEach((e) => {
          const s = e.source?.id ?? e.source,
            t = e.target?.id ?? e.target;
          if (s === egoId) neighbors.add(t);
          if (t === egoId) neighbors.add(s);
        });
        document.getElementById("spath").innerHTML =
          `<span style="color:var(--c1)">üë§ Ego: ${en.label || egoId.split("@")[0]}</span> <span style="color:var(--muted2);font-size:8px">¬∑ Direct neighbors: <b style="color:var(--text)">${neighbors.size}</b></span> <span id="bex" style="margin-left:8px;text-decoration:underline;cursor:pointer;color:var(--c2);font-size:8px">[‚úï Exit Ego]</span>`;
        document.getElementById("spath").style.display = "block";
        const bex = document.getElementById("bex");
        if (bex)
          bex.onclick = (e) => {
            e.stopPropagation();
            toggleEgo();
          };
      }

      /* ‚îÄ‚îÄ EXPORTS ‚îÄ‚îÄ */
      function exportPNG() {
        const so = document.getElementById("nsv");
        const svgEl = so.cloneNode(true);
        svgEl.setAttribute("width", so.clientWidth);
        svgEl.setAttribute("height", so.clientHeight);
        const styles = Array.from(document.styleSheets)
          .flatMap((s) => {
            try {
              return Array.from(s.cssRules);
            } catch {
              return [];
            }
          })
          .map((r) => r.cssText)
          .join("\n");
        const styleEl = document.createElement("style");
        styleEl.textContent = styles;
        svgEl.prepend(styleEl);
        const s = new XMLSerializer().serializeToString(svgEl),
          c = document.createElement("canvas");
        c.width = so.clientWidth * 2;
        c.height = so.clientHeight * 2;
        const ctx = c.getContext("2d");
        ctx.fillStyle = "#06080f";
        ctx.fillRect(0, 0, c.width, c.height);
        const img = new Image();
        img.onload = () => {
          ctx.drawImage(img, 0, 0, c.width, c.height);
          const a = document.createElement("a");
          a.download = `enron-sna-${Date.now()}.png`;
          a.href = c.toDataURL("image/png");
          a.click();
        };
        img.src =
          "data:image/svg+xml;base64," + btoa(unescape(encodeURIComponent(s)));
      }
      function exportJSON() {
        const blob = new Blob(
          [JSON.stringify({ nodes: ND, edges: ED }, null, 2)],
          { type: "application/json" },
        );
        const a = document.createElement("a");
        a.download = "enron-sna-export.json";
        a.href = URL.createObjectURL(blob);
        a.click();
        URL.revokeObjectURL(a.href);
      }

      /* ‚îÄ‚îÄ SEARCH ‚îÄ‚îÄ */
      function setupSearch() {
        const findId = (raw) => {
          const q = (raw || "").trim().toLowerCase();
          if (!q) return null;
          const e = ND.find(
            (n) =>
              n.id.toLowerCase() === q ||
              (n.label || "").toLowerCase() === q ||
              n.id.split("@")[0].toLowerCase() === q,
          );
          if (e) return e.id;
          const f = ND.find(
            (n) =>
              n.id.toLowerCase().includes(q) ||
              (n.label || "").toLowerCase().includes(q),
          );
          return f ? f.id : null;
        };
        const attachSearch = (inp, res, onPick) => {
          inp.addEventListener("input", () => {
            const q = inp.value.trim().toLowerCase();
            if (!q) {
              res.style.display = "none";
              return;
            }
            const hits = ND.filter(
              (n) =>
                n.id.toLowerCase().includes(q) ||
                (n.label || "").toLowerCase().includes(q),
            ).slice(0, 10);
            if (!hits.length) {
              res.style.display = "none";
              return;
            }
            res.style.display = "block";
            res.innerHTML = hits
              .map(
                (n) =>
                  `<div class="sri" data-id="${n.id}">${n.label || n.id.split("@")[0]}<span style="color:var(--muted);font-size:7px"> ${n.id}</span></div>`,
              )
              .join("");
            res.querySelectorAll(".sri").forEach((el) =>
              el.addEventListener("click", () => {
                onPick(
                  el.dataset.id,
                  ND.find((n) => n.id === el.dataset.id),
                );
                res.style.display = "none";
              }),
            );
          });
        };
        const inp = document.getElementById("nsrch"),
          res = document.getElementById("nsr");
        attachSearch(inp, res, (id) => {
          focusById(id);
          inp.value = "";
        });
        const pf = document.getElementById("pf"),
          pfr = document.getElementById("pfr"),
          pt2 = document.getElementById("pt2"),
          ptr = document.getElementById("ptr");
        attachSearch(pf, pfr, (id, n) => {
          PATH_FROM_ID = id;
          pf.value = n?.label || id.split("@")[0];
        });
        attachSearch(pt2, ptr, (id, n) => {
          PATH_TO_ID = id;
          pt2.value = n?.label || id.split("@")[0];
        });
        const runPath = () => {
          const fid = PATH_FROM_ID || findId(pf.value),
            tid = PATH_TO_ID || findId(pt2.value);
          if (!fid || !tid) return;
          PATH_FROM_ID = fid;
          PATH_TO_ID = tid;
          showPathBetween(fid, tid);
        };
        pf.addEventListener("input", () => (PATH_FROM_ID = null));
        pt2.addEventListener("input", () => (PATH_TO_ID = null));
        pf.addEventListener("keydown", (e) => {
          if (e.key === "Enter") runPath();
        });
        pt2.addEventListener("keydown", (e) => {
          if (e.key === "Enter") runPath();
        });
        document.getElementById("bpf").addEventListener("click", runPath);
        document.getElementById("bpc").addEventListener("click", () => {
          PATH_FROM_ID = null;
          PATH_TO_ID = null;
          pf.value = "";
          pt2.value = "";
          clearPathHL();
          document.getElementById("spath").style.display = "none";
        });
        document.addEventListener("click", (e) => {
          if (!e.target.closest(".sw")) {
            res.style.display = "none";
            pfr.style.display = "none";
            ptr.style.display = "none";
          }
        });
      }

      /* ‚îÄ‚îÄ UPDATE LEGEND PANEL ‚îÄ‚îÄ */
      function updateLegendPanel() {
        const cm = ST.colorMode;
        document.getElementById("cp").style.display =
          cm === "community" ? "block" : "none";
        document.getElementById("rp").style.display =
          cm === "role" ? "block" : "none";
        document.getElementById("pp").style.display =
          cm === "power" ? "block" : "none";
      }

      /* ‚îÄ‚îÄ REBUILD ‚îÄ‚îÄ */
      const db = (fn, ms, k) => {
        clearTimeout(DT[k]);
        DT[k] = setTimeout(fn, ms);
      };
      function rebuild() {
        if (!RAW.graph_data) return;
        let data;
        if (ST.egoNode) {
          const eid = ST.egoNode,
            nb = new Set([eid]);
          (RAW.graph_data.edges || []).forEach((e) => {
            const s = e.source?.id ?? e.source,
              t = e.target?.id ?? e.target;
            if (s === eid) nb.add(t);
            if (t === eid) nb.add(s);
          });
          data = {
            nodes: RAW.graph_data.nodes.filter((n) => nb.has(n.id)),
            edges: RAW.graph_data.edges.filter((e) => {
              const s = e.source?.id ?? e.source,
                t = e.target?.id ?? e.target;
              return nb.has(s) && nb.has(t);
            }),
          };
        } else if (ST.isolate && ST.sel.size > 0) {
          data = {
            nodes: RAW.graph_data.nodes.filter((n) => ST.sel.has(n.id)),
            edges: RAW.graph_data.edges.filter((e) => {
              const s = e.source?.id ?? e.source,
                t = e.target?.id ?? e.target;
              return ST.sel.has(s) && ST.sel.has(t);
            }),
          };
        } else {
          data = RAW.graph_data;
        }
        buildNetwork(data, ST.opts);
        applySelVis();
        badge();
      }

      /* ‚îÄ‚îÄ CONTROLS ‚îÄ‚îÄ */
      function setupControls() {
        let _rw = null;
        document.getElementById("sw2").addEventListener("input", function () {
          const v = Math.pow(10, +this.value / 30) - 1;
          document.getElementById("wv").textContent =
            v < 1 ? v.toFixed(2) : v < 10 ? v.toFixed(1) : Math.round(v);
          ST.opts.minW = v;
          if (_rw) cancelAnimationFrame(_rw);
          _rw = requestAnimationFrame(() => {
            db(rebuild, 20, "w");
            _rw = null;
          });
        });
        document.getElementById("smn").addEventListener("input", function () {
          document.getElementById("mnv").textContent = this.value;
          ST.opts.maxN = +this.value;
          db(rebuild, 40, "n");
        });
        document.getElementById("sdr").addEventListener("input", function () {
          const v = +this.value;
          document.getElementById("drv").textContent = v;
          ST.opts.dist = v;
          if (ND.length) {
            const svg = d3.select("#nsv");
            _sphR =
              (Math.min(svg.node().clientWidth, svg.node().clientHeight) * v) /
              100;
            drawSphere();
          }
        });
        document.getElementById("ssp").addEventListener("input", function () {
          const v = +this.value;
          document.getElementById("spv").textContent = v;
          _spinSpeed = v * 0.001;
        });
        document.getElementById("ssz").addEventListener("change", (e) => {
          ST.opts.sz = e.target.value;
          refreshVis();
          renderTopList();
        });

        // View mode buttons (community / power / role)
        ["comm", "power", "role"].forEach((m) => {
          document.getElementById("vm-" + m).addEventListener("click", () => {
            ["comm", "power", "role"].forEach((x) =>
              document
                .getElementById("vm-" + x)
                .classList.toggle("active", x === m),
            );
            ST.colorMode = m === "comm" ? "community" : m;
            updateLegendPanel();
            refreshVis();
          });
        });

        document.getElementById("tl").addEventListener("change", (e) => {
          ST.showLabels = e.target.checked;
          document
            .getElementById("tb-lbl")
            .classList.toggle("active", ST.showLabels);
          applyLabels();
        });
        document.getElementById("ttl").addEventListener("change", (e) => {
          ST.topOnly = e.target.checked;
          applyLabels();
        });
        document.getElementById("tis").addEventListener("change", (e) => {
          ST.showIsolated = e.target.checked;
          rebuild();
        });
        document.getElementById("tew").addEventListener("change", (e) => {
          ST.edgeByW = e.target.checked;
          if (Es && ED.length) {
            const wv = ED.map((f) => f.weight || 1),
              wMin = Math.max(d3.min(wv) || 0.01, 0.01),
              wMax = d3.max(wv) || 1;
            const sc = d3
              .scaleLog()
              .domain([wMin, wMax])
              .range([0.35, 3])
              .clamp(true);
            Es.attr("stroke-width", (d) =>
              ST.edgeByW ? sc(d.weight || 1) : 0.6,
            );
          } else rebuild();
        });

        document.getElementById("bpl").addEventListener("click", () => {
          startAutoSpin();
          document.getElementById("bpl").classList.add("active");
          document.getElementById("bst").classList.remove("active");
        });
        document.getElementById("bst").addEventListener("click", () => {
          stopAutoSpin();
          document.getElementById("bst").classList.add("active");
          document.getElementById("bpl").classList.remove("active");
        });
        document.getElementById("brb").addEventListener("click", rebuild);
        document.getElementById("bft").addEventListener("click", fitGraph);
        document.getElementById("bup").addEventListener("click", () => {
          ST.pinned.clear();
          applyPinVis();
        });

        document.getElementById("tb-sel").addEventListener("click", () => {
          ST.mode = "select";
          applyMode();
        });
        document.getElementById("tb-las").addEventListener("click", () => {
          ST.mode = ST.mode === "lasso" ? "select" : "lasso";
          applyMode();
        });
        document.getElementById("tb-pan").addEventListener("click", () => {
          ST.mode = ST.mode === "pan" ? "select" : "pan";
          applyMode();
        });
        document.getElementById("tb-lbl").addEventListener("click", () => {
          ST.showLabels = !ST.showLabels;
          document.getElementById("tl").checked = ST.showLabels;
          document
            .getElementById("tb-lbl")
            .classList.toggle("active", ST.showLabels);
          applyLabels();
        });
        document.getElementById("tb-png").addEventListener("click", exportPNG);
        document.getElementById("tb-jsn").addEventListener("click", exportJSON);
        document
          .getElementById("tb-hlp")
          .addEventListener("click", () =>
            document.getElementById("kh").classList.toggle("v"),
          );
        document.getElementById("tb-ego").addEventListener("click", toggleEgo);
        document.getElementById("tb-pth").addEventListener("click", () => {
          const btn = document.getElementById("tb-pth");
          btn.classList.toggle("active");
          if (!btn.classList.contains("active")) {
            PATH_START = null;
            document.getElementById("spath").style.display = "none";
            clearPathHL();
          }
        });

        // Theme + sidebar collapse
        document
          .getElementById("bth")
          .addEventListener("click", () =>
            document.documentElement.classList.toggle("light"),
          );
        document.getElementById("bcl").addEventListener("click", () => {
          const app = document.getElementById("app"),
            sl = document.getElementById("sl"),
            btn = document.getElementById("bcl");
          sl.classList.toggle("collapsed");
          const c = sl.classList.contains("collapsed");
          btn.textContent = c ? ">" : "‚Äπ";
          const rc2 = document
            .getElementById("sr")
            .classList.contains("collapsed");
          app.classList.toggle("lc", c && !rc2);
          app.classList.toggle("bc", c && rc2);
          app.classList.remove("rc");
          if (!c && !rc2) {
            app.classList.remove("lc");
            app.classList.remove("bc");
          }
          setTimeout(() => handleResize(), 320);
        });
        document.getElementById("bcr").addEventListener("click", () => {
          const app = document.getElementById("app"),
            sr = document.getElementById("sr"),
            btn = document.getElementById("bcr");
          sr.classList.toggle("collapsed");
          const c = sr.classList.contains("collapsed");
          btn.textContent = c ? "<" : "‚Ä∫";
          const lc2 = document
            .getElementById("sl")
            .classList.contains("collapsed");
          app.classList.toggle("rc", c && !lc2);
          app.classList.toggle("bc", c && lc2);
          app.classList.remove("lc");
          if (!c && !lc2) {
            app.classList.remove("rc");
            app.classList.remove("bc");
          }
          setTimeout(() => handleResize(), 320);
        });

        // Right tabs
        ["ov", "an", "sl"].forEach((t) => {
          document
            .getElementById("rt-" + t)
            .addEventListener("click", () => switchTab(t));
        });

        // Multi panel
        document.getElementById("bcs").addEventListener("click", clearSel);
        document.getElementById("bfs").addEventListener("click", () => {
          if (ST.sel.size < 1) return;
          ST.isolate = !ST.isolate;
          rebuild();
          badge();
          const b = document.getElementById("bfs");
          if (b)
            b.textContent = ST.isolate ? "‚ä° Show All Nodes" : "‚ä† Only Selected";
        });

        startAutoSpin();
        document.getElementById("bpl").classList.add("active");
      }
      function handleResize() {
        const svg = d3.select("#nsv");
        if (!svg.node()) return;
        const W = svg.node().clientWidth,
          H = svg.node().clientHeight;
        _sphCx = W / 2;
        _sphCy = H / 2;
        _sphR = (Math.min(W, H) * ST.opts.dist) / 100;
        svg.select("#bg-hit").attr("width", W).attr("height", H);
        drawSphere();
      }
      window.addEventListener("resize", () => db(handleResize, 100, "rz"));

      /* ‚îÄ‚îÄ KEYBOARD ‚îÄ‚îÄ */
      document.addEventListener("keydown", (ev) => {
        if (ev.target.tagName === "INPUT") return;
        if (ev.key === "Escape") {
          if (ST.egoNode) {
            toggleEgo();
            return;
          }
          clearSel();
          ST.mode = "select";
          applyMode();
        }
        if (ev.key === "e" || ev.key === "E") toggleEgo();
        if (ev.key === "l" || ev.key === "L") {
          ST.mode = ST.mode === "lasso" ? "select" : "lasso";
          applyMode();
        }
        if (ev.key === "p" || ev.key === "P") {
          ST.mode = ST.mode === "pan" ? "select" : "pan";
          applyMode();
        }
        if (ev.key === "r" || ev.key === "R") rebuild();
        if (ev.key === "f" || ev.key === "F") fitGraph();
        if (ev.key === "h" || ev.key === "H") {
          ST.showLabels = !ST.showLabels;
          document.getElementById("tl").checked = ST.showLabels;
          document
            .getElementById("tb-lbl")
            .classList.toggle("active", ST.showLabels);
          applyLabels();
        }
        if (ev.key === "?") document.getElementById("kh").classList.toggle("v");
      });

      /* ‚îÄ‚îÄ BOOTSTRAP ‚îÄ‚îÄ */
      (async () => {
        await loadAll();
        setLoad("Rendering panels‚Ä¶", 86);
        await pause(20);
        if (RAW.stats && Object.keys(RAW.stats).length) renderStats(RAW.stats);
        renderCommLegend(RAW.communities);
        renderRoleLegend();
        renderPowerLegend();
        renderTopList();
        renderCloud(RAW.keywords);
        renderCommChart(RAW.communities);
        renderPowerChart();
        renderTimelineChart(RAW.timeline);
        renderDegDistChart(RAW.degree_dist);
        renderPowerTierBreakdown();
        renderCommStats(RAW.communities);
        setLoad("Building sphere‚Ä¶", 93);
        await pause(20);
        buildNetwork(RAW.graph_data, ST.opts);
        setupControls();
        setupSearch();
        updateLegendPanel();
        setLoad("Done", 100);
        await pause(200);
        hideLd();
      })();
    </script>
  </body>
</html>
